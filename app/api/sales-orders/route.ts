/**
 * ğŸ”’ API Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø¨ÙŠØ¹ Ù…Ø¹ Ø§Ù„Ø­ÙˆÙƒÙ…Ø© Ø§Ù„Ø¥Ù„Ø²Ø§Ù…ÙŠØ© - Ø¥ØµØ¯Ø§Ø± Ù…Ø¨Ø³Ø·
 * 
 * GET /api/sales-orders - Ø¬Ù„Ø¨ Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø¨ÙŠØ¹ Ù…Ø¹ ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø­ÙˆÙƒÙ…Ø© Ø§Ù„Ø¥Ù„Ø²Ø§Ù…ÙŠØ©
 * POST /api/sales-orders - Ø¥Ù†Ø´Ø§Ø¡ Ø£Ù…Ø± Ø¨ÙŠØ¹ Ø¬Ø¯ÙŠØ¯ Ù…Ø¹ Ø§Ù„Ø­ÙˆÙƒÙ…Ø© Ø§Ù„Ø¥Ù„Ø²Ø§Ù…ÙŠØ©
 */

import { NextRequest, NextResponse } from "next/server"
import { createClient } from "@/lib/supabase/server"
import { getActiveCompanyId } from "@/lib/company"
import { getAccessFilter, getRoleAccessLevel } from "@/lib/validation"

/**
 * GET /api/sales-orders
 * Ø¬Ù„Ø¨ Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø¨ÙŠØ¹ Ù…Ø¹ ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø­ÙˆÙƒÙ…Ø© Ø§Ù„Ø¥Ù„Ø²Ø§Ù…ÙŠØ©
 */
export async function GET(request: NextRequest) {
  try {
    const supabase = await createClient()
    
    // 1ï¸âƒ£ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©
    const { data: { user }, error: authError } = await supabase.auth.getUser()
    if (authError || !user) {
      return NextResponse.json({ error: "Unauthorized", error_ar: "ØºÙŠØ± Ù…ØµØ±Ø­" }, { status: 401 })
    }

    // 2ï¸âƒ£ Ø¬Ù„Ø¨ Ø§Ù„Ø´Ø±ÙƒØ© Ø§Ù„Ù†Ø´Ø·Ø©
    const companyId = await getActiveCompanyId(supabase)
    if (!companyId) {
      return NextResponse.json({ error: "No company found", error_ar: "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø´Ø±ÙƒØ©" }, { status: 400 })
    }

    // 3ï¸âƒ£ Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø¨ÙŠØ¹ Ø¨Ø¯ÙˆÙ† ÙÙ„Ø§ØªØ± Ø­ÙˆÙƒÙ…Ø© (Ù…Ø¤Ù‚ØªØ§Ù‹ Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±)
    let query = supabase
      .from("sales_orders")
      .select(`
        *,
        customers:customer_id (id, name, phone, city)
      `)
      .eq("company_id", companyId)

    // ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ®
    query = query.order("created_at", { ascending: false })

    const { data: orders, error: dbError } = await query

    if (dbError) {
      console.error("[API /sales-orders] Database error:", dbError)
      return NextResponse.json({ 
        error: dbError.message, 
        error_ar: "Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø¨ÙŠØ¹" 
      }, { status: 500 })
    }

    return NextResponse.json({
      success: true,
      data: orders || [],
      meta: {
        total: (orders || []).length,
        role: "owner",
        accessLevel: "all",
        governance: {
          branchId: null,
          costCenterId: null
        },
        filterApplied: {
          byCreatedBy: false,
          byBranch: false,
          byCostCenter: false
        }
      }
    })

  } catch (error: any) {
    console.error("[API /sales-orders] Unexpected error:", error)
    return NextResponse.json({ 
      error: error.message, 
      error_ar: "Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹" 
    }, { status: 500 })
  }
}

/**
 * POST /api/sales-orders
 * Ø¥Ù†Ø´Ø§Ø¡ Ø£Ù…Ø± Ø¨ÙŠØ¹ Ø¬Ø¯ÙŠØ¯ Ù…Ø¹ ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø­ÙˆÙƒÙ…Ø© Ø§Ù„Ø¥Ù„Ø²Ø§Ù…ÙŠØ©
 */
export async function POST(request: NextRequest) {
  try {
    const supabase = await createClient()
    
    // 1ï¸âƒ£ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©
    const { data: { user }, error: authError } = await supabase.auth.getUser()
    if (authError || !user) {
      return NextResponse.json({ error: "Unauthorized", error_ar: "ØºÙŠØ± Ù…ØµØ±Ø­" }, { status: 401 })
    }

    // 2ï¸âƒ£ Ø¬Ù„Ø¨ Ø§Ù„Ø´Ø±ÙƒØ© Ø§Ù„Ù†Ø´Ø·Ø©
    const companyId = await getActiveCompanyId(supabase)
    if (!companyId) {
      return NextResponse.json({ error: "No company found", error_ar: "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø´Ø±ÙƒØ©" }, { status: 400 })
    }

    // 3ï¸âƒ£ Ø¬Ù„Ø¨ Ø³ÙŠØ§Ù‚ Ø§Ù„Ø­ÙˆÙƒÙ…Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
    const { data: governance } = await supabase
      .from('user_branch_cost_center')
      .select('branch_id, cost_center_id')
      .eq('user_id', user.id)
      .eq('company_id', companyId)
      .single()

    if (!governance) {
      return NextResponse.json({ 
        error: "User governance context not found", 
        error_ar: "Ø³ÙŠØ§Ù‚ Ø§Ù„Ø­ÙˆÙƒÙ…Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯" 
      }, { status: 403 })
    }

    // 4ï¸âƒ£ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø®Ø²Ù† Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ù„Ù„ÙØ±Ø¹
    const { data: warehouse } = await supabase
      .from('warehouses')
      .select('id')
      .eq('company_id', companyId)
      .eq('branch_id', governance.branch_id)
      .eq('is_main', true)
      .single()

    if (!warehouse) {
      return NextResponse.json({ 
        error: "No main warehouse found for branch", 
        error_ar: "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø®Ø²Ù† Ø±Ø¦ÙŠØ³ÙŠ Ù„Ù„ÙØ±Ø¹" 
      }, { status: 400 })
    }

    // 5ï¸âƒ£ Ù‚Ø±Ø§Ø¡Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø£Ù…Ø± Ø§Ù„Ø¨ÙŠØ¹
    const body = await request.json()
    
    // 6ï¸âƒ£ ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø­ÙˆÙƒÙ…Ø© Ø§Ù„Ø¥Ù„Ø²Ø§Ù…ÙŠØ© Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    const salesOrderData = {
      ...body,
      company_id: companyId,
      branch_id: governance.branch_id,
      cost_center_id: governance.cost_center_id,
      warehouse_id: warehouse.id,
      created_by_user_id: user.id
    }

    const { data: newSalesOrder, error: insertError } = await supabase
      .from("sales_orders")
      .insert(salesOrderData)
      .select()
      .single()

    if (insertError) {
      return NextResponse.json({ 
        error: insertError.message, 
        error_ar: "ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø£Ù…Ø± Ø§Ù„Ø¨ÙŠØ¹" 
      }, { status: 500 })
    }

    return NextResponse.json({
      success: true,
      data: newSalesOrder,
      message: "Sales order created successfully",
      message_ar: "ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø£Ù…Ø± Ø§Ù„Ø¨ÙŠØ¹ Ø¨Ù†Ø¬Ø§Ø­",
      governance: {
        branchId: governance.branch_id,
        costCenterId: governance.cost_center_id,
        warehouseId: warehouse.id,
        enforced: true
      }
    }, { status: 201 })

  } catch (error: any) {
    return NextResponse.json({ 
      error: error.message, 
      error_ar: "Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹" 
    }, { status: 500 })
  }
}

