# ๐ ูุธุงู Realtime ููุญูููุฉ (Governance Realtime System)

## ๐ ูุธุฑุฉ ุนุงูุฉ

ูุธุงู Realtime ูุชูุงูู ูุชุญุฏูุซ ุฌููุน ุชุบููุฑุงุช ุงูุตูุงุญูุงุช ูุงูุฃุฏูุงุฑ ูุงูุนุถููุงุช ูู ERP ููุฑุงู ุจุฏูู Refresh. ูุถูู ุงููุธุงู ุฃู ุงููุณุชุฎุฏููู ูุฑูู ููุท ุงูุจูุงูุงุช ุงููุตุฑุญ ุจูุง ูููุ ูุฃู ุฃู ุชุบููุฑ ูู ุงูุตูุงุญูุงุช ูุชู ุชุทุจููู ููุฑุงู.

## ๐ฏ ุงูุฃูุฏุงู

1. **ุชุญุฏูุซ ููุฑู ููุตูุงุญูุงุช**: ุชุญุฏูุซ ุตูุงุญูุงุช ุงููุณุชุฎุฏู ููุฑุงู ุนูุฏ ุฃู ุชุบููุฑ
2. **ุฅุนุงุฏุฉ ุชููุฆุฉ ุชููุงุฆูุฉ**: ุฅุนุงุฏุฉ ุจูุงุก ุงููุงุฌูุฉ ูุงูุณูุงู ุชููุงุฆูุงู
3. **ููุน ุงููุตูู ุบูุฑ ุงููุตุฑุญ ุจู**: ุฅุบูุงู/ุฅุฎูุงุก ุงูุตูุญุงุช ูุงูุจูุงูุงุช ุบูุฑ ุงููุตุฑุญ ุจูุง ููุฑุงู
4. **ูุชูุงูู ูุน ERP ูุชุนุฏุฏ ุงูุดุฑูุงุช**: ูุนูู ุจุดูู ุตุญูุญ ูู ุจูุฆุฉ ูุชุนุฏุฏุฉ ุงูุดุฑูุงุช ูุงููุฑูุน

## ๐ ุงูุฌุฏุงูู ุงููุบุทุงุฉ

### 1. `company_members`
- **ุงูุบุฑุถ**: ุชุบููุฑุงุช ุงูุนุถููุฉ ูุงูุฏูุฑ
- **ุงูุฃุญุฏุงุซ**: INSERT, UPDATE, DELETE
- **ุงูุชุฃุซูุฑ**: 
  - ุชุบููุฑ ุงูุฏูุฑ โ ุฅุนุงุฏุฉ ุชุญููู ุงูุตูุงุญูุงุช
  - ุชุบููุฑ ุงููุฑุน/ุงููุฎุฒู โ ุฅุนุงุฏุฉ ุจูุงุก ุงูุณูุงู
  - ุฅุถุงูุฉ/ุฅุฒุงูุฉ ุนุถู โ ุชุญุฏูุซ ููุงุฆู ุงููุณุชุฎุฏููู (ูููุฏูุฑูู)

### 2. `branches`
- **ุงูุบุฑุถ**: ุชุบููุฑุงุช ุงููุฑูุน
- **ุงูุฃุญุฏุงุซ**: INSERT, UPDATE, DELETE
- **ุงูุชุฃุซูุฑ**: ุฅุนุงุฏุฉ ุจูุงุก ุงูุณูุงู ุฅุฐุง ูุงู ุงููุฑุน ูุฑุชุจุทุงู ุจุงููุณุชุฎุฏู

### 3. `warehouses`
- **ุงูุบุฑุถ**: ุชุบููุฑุงุช ุงููุฎุงุฒู
- **ุงูุฃุญุฏุงุซ**: INSERT, UPDATE, DELETE
- **ุงูุชุฃุซูุฑ**: ุฅุนุงุฏุฉ ุจูุงุก ุงูุณูุงู ุฅุฐุง ูุงู ุงููุฎุฒู ูุฑุชุจุทุงู ุจุงููุณุชุฎุฏู

### 4. `company_role_permissions`
- **ุงูุบุฑุถ**: ุชุบููุฑุงุช ุตูุงุญูุงุช ุงูุฃุฏูุงุฑ
- **ุงูุฃุญุฏุงุซ**: INSERT, UPDATE, DELETE
- **ุงูุชุฃุซูุฑ**: ุฅุนุงุฏุฉ ุชุญููู ุงูุตูุงุญูุงุช ุฅุฐุง ูุงู ุงูุฏูุฑ ูุฎุต ุงููุณุชุฎุฏู ุงูุญุงูู

### 5. `permissions`
- **ุงูุบุฑุถ**: ุชุบููุฑุงุช ุงูุตูุงุญูุงุช ุงูุนุงูุฉ
- **ุงูุฃุญุฏุงุซ**: INSERT, UPDATE, DELETE
- **ุงูุชุฃุซูุฑ**: ุฅุนุงุฏุฉ ุชุญููู ุงูุตูุงุญูุงุช ูุฌููุน ุงููุณุชุฎุฏููู

## ๐๏ธ ุงูุจููุฉ ุงููุนูุงุฑูุฉ

### 1. Governance Realtime Channel

ููุงุฉ ูููุตูุฉ ูุฎุตุตุฉ ููุญูููุฉ:

```typescript
channelName: `governance_realtime_channel:${companyId}:${userId}`
```

- **ุงูููุชุฑุฉ**: ููุท ุงูุฃุญุฏุงุซ ูู ููุณ `company_id`
- **ุงูุฃูุงู**: ุงูุชุญูู ูู `user_id` ู `role` ูุจู ุงููุนุงูุฌุฉ
- **ุงูุงุณุชููุงููุฉ**: ูููุตูุฉ ุนู ูููุงุช ุงูุฌุฏุงูู ุงูุชุดุบูููุฉ

### 2. ูุนุงูุฌุฉ ุงูุฃุญุฏุงุซ

#### ุงูุญุงูุฉ 1: ุงูุญุฏุซ ูุฎุต ุงููุณุชุฎุฏู ุงูุญุงูู

```typescript
affectsCurrentUser = true
```

**ุงูุฅุฌุฑุงุกุงุช**:
1. ุฅุนุงุฏุฉ ุชุญููู Access Profile ูู API
2. ุชุญุฏูุซ React Context (UserContext, PermissionsContext)
3. ุฅุนุงุฏุฉ ุจูุงุก ุงูุงุดุชุฑุงูุงุช (Realtime Subscriptions)
4. ุฅุบูุงู ุงูุตูุญุงุช ุบูุฑ ุงููุตุฑุญ ุจูุง
5. ุฅุธูุงุฑ ุฑุณุงูุฉ ูููุณุชุฎุฏู

#### ุงูุญุงูุฉ 2: ุงูุญุฏุซ ูุฎุต ูุณุชุฎุฏู ุขุฎุฑ

**ูููุฏูุฑูู (Owner/Admin)**:
- ุชุญุฏูุซ ููุงุฆู ุงููุณุชุฎุฏููู
- ุชุญุฏูุซ ุตูุญุฉ ุฅุฏุงุฑุฉ ุงููุณุชุฎุฏููู
- ุชุญุฏูุซ ุงูุตูุงุญูุงุช ุงููุนุฑูุถุฉ

**ูููุณุชุฎุฏููู ุงูุขุฎุฑูู**:
- ุชุฌุงูู ุงูุญุฏุซ ุชูุงูุงู

### 3. ุฅุนุงุฏุฉ ุจูุงุก ุงูุงุดุชุฑุงูุงุช

ุนูุฏ ุฃู ุชุบููุฑ ูู:
- ุงูุฏูุฑ
- ุงููุฑุน
- ุงููุฎุฒู
- ุงูุตูุงุญูุงุช

ูุชู:
1. ุฅูุบุงุก ุฌููุน ุงูุงุดุชุฑุงูุงุช ุงูุญุงููุฉ
2. ุฅุนุงุฏุฉ ุจูุงุก ุงูุณูุงู (Context)
3. ุฅุนุงุฏุฉ ุงูุงุดุชุฑุงู ูู ุฌููุน ุงูุฌุฏุงูู ุจููุงุชุฑ ุฌุฏูุฏุฉ

## ๐ ููุงุนุฏ ุงูุฃูุงู

### 1. ุงูููุชุฑุฉ ุนูู ูุณุชูู ูุงุนุฏุฉ ุงูุจูุงูุงุช

```sql
filter: `company_id=eq.${companyId}`
```

- ุฌููุน ุงูุฃุญุฏุงุซ ูุฌุจ ุฃู ุชููู ูู ููุณ ุงูุดุฑูุฉ
- ููุน ุงุณุชูุจุงู ุฃุญุฏุงุซ ูู ุดุฑูุงุช ุฃุฎุฑู

### 2. ุงูููุชุฑุฉ ุนูู ูุณุชูู ุงูุชุทุจูู

```typescript
if (record.company_id !== companyId) {
  return false // ุฑูุถ ุงูุญุฏุซ
}
```

### 3. ุงูุชุญูู ูู ุงูุตูุงุญูุงุช

- **Owner/Admin**: ูุฑูุง ุฌููุน ุงูุฃุญุฏุงุซ ูู ุงูุดุฑูุฉ
- **ุงููุณุชุฎุฏููู ุงูุขุฎุฑูู**: ููุท ุงูุฃุญุฏุงุซ ุงูุชู ุชุฎุตูู

### 4. ููุน ุงูุซุบุฑุงุช

- ุฃู ุญุฏุซ ุบูุฑ ูุตุฑุญ ุจู ูุง ููุนุงูุฌ
- ูุง ููุถุงู ููู State
- ูุง ูุธูุฑ ูู ุงููุงุฌูุฉ

## ๐จ ูุงุฌูุฉ ุงููุณุชุฎุฏู (UX)

### ุฑุณุงุฆู Toast

ุนูุฏ ุชุบููุฑ ุตูุงุญูุงุช ุงููุณุชุฎุฏู:

```
"ุชู ุชุญุฏูุซ ุตูุงุญูุงุชู"
"ุชู ุชุญุฏูุซ ุฏูุฑู ุจูุงุณุทุฉ ุงูุฅุฏุงุฑุฉ. ูุฏ ุชุชุบูุฑ ุจุนุถ ุงูุตูุญุงุช ุงููุชุงุญุฉ ูู."
```

ุนูุฏ ุชุบููุฑ ุงููุฑุน/ุงููุฎุฒู:

```
"ุชู ุชุญุฏูุซ ุชุนูููู"
"ุชู ุชุญุฏูุซ ุงููุฑุน ุฃู ุงููุฎุฒู ุงูุฎุงุต ุจู. ุณูุชู ุชุญุฏูุซ ุงูุจูุงูุงุช ุงููุนุฑูุถุฉ."
```

### ุงูุณููู

- **ุจุฏูู Refresh**: ุชุญุฏูุซ ููุฑู ุจุฏูู ุฅุนุงุฏุฉ ุชุญููู ุงูุตูุญุฉ
- **ุจุฏูู Logout**: ูุง ุญุงุฌุฉ ูุชุณุฌูู ุงูุฎุฑูุฌ
- **ุฅุบูุงู ุชููุงุฆู**: ุฅุบูุงู ุงูุตูุญุงุช ุบูุฑ ุงููุตุฑุญ ุจูุง
- **ุชุนุทูู ุงูุฃุฒุฑุงุฑ**: ุชุนุทูู ุงูุฃุฒุฑุงุฑ ููุฑุงู ุนูุฏ ุณุญุจ ุงูุตูุงุญูุฉ

## ๐ ุงูุงุณุชุฎุฏุงู

### ูู PermissionsProvider

```typescript
import { useGovernanceRealtime } from "@/hooks/use-governance-realtime"

export function PermissionsProvider({ children }) {
  const { refreshPermissions } = usePermissions()
  
  useGovernanceRealtime({
    onPermissionsChanged: refreshPermissions,
    onRoleChanged: refreshPermissions,
    showNotifications: true,
  })
  
  // ...
}
```

### ูู useUserContext

```typescript
import { useGovernanceRealtime } from "@/hooks/use-governance-realtime"

export function useUserContext() {
  const loadUserContext = useCallback(async () => {
    // ...
  }, [])
  
  useGovernanceRealtime({
    onPermissionsChanged: loadUserContext,
    onRoleChanged: loadUserContext,
    onBranchOrWarehouseChanged: loadUserContext,
    showNotifications: true,
  })
  
  // ...
}
```

## ๐ง ุงูุชูููู

### ุชูุนูู Realtime ุนูู ุงูุฌุฏุงูู

ุงุณุชุฎุฏู SQL script:

```sql
-- scripts/enable_realtime_tables.sql
```

ุฃู ูู Supabase Dashboard:
1. Database โ Replication
2. ูุนูู Realtime ููู ุฌุฏูู ูู ุฌุฏุงูู ุงูุญูููุฉ

## โ ุงูุชุญูู

ุฑุงุฌุน `GOVERNANCE_REALTIME_VERIFICATION.md` ููุชุญูู ูู:
- ุชูุนูู Realtime ุนูู ุฌููุน ุงูุฌุฏุงูู
- ุนูู ุงููุธุงู ุจุดูู ุตุญูุญ
- ุงุฎุชุจุงุฑ ุฌููุน ุงูุณููุงุฑูููุงุช

## ๐ ุงูุฃูุงู

ุฑุงุฌุน `GOVERNANCE_REALTIME_SECURITY_RULES.md` ููุชูุงุตูู ุงููุงููุฉ ุญูู:
- ููุงุนุฏ ุงูููุชุฑุฉ
- ููุน ุงูุซุบุฑุงุช
- ุงูุชุญูู ูู ุงูุตูุงุญูุงุช

## ๐ ุงููููุงุช ุฐุงุช ุงูุตูุฉ

- `lib/realtime-manager.ts` - Realtime Manager ุงูุฑุฆูุณู
- `hooks/use-governance-realtime.ts` - Hook ูุงุณุชุฎุฏุงู ูุธุงู ุงูุญูููุฉ
- `lib/permissions-context.tsx` - Permissions Context
- `hooks/use-user-context.ts` - User Context
- `scripts/enable_realtime_tables.sql` - SQL Script ููุชูุนูู
