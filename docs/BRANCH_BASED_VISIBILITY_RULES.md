# ๐ ููุงุนุฏ ุงูุนุฑุถ ุญุณุจ ุงููุฑุน (Branch-Based Visibility Rules)

## ๐ ุงูููุงุนุฏ ุงูุฅูุฒุงููุฉ

### โ ุงููุงุนุฏุฉ ุงูุฃููู: ุนุฒู ูุงูู ุจูู ุงููุฑูุน
**ูู ูุณุคูู ูุฎุฒู ูุง ูุฑู ุฅูุง ุทูุจุงุช ููู ุงููุฎุฒูู ุงูุฎุงุตุฉ ุจุงููุฑุน ุงูุชุงุจุน ูู ููุท.**

- โ ูุชู ุฑุจุท ูู ุทูุจ ููู ูุฎุฒูู ุจุญูููู:
  - `source_branch_id` (ูุฑุน ุงููุฎุฒู ุงููุตุฏุฑ)
  - `destination_branch_id` (ูุฑุน ุงููุฎุฒู ุงููุฌูุฉ)
- โ ุงูุนุฑุถ ูุนุชูุฏ ุนูู ูุฐูู ุงูุญูููู ุจุดูู ุฅูุฒุงูู
- โ ููููุน ุชูุงูุงู ุนุฑุถ ุฃู ุทูุจุงุช ููู ุชุฎุต ูุฑูุน ุฃุฎุฑู

---

### โ ุงููุงุนุฏุฉ ุงูุซุงููุฉ: ุชุญุฏูุซ ุงููุฑุน ุงูููุฑู
**ุนูุฏ ุชุบููุฑ ูุฑุน ุงููุณุชุฎุฏู ูู ุตูุญุฉ ุงููุณุชุฎุฏููู:**

1. โ **ูุชู ุชุญุฏูุซ ุตูุงุญูุงุช ุงูุนุฑุถ ููุฑุงู**
2. โ **ูุง ูุฑู ุงููุณุชุฎุฏู ุจุนุฏ ุงูุชุบููุฑ ุฅูุง ุทูุจุงุช ููู ุงููุฎุฒูู ุงูุฎุงุตุฉ ุจุงููุฑุน ุงูุฌุฏูุฏ ููุท**
3. โ **ููููุน ุงูุงุญุชูุงุธ ุจุฃู Cache ุฃู Session ูุฏ ูุณูุญ ุจุฑุคูุฉ ุทูุจุงุช ุชุฎุต ุงููุฑุน ุงูุณุงุจู**

---

## ๐ฏ ุงููุฏู

1. **ุนุฒู ูุงูู ุจูู ุงููุฑูุน**
2. **ููุน ุชุณุฑูุจ ุจูุงูุงุช ุงููุฎุฒูู**
3. **ุถูุงู ุชูุงูู ุงูุตูุงุญูุงุช ูุน ุงููุฑุน ุงููุนูู ูููุณุชุฎุฏู ูู ุฃู ูุญุธุฉ**

---

## ๐ฅ ุงูุตูุงุญูุงุช ุญุณุจ ุงูุฏูุฑ

### 1๏ธโฃ Owner/Admin
- โ ูุฑูู **ุฌููุน** ุทูุจุงุช ุงูููู ูู **ุฌููุน** ุงููุฑูุน
- โ ูุง ุชูุฌุฏ ูููุฏ ุนูู ุงูุนุฑุถ

### 2๏ธโฃ Manager (ูุฏูุฑ ุงููุฑุน)
- โ ูุฑู **ููุท** ุทูุจุงุช ุงูููู ุงูุฎุงุตุฉ **ุจูุฑุนู**
- โ ูุดูู ุฐูู:
  - ุทูุจุงุช ุงูููู ูู ูุฎุงุฒู ูุฑุนู ุฅูู ูุฎุงุฒู ุฃุฎุฑู
  - ุทูุจุงุช ุงูููู ูู ูุฎุงุฒู ุฃุฎุฑู ุฅูู ูุฎุงุฒู ูุฑุนู
- โ ูุง ูุฑู ุทูุจุงุช ุงูููู ุจูู ูุฑูุน ุฃุฎุฑู

### 3๏ธโฃ Store Manager (ูุณุคูู ุงููุฎุฒู)
- โ ูุฑู **ููุท** ุงูุทูุจุงุช ุงูููุฌูุฉ **ููุฎุฒูู ูู ูุฑุนู**
- โ ูุง ูุฑู:
  - ุงูุทูุจุงุช ุงูููุฌูุฉ ููุฎุงุฒู ุฃุฎุฑู
  - ุงูุทูุจุงุช ุงูููุฌูุฉ ููุฑูุน ุฃุฎุฑู
  - ุงูุทูุจุงุช ุงูุชู ูููู ูููุง ูุฎุฒูู ูู ุงููุตุฏุฑ (ููุท ุงููุฌูุฉ)

---

## ๐ป ุงูุชุทุจูู ุงูุชููู

### 1๏ธโฃ ุฌูุจ ุจูุงูุงุช ุงููุณุชุฎุฏู (ุจุฏูู Cache)
```typescript
// โ ุฌูุจ branch_id ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ูุจุงุดุฑุฉ ูู ูู ูุฑุฉ
const { data: member } = await supabase
  .from("company_members")
  .select("role, warehouse_id, branch_id")
  .eq("company_id", companyId)
  .eq("user_id", user.id)
  .single()

const role = member?.role || "staff"
const userWarehouseId = member?.warehouse_id || null
const userBranchId = member?.branch_id || null
```

### 2๏ธโฃ ููุชุฑุฉ ุทูุจุงุช ุงูููู
```typescript
let transfersQuery = supabase
  .from("inventory_transfers")
  .select(`
    id, transfer_number, status, 
    source_branch_id, destination_branch_id,
    source_warehouse_id, destination_warehouse_id,
    ...
  `)
  .eq("company_id", companyId)

// ๐ ููุชุฑุฉ ุญุณุจ ุงูุฏูุฑ ูุงููุฑุน
if (role === "store_manager" && userWarehouseId && userBranchId) {
  // โ ูุณุคูู ุงููุฎุฒู: ูุฑู ููุท ุงูุทูุจุงุช ุงูููุฌูุฉ ููุฎุฒูู ูู ูุฑุนู
  transfersQuery = transfersQuery
    .eq("destination_warehouse_id", userWarehouseId)
    .eq("destination_branch_id", userBranchId)
} else if (role === "manager" && userBranchId) {
  // โ ุงููุฏูุฑ: ูุฑู ููุท ุทูุจุงุช ุงูููู ุงูุฎุงุตุฉ ุจูุฑุนู
  transfersQuery = transfersQuery
    .or(`source_branch_id.eq.${userBranchId},destination_branch_id.eq.${userBranchId}`)
}
// โ Owner/Admin: ูุง ููุชุฑุฉ
```

### 3๏ธโฃ ุงูุชุญูู ูู ุงูุตูุงุญูุงุช ูู ุตูุญุฉ ุงูุชูุงุตูู
```typescript
// ๐ ุงูุชุญูู ูู ุงูุตูุงุญูุงุช ุญุณุจ ุงููุฑุน
if (role === "store_manager" && warehouseId && branchId) {
  if (transfer.destination_warehouse_id !== warehouseId || 
      transfer.destination_branch_id !== branchId) {
    // โ ุฑูุถ ุงููุตูู
    router.push("/inventory-transfers")
    return
  }
} else if (role === "manager" && branchId) {
  if (transfer.source_branch_id !== branchId && 
      transfer.destination_branch_id !== branchId) {
    // โ ุฑูุถ ุงููุตูู
    router.push("/inventory-transfers")
    return
  }
}
```

---

## ๐ ุฃูุซูุฉ ุนูููุฉ

### ูุซุงู 1: ูุณุคูู ูุฎุฒู ูุฏููุฉ ูุตุฑ
- **ุงูุฏูุฑ:** `store_manager`
- **ุงููุฑุน:** `ูุฑุน ูุฏููุฉ ูุตุฑ` (ID: `branch-123`)
- **ุงููุฎุฒู:** `ูุฎุฒู ูุฏููุฉ ูุตุฑ` (ID: `warehouse-456`)

**ูุง ูุฑุงู:**
- โ ุทูุจ ููู: `ุงููุฎุฒู ุงูุฑุฆูุณู (ูุฑุน ุงููุงูุฑุฉ)` โ `ูุฎุฒู ูุฏููุฉ ูุตุฑ (ูุฑุน ูุฏููุฉ ูุตุฑ)`
- โ ุทูุจ ููู: `ุงููุฎุฒู ุงูุฑุฆูุณู` โ `ูุฎุฒู ูุตุฑ ุงูุฌุฏูุฏุฉ (ูุฑุน ุขุฎุฑ)`
- โ ุทูุจ ููู: `ูุฎุฒู ูุฏููุฉ ูุตุฑ` โ `ูุฎุฒู ุขุฎุฑ` (ูุฃูู ููุณ ุงููุฌูุฉ)

**ุจุนุฏ ุชุบููุฑ ูุฑุนู ุฅูู `ูุฑุน ุงูุฅุณููุฏุฑูุฉ`:**
- โ ูุง ูุฑู ุฃู ุทูุจ ูู ูุฑุน ูุฏููุฉ ูุตุฑ ุงูุณุงุจู
- โ ูุฑู ููุท ุงูุทูุจุงุช ุงูููุฌูุฉ ููุฎุฒูู ูู ูุฑุน ุงูุฅุณููุฏุฑูุฉ ุงูุฌุฏูุฏ

---

### ูุซุงู 2: ูุฏูุฑ ูุฑุน ูุฏููุฉ ูุตุฑ
- **ุงูุฏูุฑ:** `manager`
- **ุงููุฑุน:** `ูุฑุน ูุฏููุฉ ูุตุฑ` (ID: `branch-123`)

**ูุง ูุฑุงู:**
- โ ุทูุจ ููู: `ูุฎุฒู ูุฏููุฉ ูุตุฑ` โ `ูุฎุฒู ุงููุงูุฑุฉ`
- โ ุทูุจ ููู: `ูุฎุฒู ุงููุงูุฑุฉ` โ `ูุฎุฒู ูุฏููุฉ ูุตุฑ`
- โ ุทูุจ ููู: `ูุฎุฒู ุงููุงูุฑุฉ` โ `ูุฎุฒู ุงูุฅุณููุฏุฑูุฉ` (ุจูู ูุฑูุน ุฃุฎุฑู)

**ุจุนุฏ ุชุบููุฑ ูุฑุนู ุฅูู `ูุฑุน ุงููุงูุฑุฉ`:**
- โ ูุง ูุฑู ุฃู ุทูุจ ูู ูุฑุน ูุฏููุฉ ูุตุฑ ุงูุณุงุจู
- โ ูุฑู ููุท ุงูุทูุจุงุช ุงูุฎุงุตุฉ ุจูุฑุน ุงููุงูุฑุฉ ุงูุฌุฏูุฏ

---

## โ ููุฎุต ุงูุชุทุจูู

| ุงูุฏูุฑ | ุงูููุชุฑุฉ | ุงูุญููู ุงููุณุชุฎุฏูุฉ |
|------|---------|-------------------|
| **Owner/Admin** | ูุง ููุชุฑุฉ | - |
| **Manager** | ุญุณุจ ุงููุฑุน | `source_branch_id` OR `destination_branch_id` |
| **Store Manager** | ุญุณุจ ุงููุฑุน ูุงููุฎุฒู | `destination_branch_id` AND `destination_warehouse_id` |

---

## ๐จ ุชุญุฐูุฑุงุช ูููุฉ

1. โ **ูุง ุชุณุชุฎุฏู Cache** ูู `branch_id` ุฃู `warehouse_id`
2. โ **ุงุฌูุจ ุงูุจูุงูุงุช ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ูุจุงุดุฑุฉ** ูู ูู ูุฑุฉ
3. โ **ุชุญูู ูู ุงูุตูุงุญูุงุช ูู ูู ุตูุญุฉ** (ุงููุงุฆูุฉ ูุงูุชูุงุตูู)
4. โ **ูุง ุชุนุชูุฏ ุนูู Session** ูุฏ ูุญุชูุธ ุจุจูุงูุงุช ูุฏููุฉ

