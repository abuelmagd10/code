# منع تكرار رقم التليفون للعملاء
# Customer Phone Duplicate Prevention

## الوضع الحالي

### ✅ التحقق موجود في:

1. **الواجهة (Frontend)**:
   - `components/customers/customer-form-dialog.tsx` - دالة `checkPhoneDuplicate`
   - `app/invoices/new/page.tsx` - التحقق قبل إنشاء عميل جديد
   - `app/sales-orders/new/page.tsx` - التحقق قبل إنشاء عميل جديد

2. **API Endpoint** (تم إضافته):
   - `app/api/customers/route.ts` - التحقق في POST endpoint

3. **قاعدة البيانات** (تم إضافته):
   - `scripts/133_prevent_duplicate_customer_phone.sql` - Trigger يمنع التكرار على مستوى قاعدة البيانات

## كيف يعمل النظام

### 1. تطبيع رقم التليفون

يتم تطبيع رقم التليفون قبل المقارنة:
- تحويل الأرقام العربية (٠-٩) إلى إنجليزية
- تحويل الأرقام الهندية (۰-۹) إلى إنجليزية
- إزالة المسافات والأحرف الخاصة (ما عدا + في البداية)
- معالجة أرقام الهواتف المصرية (002, 02, 2)

**مثال:**
- `01234567890` = `01234567890`
- `٠١٢٣٤٥٦٧٨٩٠` = `01234567890`
- `+2 0123 456 7890` = `01234567890`
- `00201234567890` = `01234567890`

### 2. التحقق من التكرار

يتم التحقق من التكرار في **نفس الشركة فقط**:
- يمكن لشركتين مختلفتين أن يكون لهما عملاء بنفس رقم التليفون
- لا يمكن لشركة واحدة أن يكون لها عميلان بنفس رقم التليفون

### 3. مستويات الحماية

#### المستوى 1: الواجهة (Frontend)
- يتحقق قبل إرسال الطلب إلى API
- يعرض رسالة خطأ فورية للمستخدم
- يمنع إرسال الطلب إذا وُجد تكرار

#### المستوى 2: API Endpoint
- يتحقق مرة أخرى قبل الإدخال في قاعدة البيانات
- يعيد رسالة خطأ واضحة بالعربية والإنجليزية
- يعيد معلومات العميل المكرر

#### المستوى 3: قاعدة البيانات (Database Trigger)
- حماية نهائية على مستوى قاعدة البيانات
- يمنع التكرار حتى لو تم تجاوز الواجهة والAPI
- يعيد رسالة خطأ: `DUPLICATE_PHONE: [اسم العميل]`

## رسائل الخطأ

### من الواجهة:
```
رقم الهاتف مستخدم بالفعل لعميل: [اسم العميل]
Phone already used by: [customer name]
```

### من API:
```json
{
  "error": "Phone number already exists",
  "error_ar": "رقم الهاتف مستخدم بالفعل لعميل آخر: [اسم العميل]",
  "duplicate_customer": {
    "id": "...",
    "name": "..."
  }
}
```

### من قاعدة البيانات:
```
DUPLICATE_PHONE: [اسم العميل]
Phone number [رقم التليفون] is already used by customer: [اسم العميل]
```

## التثبيت

لتطبيق الحماية على مستوى قاعدة البيانات:

```sql
-- تشغيل السكريبت
\i scripts/133_prevent_duplicate_customer_phone.sql
```

أو من Supabase Dashboard:
1. اذهب إلى SQL Editor
2. انسخ محتوى `scripts/133_prevent_duplicate_customer_phone.sql`
3. شغّل السكريبت

## الاختبار

### اختبار من الواجهة:
1. حاول إنشاء عميل جديد برقم تليفون موجود
2. يجب أن تظهر رسالة خطأ فوراً

### اختبار من API:
```bash
curl -X POST https://your-api.com/api/customers \
  -H "Content-Type: application/json" \
  -d '{
    "name": "عميل جديد",
    "phone": "01234567890",
    "email": "test@example.com"
  }'
```

### اختبار من قاعدة البيانات:
```sql
-- محاولة إدخال عميل بنفس رقم التليفون
INSERT INTO customers (company_id, name, email, phone, branch_id, cost_center_id, created_by_user_id)
VALUES (
  'company-uuid',
  'عميل مكرر',
  'duplicate@example.com',
  '01234567890', -- نفس رقم التليفون
  'branch-uuid',
  'cost-center-uuid',
  'user-uuid'
);
-- يجب أن يفشل مع رسالة DUPLICATE_PHONE
```

## ملاحظات مهمة

1. **التطبيع**: يتم تطبيع رقم التليفون قبل المقارنة، لذلك:
   - `01234567890` = `+2 0123 456 7890` = `٠١٢٣٤٥٦٧٨٩٠`
   - كلها تعتبر نفس الرقم

2. **نطاق التحقق**: التحقق يكون في **نفس الشركة فقط**
   - شركتان مختلفتان يمكن أن يكون لهما عملاء بنفس رقم التليفون

3. **التحديث**: عند تحديث عميل موجود:
   - يتم استثناء السجل الحالي من التحقق
   - يمكن تغيير رقم التليفون إلى رقم آخر (إذا لم يكن مستخدماً)

4. **القيم الفارغة**: إذا كان رقم التليفون `NULL` أو فارغاً:
   - لا يتم التحقق من التكرار
   - يمكن إنشاء عملاء بدون رقم تليفون

## الإجابة على السؤال

**س: هل يمكن إنشاء عميل في حالة تسجيله سابقاً بنفس رقم التليفون؟**

**ج: لا، لا يمكن.** النظام يمنع ذلك على 3 مستويات:
1. ✅ الواجهة - يمنع إرسال الطلب
2. ✅ API - يرفض الطلب مع رسالة خطأ
3. ✅ قاعدة البيانات - Trigger يمنع الإدخال

**استثناءات:**
- يمكن لشركتين مختلفتين أن يكون لهما عملاء بنفس رقم التليفون
- يمكن إنشاء عملاء بدون رقم تليفون (NULL أو فارغ)
