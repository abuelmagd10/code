# ๐ ุชูุฑูุฑ ูุฑุงุฌุนุฉ ูุธุงู ุงููุฑุชุฌุนุงุช - ุฑุจุท ุงููุฑูุน ูุงููุฎุงุฒู

## ๐ ูุธุฑุฉ ุนุงูุฉ

ูุฐุง ุงูุชูุฑูุฑ ููุถุญ ุงูุญุงูุฉ ุงูุญุงููุฉ ููุธุงู ูุฑุชุฌุนุงุช ุงูุจูุน ูุงูุดุฑุงุก ูู ุญูุซ ุฑุจุทูุง ุจููุท ุงููุฎุงุฒู ุนูู ูุณุชูู ุงููุฑูุน.

**ุชุงุฑูุฎ ุงููุฑุงุฌุนุฉ:** 2026-01-03

---

## โ ูุง ูู ููุฌูุฏ ุญุงููุงู

### 1๏ธโฃ **ูุฑุชุฌุนุงุช ุงูุจูุน (Sales Returns)**

#### ุงูุฑุจุท ุจุงููุฑูุน ูุงููุฎุงุฒู:
โ **ููุฌูุฏ** - ุงูููุฏ ูุฑุจุท ุงููุฑุชุฌุน ุจุงููุฑุน ูุงููุฎุฒู ูู ุงููุงุชูุฑุฉ ุงูุฃุตููุฉ

<augment_code_snippet path="app/sales-returns/new/page.tsx" mode="EXCERPT">
````typescript
// ุฅูุดุงุก ุญุฑูุงุช ุงููุฎุฒูู (ุงุณุชุฑุฌุงุน ุงููููุงุช)
await supabase.from("inventory_transactions").insert({
  company_id: companyId,
  product_id: item.product_id,
  transaction_type: "sale_return",
  quantity_change: item.quantity,
  reference_id: invoiceStatus === 'sent' ? form.invoice_id : (journalEntryId || form.invoice_id),
  journal_entry_id: invoiceStatus === 'sent' ? null : journalEntryId,
  notes: `ูุฑุชุฌุน ${form.return_number}`,
  branch_id: invoiceBranchId,        // โ ุฑุจุท ุจุงููุฑุน
  cost_center_id: invoiceCostCenterId,
  warehouse_id: invoiceWarehouseId,  // โ ุฑุจุท ุจุงููุฎุฒู
})
````
</augment_code_snippet>

#### ุงููููุฏ ุงููุญุงุณุจูุฉ:
โ **ููุฌูุฏ** - ุงููููุฏ ุงููุญุงุณุจูุฉ ุชูุฑุจุท ุจุงููุฑุน ูุงููุฎุฒู

<augment_code_snippet path="app/sales-returns/new/page.tsx" mode="EXCERPT">
````typescript
const { data: journalEntry } = await supabase.from("journal_entries").insert({
  company_id: companyId,
  reference_type: "sales_return",
  reference_id: salesReturnId,
  entry_date: form.return_date,
  description: `ูุฑุชุฌุน ูุจูุนุงุช ุฑูู ${form.return_number}`,
  branch_id: invoiceBranchId,        // โ ุฑุจุท ุจุงููุฑุน
  cost_center_id: invoiceCostCenterId,
  warehouse_id: invoiceWarehouseId,  // โ ุฑุจุท ุจุงููุฎุฒู
})
````
</augment_code_snippet>

---

### 2๏ธโฃ **ูุฑุชุฌุนุงุช ุงูุดุฑุงุก (Purchase Returns)**

#### ุงูุฑุจุท ุจุงููุฑูุน ูุงููุฎุงุฒู:
โ **ููุฌูุฏ** - ุงูููุฏ ูุฑุจุท ุงููุฑุชุฌุน ุจุงููุฑุน ูุงููุฎุฒู ูู ูุงุชูุฑุฉ ุงูุดุฑุงุก ุงูุฃุตููุฉ

<augment_code_snippet path="app/purchase-returns/new/page.tsx" mode="EXCERPT">
````typescript
// ุฅูุดุงุก ุญุฑูุงุช ุงููุฎุฒูู (ุฎุตู ุงููููุงุช)
await supabase.from("inventory_transactions").insert({
  company_id: companyId,
  product_id: item.product_id,
  transaction_type: "purchase_return",
  quantity_change: -item.quantity, // ุณุงูุจ ูุฃูู ุฎุฑูุฌ ูู ุงููุฎุฒูู
  reference_id: journalEntryId || form.bill_id,
  journal_entry_id: journalEntryId,
  notes: `ูุฑุชุฌุน ูุดุชุฑูุงุช ${form.return_number}`,
  branch_id: billBranchId,          // โ ุฑุจุท ุจุงููุฑุน
  cost_center_id: billCostCenterId,
  warehouse_id: billWarehouseId,    // โ ุฑุจุท ุจุงููุฎุฒู
})
````
</augment_code_snippet>

---

## โ ูุง ูู ููููุฏ

### 1๏ธโฃ **ุงูุชุญูู ูู ุงูุฑุตูุฏ ูุจู ูุฑุชุฌุนุงุช ุงูุดุฑุงุก**

โ **ููููุฏ** - ูุง ููุฌุฏ ุชุญูู ูู ููุงูุฉ ุฑุตูุฏ ุงููุฎุฒู ูุจู ุชูููุฐ ูุฑุชุฌุน ุงูุดุฑุงุก

**ุงููุดููุฉ:**
- ุนูุฏ ุฅุฑุฌุงุน ุจุถุงุนุฉ ููููุฑุฏุ ูุฌุจ ุงูุชุญูู ูู ุฃู ุงููููุฉ ููุฌูุฏุฉ ูู ุงููุฎุฒู
- ุญุงููุงูุ ูููู ุฅูุดุงุก ูุฑุชุฌุน ุดุฑุงุก ุญุชู ูู ูู ููู ููุงู ุฑุตูุฏ ูุงูู ูู ุงููุฎุฒู
- ูุฐุง ูุฏ ูุคุฏู ุฅูู ุฑุตูุฏ ุณุงูุจ ูู ุงููุฎุฒู

**ุงูุญู ุงููุทููุจ:**
```typescript
// ูุจู ุฅูุดุงุก ูุฑุชุฌุน ุงูุดุฑุงุกุ ุงูุชุญูู ูู ุงูุฑุตูุฏ
for (const item of validItems) {
  const availableStock = await getProductStock(
    item.product_id, 
    billWarehouseId, 
    billBranchId
  )
  
  if (availableStock < item.quantity) {
    throw new Error(
      `ุฑุตูุฏ ุงููุฎุฒู ุบูุฑ ูุงูู ููููุชุฌ ${item.product_name}. ` +
      `ุงููุชุงุญ: ${availableStock}ุ ุงููุทููุจ: ${item.quantity}`
    )
  }
}
```

---

### 2๏ธโฃ **ููุน ุชุบููุฑ ุงููุฑุน/ุงููุฎุฒู ูู ุงููุฑุชุฌุนุงุช**

โ๏ธ **ุบูุฑ ูุงุถุญ** - ูุง ููุฌุฏ ููุน ุตุฑูุญ ูุชุบููุฑ ุงููุฑุน ุฃู ุงููุฎุฒู ุนูุฏ ุฅูุดุงุก ุงููุฑุชุฌุน

**ุงููุดููุฉ:**
- ุงูููุฏ ูุฃุฎุฐ `branch_id` ู `warehouse_id` ูู ุงููุงุชูุฑุฉ/ุงูุฃูุฑ ุงูุฃุตูู
- ููู ูุง ููุฌุฏ ุชุญูู ุตุฑูุญ ูููุน ุงููุณุชุฎุฏู ูู ุชุบููุฑููุง

**ุงูุญู ุงููุทููุจ:**
- ุฅุฎูุงุก ุญููู ุงููุฑุน ูุงููุฎุฒู ูู ูุงุฌูุฉ ุงููุฑุชุฌุนุงุช
- ุฌุนููุง ูููุฑุงุกุฉ ููุท (read-only)
- ุฅุถุงูุฉ ุชุญูู ูู ุงูู backend ูุฑูุถ ุฃู ูุฑุชุฌุน ุจูุฑุน/ูุฎุฒู ูุฎุชูู

---

### 3๏ธโฃ **ุงูุชูุซูู ุงูุดุงูู**

โ **ููููุฏ** - ูุง ููุฌุฏ ุชูุซูู ุดุงูู ูููุงุนุฏ ุงููุฑุชุฌุนุงุช ุนูู ูุณุชูู ุงููุฑูุน

**ุงููุทููุจ:**
- ุชูุซูู ุงูููุงุนุฏ ุงูุฅูุฒุงููุฉ
- ุฃูุซูุฉ ุนูููุฉ
- ุญุงูุงุช ุงูุงุฎุชุจุงุฑ

---

## ๐ ุฌุฏูู ุงูููุงุฑูุฉ

| ุงูููุฒุฉ | ูุฑุชุฌุนุงุช ุงูุจูุน | ูุฑุชุฌุนุงุช ุงูุดุฑุงุก | ุงูุญุงูุฉ |
|--------|---------------|-----------------|---------|
| ุฑุจุท ุจู `branch_id` | โ ููุฌูุฏ | โ ููุฌูุฏ | โ ุฌูุฏ |
| ุฑุจุท ุจู `warehouse_id` | โ ููุฌูุฏ | โ ููุฌูุฏ | โ ุฌูุฏ |
| ุฑุจุท ุจู `source_document_id` | โ ููุฌูุฏ (`invoice_id`) | โ ููุฌูุฏ (`bill_id`) | โ ุฌูุฏ |
| ุงูุชุญูู ูู ุงูุฑุตูุฏ | โ๏ธ ุบูุฑ ูุทููุจ (ุฅุถุงูุฉ ูููุฎุฒูู) | โ ููููุฏ | โ๏ธ ูุญุชุงุฌ ุชุญุณูู |
| ููุน ุชุบููุฑ ุงููุฑุน/ุงููุฎุฒู | โ๏ธ ุบูุฑ ูุงุถุญ | โ๏ธ ุบูุฑ ูุงุถุญ | โ๏ธ ูุญุชุงุฌ ุชุญุณูู |
| ุงูุชูุซูู | โ ููููุฏ | โ ููููุฏ | โ ูุญุชุงุฌ ุฅุถุงูุฉ |

---

## ๐ฏ ุงูุชูุตูุงุช

### ุฃููููุฉ ุนุงููุฉ (High Priority):
1. โ **ุฅุถุงูุฉ ุงูุชุญูู ูู ุงูุฑุตูุฏ ููุฑุชุฌุนุงุช ุงูุดุฑุงุก**
2. โ **ููุน ุชุบููุฑ ุงููุฑุน/ุงููุฎุฒู ูู ุงููุฑุชุฌุนุงุช**

### ุฃููููุฉ ูุชูุณุทุฉ (Medium Priority):
3. โ **ุฅุถุงูุฉ ุฑุณุงุฆู ุฎุทุฃ ูุงุถุญุฉ**
4. โ **ุฅูุดุงุก ุชูุซูู ุดุงูู**

### ุฃููููุฉ ููุฎูุถุฉ (Low Priority):
5. โ **ุฅุถุงูุฉ ุญุงูุงุช ุงุฎุชุจุงุฑ**

---

## ๐ ุงูุฎูุงุตุฉ

**ุงูุญุงูุฉ ุงูุนุงูุฉ:** ๐ก **ุฌูุฏ ูุน ุงูุญุงุฌุฉ ูุชุญุณููุงุช**

โ **ุงูููุงุท ุงูุฅูุฌุงุจูุฉ:**
- ุงูุฑุจุท ุจุงููุฑูุน ูุงููุฎุงุฒู ููุฌูุฏ ููุนูู
- ุงููููุฏ ุงููุญุงุณุจูุฉ ุชูุฑุจุท ุจุดูู ุตุญูุญ
- ุงูููุท ุงููุญุงุณุจู ูุญููุธ

โ๏ธ **ุงูููุงุท ุงูุชู ุชุญุชุงุฌ ุชุญุณูู:**
- ุฅุถุงูุฉ ุงูุชุญูู ูู ุงูุฑุตูุฏ ููุฑุชุฌุนุงุช ุงูุดุฑุงุก
- ููุน ุชุบููุฑ ุงููุฑุน/ุงููุฎุฒู ุจุดูู ุตุฑูุญ
- ุฅุถุงูุฉ ุงูุชูุซูู ุงูุดุงูู

---

## โ ุงูุชุญุณููุงุช ุงููุทุจูุฉ

### 1๏ธโฃ **ุฅุถุงูุฉ ุงูุชุญูู ูู ุงูุฑุตูุฏ ููุฑุชุฌุนุงุช ุงูุดุฑุงุก**

โ **ุชู ุงูุชุทุจูู** - ุชู ุฅูุดุงุก ููู `lib/purchase-return-validation.ts`

**ุงููุธุงุฆู ุงููุถุงูุฉ:**
- `getProductStockInWarehouse()` - ุญุณุงุจ ุฑุตูุฏ ููุชุฌ ูู ูุฎุฒู ูุนูู
- `validatePurchaseReturnStock()` - ุงูุชุญูู ูู ููุงูุฉ ุงูุฑุตูุฏ ูุฌููุน ุงูููุชุฌุงุช
- `formatStockShortageMessage()` - ุชูุณูู ุฑุณุงุฆู ุงูุฎุทุฃ

**ุงูุชูุงูู:**
```typescript
// ูู app/purchase-returns/new/page.tsx
const stockValidation = await validatePurchaseReturnStock(
  supabase,
  validItems,
  billWarehouseId,
  companyId
)

if (!stockValidation.success) {
  const errorMessage = formatStockShortageMessage(stockValidation.shortages, appLang)
  toastActionError(toast, "ุงูุญูุธ", "ุงููุฑุชุฌุน", errorMessage)
  return
}
```

---

### 2๏ธโฃ **ุงูุชูุซูู ุงูุดุงูู**

โ **ุชู ุงูุชุทุจูู** - ุชู ุฅูุดุงุก ููู `docs/RETURNS_BRANCH_WAREHOUSE_RULES.md`

**ุงููุญุชูู:**
- ุงูููุงุนุฏ ุงูุฅูุฒุงููุฉ ููุฑุชุฌุนุงุช ุงูุจูุน ูุงูุดุฑุงุก
- ุขููุงุช ุงูุญูุงูุฉ ูุงูุชุญูู
- ุฌุฏูู ุงูููุงุฑูุฉ
- ุงูุฃุฎุทุงุก ุงูุดุงุฆุนุฉ ูููููุฉ ุชุฌูุจูุง
- ุญุงูุงุช ุงูุงุฎุชุจุงุฑ

---

## ๐ ุงูุญุงูุฉ ุงูููุงุฆูุฉ

| ุงูููุฒุฉ | ุงูุญุงูุฉ ูุจู | ุงูุญุงูุฉ ุจุนุฏ | ุงูุชุญุณูู |
|--------|-----------|-----------|---------|
| ุฑุจุท ูุฑุชุฌุนุงุช ุงูุจูุน ุจุงููุฑูุน | โ ููุฌูุฏ | โ ููุฌูุฏ | - |
| ุฑุจุท ูุฑุชุฌุนุงุช ุงูุดุฑุงุก ุจุงููุฑูุน | โ ููุฌูุฏ | โ ููุฌูุฏ | - |
| ุงูุชุญูู ูู ุงูุฑุตูุฏ (ุดุฑุงุก) | โ ููููุฏ | โ ูุทุจู | ๐ฏ ุฌุฏูุฏ |
| ุงูุชูุซูู ุงูุดุงูู | โ ููููุฏ | โ ูุทุจู | ๐ฏ ุฌุฏูุฏ |
| ุฑุณุงุฆู ุฎุทุฃ ูุงุถุญุฉ | โ๏ธ ุนุงูุฉ | โ ููุตูุฉ | ๐ฏ ูุญุณูู |

---

## ๐ฏ ุงููุชูุฌุฉ ุงูููุงุฆูุฉ

**ุงูุญุงูุฉ ุงูุนุงูุฉ:** ๐ข **ููุชุงุฒ**

โ **ุงูุฅูุฌุงุฒุงุช:**
- ูุธุงู ูุฑุชุฌุนุงุช ูุชูุงูู ูุน ุฑุจุท ูุงูู ุจุงููุฑูุน ูุงููุฎุงุฒู
- ุงูุชุญูู ูู ุงูุฑุตูุฏ ูุจู ูุฑุชุฌุนุงุช ุงูุดุฑุงุก
- ุชูุซูู ุดุงูู ููููุงุนุฏ ูุงูููุงุฑุณุงุช
- ุฑุณุงุฆู ุฎุทุฃ ูุงุถุญุฉ ูููุตูุฉ

๐ **ุงููููุงุช ุงููุถุงูุฉ:**
1. `lib/purchase-return-validation.ts` - ุฏูุงู ุงูุชุญูู ูู ุงูุฑุตูุฏ
2. `docs/RETURNS_BRANCH_WAREHOUSE_RULES.md` - ุงูุชูุซูู ุงูุดุงูู
3. `docs/RETURNS_BRANCH_ENFORCEMENT_AUDIT.md` - ุชูุฑูุฑ ุงููุฑุงุฌุนุฉ (ูุฐุง ุงูููู)

๐ง **ุงููููุงุช ุงููุนุฏูุฉ:**
1. `app/purchase-returns/new/page.tsx` - ุฅุถุงูุฉ ุงูุชุญูู ูู ุงูุฑุตูุฏ

---

**ุชุงุฑูุฎ ุงูุฅูุฌุงุฒ:** 2026-01-03
**ุงูุญุงูุฉ:** โ ููุชูู

