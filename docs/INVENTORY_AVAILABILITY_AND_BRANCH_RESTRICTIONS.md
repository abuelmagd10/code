# ๐ ุฏููู: ุงูุชุญูู ูู ุงููุฎุฒูู ูุงููููุฏ ุนูู ุงููุฑูุน

## ๐ฏ ุงููุฏู
ุชูุถูุญ ูุง ูุญุฏุซ ุนูุฏ ูุญุงููุฉ ุฅูุดุงุก ุฃูุฑ ุจูุน ุฃู ูุงุชูุฑุฉ ุจูุน ุนูุฏูุง ูููู ุงููุฎุฒูู ุบูุฑ ูุงูู ูู ุงููุฑุน ุฃู ุงูุดุฑูุฉ ุงูุญุงููุฉ.

---

## ๐ ุงููุถุน ุงูุญุงูู ูู ุงููุธุงู

### 1๏ธโฃ **ุงูุชุญูู ูู ุงููุฎุฒูู**

#### ุนูุฏ ุฅุฑุณุงู ูุงุชูุฑุฉ ุจูุน (Sent):
- โ **ูุชู ุงูุชุญูู ุชููุงุฆูุงู** ูู ุชููุฑ ุงููุฎุฒูู ูุจู ุงูุฅุฑุณุงู
- โ **ุงูุชุญูู ูุชู ุนูู ูุณุชูู**:
  - ุงูุดุฑูุฉ (`company_id`)
  - ุงููุฑุน (`branch_id`)
  - ุงููุฎุฒู (`warehouse_id`)
  - ูุฑูุฒ ุงูุชูููุฉ (`cost_center_id`)
- โ **ุฅุฐุง ูุงู ุงููุฎุฒูู ุบูุฑ ูุงูู**: ูุชู **ููุน ุงูุฅุฑุณุงู** ูุฅุธูุงุฑ ุฑุณุงูุฉ ุฎุทุฃ ุชูุถุญ:
  - ุงูููุชุฌุงุช ุงูุชู ูุง ููุฌุฏ ููุง ูุฎุฒูู ูุงูู
  - ุงููููุฉ ุงููุทููุจุฉ
  - ุงููููุฉ ุงููุชุงุญุฉ
  - ุงููููุฉ ุงููุงูุตุฉ

#### ุงูููุฏ ุงููุณุคูู:
```typescript
// app/invoices/[id]/page.tsx - ุงูุณุทุฑ 450-520
if (newStatus === "sent") {
  // ุงูุชุญูู ูู ุชููุฑ ุงููุฎุฒูู
  const { success, shortages } = await checkInventoryAvailability(
    supabase, 
    itemsToCheck, 
    undefined, 
    inventoryContext
  )
  
  if (!success) {
    // ููุน ุงูุฅุฑุณุงู ูุฅุธูุงุฑ ุฑุณุงูุฉ ุฎุทุฃ
    toast({ variant: "destructive", title, description })
    return
  }
}
```

---

### 2๏ธโฃ **ุงููููุฏ ุนูู ุงููุฑูุน ูุงููุฎุงุฒู**

#### ูููุณุชุฎุฏููู ุงูุนุงุฏููู:
- โ **ูุง ูููู ุชุบููุฑ ุงููุฑุน**: ูุฌุจ ุงุณุชุฎุฏุงู ุงููุฑุน ุงููุญุฏุฏ ูููุณุชุฎุฏู
- โ **ูุง ูููู ุชุบููุฑ ุงููุฎุฒู**: ูุฌุจ ุงุณุชุฎุฏุงู ุงููุฎุฒู ุงูุงูุชุฑุงุถู ูููุฑุน
- โ **ูุง ูููู ุชุบููุฑ ูุฑูุฒ ุงูุชูููุฉ**: ูุฌุจ ุงุณุชุฎุฏุงู ูุฑูุฒ ุงูุชูููุฉ ุงูุงูุชุฑุงุถู ูููุฑุน
- โ **ุงูููุท**: `User โ Branch โ Defaults` (ุชููุงุฆู)

#### ูููุฏุฑุงุก (Admins/Managers):
- โ **ูููู ุชุบููุฑ ุงููุฑุน**: ูููู ุงุฎุชูุงุฑ ูุฑุน ูุฎุชูู
- โ **ูููู ุชุบููุฑ ุงููุฎุฒู**: ูููู ุงุฎุชูุงุฑ ูุฎุฒู ูุฎุชูู
- โ **ูููู ุชุบููุฑ ูุฑูุฒ ุงูุชูููุฉ**: ูููู ุงุฎุชูุงุฑ ูุฑูุฒ ุชูููุฉ ูุฎุชูู
- โ๏ธ **ููู**: ุงูุชุญูู ูู ุงููุฎุฒูู ูุชู ุนูู ุงููุฑุน/ุงููุฎุฒู ุงููุญุฏุฏ

#### ุงูููุฏ ุงููุณุคูู:
```typescript
// lib/validation.ts - ุงูุณุทุฑ 1558-1617
export function validateSalesOrderCreation(
  userContext: UserContext,
  orderBranchId: string | null,
  orderCostCenterId: string | null,
  orderWarehouseId: string | null,
  lang: 'ar' | 'en' = 'ar'
): ValidationResult {
  const canOverride = ERP_ACCESS_CONTROL_RULES.OVERRIDE_ALLOWED_ROLES.includes(
    userContext.role as any
  );
  
  // ูููุณุชุฎุฏููู ุงูุนุงุฏููู: ููุน ุชุบููุฑ ุงููุฑุน
  if (!canOverride && userContext.branch_id && orderBranchId && 
      orderBranchId !== userContext.branch_id) {
    return {
      isValid: false,
      error: {
        title: 'ูุฑุน ุบูุฑ ุตุงูุญ',
        description: 'ูุฌุจ ุฅูุดุงุก ุฃูุฑ ุงูุจูุน ูู ูุฑุนู ุงููุญุฏุฏ'
      }
    };
  }
  // ... ููุณ ุงูุดูุก ูููุฎุฒู ููุฑูุฒ ุงูุชูููุฉ
}
```

---

## โ **ูุง ูุง ูููู ูุนูู ุญุงููุงู**

### 1. **ูุง ูููู ุงุณุชุฎุฏุงู ูุฎุฒูู ูู ูุฑุน ุขุฎุฑ ุชููุงุฆูุงู**
- โ ุงููุธุงู **ูุง ูุจุญุซ ุชููุงุฆูุงู** ุนู ูุฎุฒูู ูู ูุฑูุน ุฃุฎุฑู
- โ ุงููุธุงู **ูุง ููุชุฑุญ** ุงุณุชุฎุฏุงู ูุฎุฒูู ูู ูุฑุน ุขุฎุฑ
- โ ุงููุธุงู **ูุง ูููู ุชููุงุฆูุงู** ุงููุฎุฒูู ูู ูุฑุน ูุขุฎุฑ

### 2. **ูุง ูููู ุงุณุชุฎุฏุงู ูุฎุฒูู ูู ุดุฑูุฉ ุฃุฎุฑู**
- โ ุงููุธุงู **ูุง ูุณูุญ** ุจุงุณุชุฎุฏุงู ูุฎุฒูู ูู ุดุฑูุฉ ุฃุฎุฑู
- โ ูู ุดุฑูุฉ ููุง ูุฎุฒูููุง ุงููุณุชูู

### 3. **ูุง ูููู ุชุฌุงูุฒ ุงูุชุญูู ูู ุงููุฎุฒูู**
- โ ุงููุธุงู **ูุง ูุณูุญ** ุจุฅูุดุงุก ูุงุชูุฑุฉ ุจูุน ุจุฏูู ูุฎุฒูู ูุงูู
- โ ูุง ููุฌุฏ ุฎูุงุฑ "ุงูุณูุงุญ ุจุงููุฎุฒูู ุงูุณุงูุจ" (`allowNegative`)

---

## โ **ูุง ูููู ูุนูู ุญุงููุงู**

### 1. **ููู ุงููุฎุฒูู ุจูู ุงููุฎุงุฒู (Inventory Transfers)**
- โ ูููู ุฅูุดุงุก **ุทูุจ ููู** ูู ูุฎุฒู ูุขุฎุฑ
- โ ูููู ููู ุงููุฎุฒูู ูู ูุฑุน ูุขุฎุฑ (ุฅุฐุง ูุงู ูุฏูู ุตูุงุญูุงุช)
- โ ุจุนุฏ ุงููููุ ูููู ุฅูุดุงุก ุฃูุฑ ุงูุจูุน ุฃู ุงููุงุชูุฑุฉ

#### ุฎุทูุงุช ุงูุญู:
1. **ุฅูุดุงุก ุทูุจ ููู** (`/inventory-transfers/new`)
2. **ุงุฎุชูุงุฑ ุงููุฎุฒู ุงููุตุฏุฑ** (ุงูุฐู ุจู ุงููุฎุฒูู)
3. **ุงุฎุชูุงุฑ ุงููุฎุฒู ุงููุฌูุฉ** (ุงููุฑุน ุงูุญุงูู)
4. **ุจุฏุก ุงูููู** (ุฎุตู ูู ุงููุตุฏุฑ)
5. **ุงุนุชูุงุฏ ุงูุงุณุชูุงู** (ุฅุถุงูุฉ ูููุฌูุฉ)
6. **ุฅูุดุงุก ุฃูุฑ ุงูุจูุน ุฃู ุงููุงุชูุฑุฉ** ุจุนุฏ ูุตูู ุงููุฎุฒูู

### 2. **ุชุบููุฑ ุงููุฑุน (ูููุฏุฑุงุก ููุท)**
- โ ุงููุฏุฑุงุก ูููููู **ุชุบููุฑ ุงููุฑุน** ุนูุฏ ุฅูุดุงุก ุฃูุฑ ุจูุน ุฃู ูุงุชูุฑุฉ
- โ ูููู ุงุฎุชูุงุฑ ูุฑุน ุขุฎุฑ ูุฏูู ูุฎุฒูู ูุงูู
- โ๏ธ **ููู**: ูุฌุจ ุฃู ูููู ูุฏูู ุตูุงุญูุงุช ุนูู ูุฐุง ุงููุฑุน

---

## ๐ **ููู ูุนูู ุงูุชุญูู ูู ุงููุฎุฒูู**

### ุงูุฏุงูุฉ ุงููุณุคููุฉ:
```typescript
// lib/inventory-check.ts
export async function checkInventoryAvailability(
  supabase: SupabaseClient,
  items: InventoryItem[],
  excludeInvoiceId?: string,
  context?: InventoryCheckContext
): Promise<InventoryCheckResult>
```

### ูุง ูุชู ูุญุตู:
1. **ุฌูุจ ุฌููุน ุญุฑูุงุช ุงููุฎุฒูู** ููููุชุฌ ูู:
   - ููุณ ุงูุดุฑูุฉ
   - ููุณ ุงููุฑุน
   - ููุณ ุงููุฎุฒู
   - ููุณ ูุฑูุฒ ุงูุชูููุฉ (ูุน ุงุณุชุซูุงุกุงุช ูู transfer_in/transfer_out)

2. **ุญุณุงุจ ุงูุฑุตูุฏ ุงููุชุงุญ**:
   ```typescript
   const totalAvailable = transactions.reduce((sum, tx) => {
     return sum + tx.quantity_change
   }, 0)
   ```

3. **ููุงุฑูุฉ ูุน ุงููููุฉ ุงููุทููุจุฉ**:
   ```typescript
   if (totalAvailable < requested) {
     shortages.push({
       product_id,
       requested,
       available: totalAvailable,
       shortage: requested - totalAvailable
     })
   }
   ```

---

## ๐ **ุณููุงุฑูููุงุช ูุญููู**

### ุงูุณููุงุฑูู 1: ูุฎุฒูู ุบูุฑ ูุงูู ูู ุงููุฑุน ุงูุญุงูู

#### ุงููุดููุฉ:
- ุงููุณุชุฎุฏู ูู **ุงููุฑุน A**
- ุงููุฎุฒูู ูู **ุงููุฑุน A** ุบูุฑ ูุงูู
- ูุฑูุฏ ุฅูุดุงุก ูุงุชูุฑุฉ ุจูุน

#### ุงูุญููู ุงููุชุงุญุฉ:

##### ุงูุญู 1: ููู ุงููุฎุฒูู (ูููุณุชุฎุฏููู ุงูุนุงุฏููู)
1. ุฅูุดุงุก ุทูุจ ููู ูู **ุงููุฑุน B** (ุงูุฐู ุจู ุงููุฎุฒูู) ุฅูู **ุงููุฑุน A**
2. ุงูุชุธุงุฑ ุงุนุชูุงุฏ ุงูุงุณุชูุงู
3. ุฅูุดุงุก ุงููุงุชูุฑุฉ ุจุนุฏ ูุตูู ุงููุฎุฒูู

##### ุงูุญู 2: ุชุบููุฑ ุงููุฑุน (ูููุฏุฑุงุก ููุท)
1. ุชุบููุฑ ุงููุฑุน ุฅูู **ุงููุฑุน B** ุนูุฏ ุฅูุดุงุก ุงููุงุชูุฑุฉ
2. ุฅูุดุงุก ุงููุงุชูุฑุฉ ูุจุงุดุฑุฉ ูู **ุงููุฑุน B**

---

### ุงูุณููุงุฑูู 2: ูุฎุฒูู ุบูุฑ ูุงูู ูู ุงููุฎุฒู ุงูุญุงูู

#### ุงููุดููุฉ:
- ุงููุณุชุฎุฏู ูู **ุงููุฎุฒู 1**
- ุงููุฎุฒูู ูู **ุงููุฎุฒู 1** ุบูุฑ ูุงูู
- ููุฌุฏ ูุฎุฒูู ูู **ุงููุฎุฒู 2** (ููุณ ุงููุฑุน)

#### ุงูุญููู ุงููุชุงุญุฉ:

##### ุงูุญู 1: ููู ุงููุฎุฒูู
1. ุฅูุดุงุก ุทูุจ ููู ูู **ุงููุฎุฒู 2** ุฅูู **ุงููุฎุฒู 1**
2. ุงูุชุธุงุฑ ุงุนุชูุงุฏ ุงูุงุณุชูุงู
3. ุฅูุดุงุก ุงููุงุชูุฑุฉ

##### ุงูุญู 2: ุชุบููุฑ ุงููุฎุฒู (ูููุฏุฑุงุก ููุท)
1. ุชุบููุฑ ุงููุฎุฒู ุฅูู **ุงููุฎุฒู 2** ุนูุฏ ุฅูุดุงุก ุงููุงุชูุฑุฉ
2. ุฅูุดุงุก ุงููุงุชูุฑุฉ ูุจุงุดุฑุฉ ูู **ุงููุฎุฒู 2**

---

## ๐ **ุชุญุณููุงุช ููุชุฑุญุฉ (ูููุณุชูุจู)**

### 1. **ุงูุชุฑุงุญ ุชููุงุฆู ูููุฎุงุฒู ุงูุจุฏููุฉ**
- ๐ ุงูุจุญุซ ุชููุงุฆูุงู ุนู ูุฎุงุฒู ุฃุฎุฑู ูุฏููุง ูุฎุฒูู ูุงูู
- ๐ ุนุฑุถ ูุงุฆูุฉ ุจุงููุฎุงุฒู ุงูุจุฏููุฉ
- ๐ ุฅููุงููุฉ ุชุบููุฑ ุงููุฎุฒู ูุจุงุดุฑุฉ ูู ุฑุณุงูุฉ ุงูุฎุทุฃ

### 2. **ููู ุชููุงุฆู ูููุฎุฒูู**
- ๐ ุงูุชุฑุงุญ ููู ุงููุฎุฒูู ุชููุงุฆูุงู ูู ูุฎุฒู ุขุฎุฑ
- ๐ ุฅูุดุงุก ุทูุจ ููู ุชููุงุฆูุงู
- ๐ ุงูุชุธุงุฑ ุงูุงุณุชูุงู ุซู ุฅููุงู ุงููุงุชูุฑุฉ

### 3. **ูุถุน "ุงูุณูุงุญ ุจุงููุฎุฒูู ุงูุณุงูุจ"**
- ๐ ุฅุถุงูุฉ ุฎูุงุฑ ููุณูุงุญ ุจุฅูุดุงุก ูุงุชูุฑุฉ ุจุฏูู ูุฎุฒูู ูุงูู
- ๐ ุชุณุฌูู ุงููุฎุฒูู ุงูุณุงูุจ ูุงูุชุฒุงู
- ๐ ุชูุจููุงุช ุนูุฏ ูุฌูุฏ ูุฎุฒูู ุณุงูุจ

### 4. **ุฏูุฌ ุงููุฎุงุฒู ูู ูุฑูุน ูุชุนุฏุฏุฉ**
- ๐ ุงูุจุญุซ ูู ุฌููุน ุงููุฑูุน ุงูุชู ูุฏูู ุตูุงุญูุงุช ุนูููุง
- ๐ ุนุฑุถ ุงููุฎุฒูู ุงููุชุงุญ ูู ูู ูุฑุน
- ๐ ุฅููุงููุฉ ุงุฎุชูุงุฑ ุงููุฑุน ูุจุงุดุฑุฉ

---

## ๐ **ููุฎุต**

### โ **ูุง ูุนููู ุงููุธุงู ุญุงููุงู:**
1. โ ูุชุญูู ูู ุงููุฎุฒูู ูุจู ุฅุฑุณุงู ุงููุงุชูุฑุฉ
2. โ ูููุน ุงูุฅุฑุณุงู ุฅุฐุง ูุงู ุงููุฎุฒูู ุบูุฑ ูุงูู
3. โ ูุนุฑุถ ุฑุณุงูุฉ ุฎุทุฃ ููุตูุฉ ุจุงูููุชุฌุงุช ุงููุงูุตุฉ
4. โ ููุฑุถ ูููุฏ ุนูู ุงููุฑูุน ูุงููุฎุงุฒู ูููุณุชุฎุฏููู ุงูุนุงุฏููู
5. โ ูุณูุญ ูููุฏุฑุงุก ุจุชุบููุฑ ุงููุฑุน/ุงููุฎุฒู

### โ **ูุง ูุง ูุนููู ุงููุธุงู ุญุงููุงู:**
1. โ ูุง ูุจุญุซ ุชููุงุฆูุงู ุนู ูุฎุฒูู ูู ูุฑูุน ุฃุฎุฑู
2. โ ูุง ููุชุฑุญ ุงุณุชุฎุฏุงู ูุฎุฒูู ูู ูุฑุน ุขุฎุฑ
3. โ ูุง ูููู ุชููุงุฆูุงู ุงููุฎุฒูู ุจูู ุงููุฑูุน
4. โ ูุง ูุณูุญ ุจุฅูุดุงุก ูุงุชูุฑุฉ ุจุฏูู ูุฎุฒูู ูุงูู

### ๐ง **ุงูุญููู ุงููุชุงุญุฉ:**
1. โ **ููู ุงููุฎุฒูู**: ุฅูุดุงุก ุทูุจ ููู ูุฏููุงู
2. โ **ุชุบููุฑ ุงููุฑุน**: ูููุฏุฑุงุก ููุท
3. โ **ุชุบููุฑ ุงููุฎุฒู**: ูููุฏุฑุงุก ููุท

---

## ๐ **ูููุงุช ุฐุงุช ุตูุฉ**

- `lib/inventory-check.ts` - ุฏุงูุฉ ุงูุชุญูู ูู ุงููุฎุฒูู
- `app/invoices/[id]/page.tsx` - ุตูุญุฉ ุชูุงุตูู ุงููุงุชูุฑุฉ (ุงูุชุญูู ุนูุฏ ุงูุฅุฑุณุงู)
- `lib/validation.ts` - ุงูุชุญูู ูู ุตุญุฉ ุงููุฑุน/ุงููุฎุฒู
- `app/inventory-transfers/` - ุตูุญุงุช ููู ุงููุฎุฒูู
- `GOVERNANCE.md` - ููุงุนุฏ ุงูุญูููุฉ ูุงููููุฏ

---

**ุขุฎุฑ ุชุญุฏูุซ**: 2026-01-26
