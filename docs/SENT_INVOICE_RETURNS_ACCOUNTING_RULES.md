# ูุนุงูุฌุฉ ูุฑุชุฌุนุงุช ููุงุชูุฑ ุงููุจูุนุงุช (Sent Invoices) - ุงููุชุทูุจุงุช ุงููุญุงุณุจูุฉ ุงูุตุงุฑูุฉ

## ๐ฏ ุงููุฏู
ุถูุงู ูุนุงูุฌุฉ ูุฑุชุฌุนุงุช ุงูููุงุชูุฑ ุงููุฑุณูุฉ (Sent) ุจุทุฑููุฉ ูุญุงุณุจูุฉ ุตุญูุญุฉ ููุชูุงููุฉ ูุน ูุนุงููุฑ ERP ุงูุงุญุชุฑุงููุฉ.

---

## โ๏ธ ุชูุจูู ูุงู ุฌุฏุงู

ุนูุฏ ุญุฏูุซ ูุฑุชุฌุน ุฌุฒุฆู ุฃู ููู ุนูู ูุงุชูุฑุฉ ูุจูุนุงุช ุญุงูุชูุง **ูุฑุณูุฉ (Sent)** ูุฌุจ ุงูุงูุชุฒุงู ุจุงูุขุชู ุจุฏูุฉ ุชุงูุฉ:

---

## โ ุงููุณููุญ ููุท

### 1. ุชุนุฏูู ุจูุงูุงุช ุงููุงุชูุฑุฉ ููุณูุง
- ุชุญุฏูุซ ุงููููุงุช ูู `invoice_items.returned_quantity`
- ุชุญุฏูุซ ุงูุตุงูู `invoices.subtotal`
- ุชุญุฏูุซ ุงูุถุฑูุจุฉ `invoices.tax_amount`
- ุชุญุฏูุซ ุงูุฅุฌูุงูู `invoices.total_amount`
- ูุฌุจ ุฃู ููุฎูุถ ุฅุฌูุงูู ุงููุงุชูุฑุฉ ุจูุง ูุชูุงุณุจ ูุน ูููุฉ ุงููุฑุชุฌุน ููุท

### 2. ุชุญุฏูุซ ุฐูู ุงูุนููู (AR)
- ุชุนุฏูู ุฑุตูุฏ ุงูุนููู ูู ุงูููุฏ ุงูุฃุตูู (ุฅุฐุง ูุฌุฏ) ููุนูุณ ุงููููุฉ ุงูุตุญูุญุฉ ุจุนุฏ ุงููุฑุชุฌุน
- ุชุฎููุถ ุงููุจูุบ ุงููุณุชุญู ุนูู ุงูุนููู ุจุฏูุฉ ุฏูู ุฃู ุฒูุงุฏุงุช ุฃู ุงุฒุฏูุงุฌ
- ุชุญุฏูุซ ุณุทุฑ AR ูู `journal_entry_lines` ููููุฏ ุงูุฃุตูู

### 3. ุชุญุฏูุซ ุญุฑูุงุช ุงููุฎุฒูู
- ุฅูุดุงุก ุญุฑูุฉ ูุฎุฒูู ูู ููุน `sale_return` ูุงุณุชุฑุฌุงุน ุงููููุงุช
- ุฑุจุท ุงูุญุฑูุฉ ุจุงููุงุชูุฑุฉ ุงูุฃุตููุฉ (ูููุณ ุจููุฏ ูููุตู)

---

## ๐ซ ููููุน ุชูุงูุงู

### โ ุนุฏู ุฅูุดุงุก ุฃู ููุฏ ูุงูู ุฌุฏูุฏ ูู ูุฐู ุงููุฑุญูุฉ
- ูุง ูุชู ุฅูุดุงุก ููุฏ ูู ููุน `sales_return`
- ูุง ูุชู ุฅูุดุงุก ุฃู ููุฏ ูุญุงุณุจู ุฌุฏูุฏ ุนูู ุงูุฅุทูุงู

### โ ุนุฏู ุฅูุดุงุก ููุฏ Cash
- ูุง ูุชู ุฅูุดุงุก ุฃู ูููุฏ ููุฏูุฉ
- ูุง ูุชู ุงููุณุงุณ ุจุญุณุงุจุงุช ุงูููุฏ ุฃู ุงูุจูู

### โ ุนุฏู ุฅูุดุงุก ููุฏ COGS
- ูุง ูุชู ุฅูุดุงุก ูููุฏ ุชูููุฉ ุงูุจุถุงุนุฉ ุงููุจุงุนุฉ
- ูุง ูุชู ุงููุณุงุณ ุจุญุณุงุจุงุช ุงููุฎุฒูู ูู ุงููููุฏ ุงููุญุงุณุจูุฉ

### โ ุนุฏู ุฅูุดุงุก ููุฏ Revenue ุฅุถุงูู
- ูุง ูุชู ุฅูุดุงุก ูููุฏ ุฅูุฑุงุฏ ุฌุฏูุฏุฉ
- ูุชู ููุท ุชุญุฏูุซ ุงูููุฏ ุงูุฃุตูู (ุฅุฐุง ูุฌุฏ)

### โ ุนุฏู ุงููุณุงุณ ุจุฃู ููุงุชูุฑ ุฃู ูููุฏ ุฃุฎุฑู ุบูุฑ ุงููุงุชูุฑุฉ ูุญู ุงููุฑุชุฌุน
- ุงูุชุนุฏููุงุช ุชูุชุตุฑ ุนูู ุงููุงุชูุฑุฉ ุงููุญุฏุฏุฉ ููุท
- ูุง ูุชู ุชุนุฏูู ุฃู ููุงุชูุฑ ุฃุฎุฑู

---

## ๐ ุงูุงูุชุฒุงู ุงููุญุงุณุจู ุงูุตุงุฑู

### 1. ุงูุญูุงุธ ุนูู ุงูููุท ุงููุญุงุณุจู ุงูุฃุตูู
- ุงููุฑุชุฌุน ูู ุญุงูุฉ Sent ูู **ุชุตุญูุญ ูููุงุชูุฑุฉ** ูููุณ ุญุฏุซุงู ูุงููุงู ูุณุชููุงู
- ูุชู ุงูุชุนุงูู ูุนู ูุชุนุฏูู ุนูู ุงููุงุชูุฑุฉ ุงูุฃุตููุฉ

### 2. ุงููุฏู ุงูููุงุฆู
- ุงููุงุชูุฑุฉ ุชุนูุณ ุงูููู ุงูุตุญูุญุฉ ููุท
- ุฐูู ุงูุนููุงุก ุฏูููุฉ ููุญุฏุซุฉ
- ูุง ุชูุฌุฏ ูููุฏ ูุฒุฏูุฌุฉ ุฃู ุฎุงุทุฆุฉ
- ุงููุธุงู ูุชูุงูู ูุน ERP ุงุญุชุฑุงูู ุจุฏูู ุฃุฎุทุงุก ูุญุงุณุจูุฉ

---

## ๐ฏ ุงููุชูุฌุฉ ุงููุทููุจุฉ

โ ุงููุงุชูุฑุฉ ุตุญูุญุฉ ุจุงููููุฉ ุงูููุงุฆูุฉ  
โ ุฐูู ุงูุนููุงุก ุฏูููุฉ  
โ ูุง ุชูุฌุฏ ูููุฏ ูุฒุฏูุฌุฉ ุฃู ุฎุงุทุฆุฉ  
โ ุงููุธุงู ูุชูุงูู ูุน ERP ุงุญุชุฑุงูู ุจุฏูู ุฃุฎุทุงุก ูุญุงุณุจูุฉ

---

## ๐ง ุงูุชุทุจูู ุงูุชููู

### 1. API ุงููุนุงูุฌุฉ ุงูุฌุฏูุฏ
**ุงููุณุงุฑ:** `/api/process-sent-invoice-return`

**ุงููุธููุฉ:**
- ูุนุงูุฌุฉ ูุฑุชุฌุนุงุช ุงูููุงุชูุฑ ุงููุฑุณูุฉ ูููุงู ูููุชุทูุจุงุช ุงูุตุงุฑูุฉ
- ุชุญุฏูุซ ุจูุงูุงุช ุงููุงุชูุฑุฉ ูุงูููุฏ ุงูุฃุตูู ููุท
- ุนุฏู ุฅูุดุงุก ุฃู ูููุฏ ุฌุฏูุฏุฉ

**ุงููุฏุฎูุงุช:**
```json
{
  "invoice_id": "uuid",
  "return_items": [
    {
      "item_id": "uuid",
      "returned_quantity": 5
    }
  ],
  "return_number": "RET-INV-0001"
}
```

**ุงููุฎุฑุฌุงุช:**
```json
{
  "success": true,
  "message": "ุชู ูุนุงูุฌุฉ ุงููุฑุชุฌุน ุจูุฌุงุญ",
  "invoice_id": "uuid",
  "invoice_number": "INV-0001",
  "return_amount": 1000,
  "new_invoice_total": 4000,
  "entry_updated": true,
  "items_processed": 2
}
```

### 2. API ุงูุฅุตูุงุญ (ููุจูุงูุงุช ุงููุฏููุฉ)
**ุงููุณุงุฑ:** `/api/fix-invoice-return-sent`

**ุงููุธููุฉ:**
- ุฅุตูุงุญ ูุฑุชุฌุนุงุช ูุฏููุฉ ุชู ูุนุงูุฌุชูุง ุจุทุฑููุฉ ุฎุงุทุฆุฉ
- ุญุฐู ูููุฏ `sales_return` ุงููุฏููุฉ
- ุชุญุฏูุซ ุงูููุฏ ุงูุฃุตูู ูุงููุงุชูุฑุฉ ุจุงูููู ุงูุตุญูุญุฉ

### 3. ูุงุฌูุฉ ุงููุณุชุฎุฏู
**ุงููุณุงุฑ:** `/sent-invoice-returns`

**ุงููุธููุฉ:**
- ูุงุฌูุฉ ุจุณูุทุฉ ููุนุงูุฌุฉ ูุฑุชุฌุนุงุช ุงูููุงุชูุฑ ุงููุฑุณูุฉ
- ุนุฑุถ ุชุญุฐูุฑ ูุงุถุญ ุจุงููุชุทูุจุงุช ุงููุญุงุณุจูุฉ
- ุฅุฏุฎุงู ูููุงุช ุงููุฑุชุฌุน ูุญุณุงุจ ุงูููู ุชููุงุฆูุงู

---

## ๐ ูุซุงู ุนููู

### ุงูุญุงูุฉ ุงูุฃูููุฉ
**ูุงุชูุฑุฉ INV-0001 (Sent):**
- ุงููุฌููุน ุงููุฑุนู: 5000
- ุงูุถุฑูุจุฉ: 750
- ุงูุฅุฌูุงูู: 5750
- ุงูุญุงูุฉ: sent

**ุงูููุฏ ุงูุฃุตูู (ุฅุฐุง ูุฌุฏ):**
```
Debit: AR (Accounts Receivable) = 5750
Credit: Revenue = 5000
Credit: VAT Payable = 750
```

### ุจุนุฏ ุงููุฑุชุฌุน (2 ููุชุฌุงุช ุจูููุฉ 1000)
**ูุงุชูุฑุฉ INV-0001 (ูุญุฏุซุฉ):**
- ุงููุฌููุน ุงููุฑุนู: 4000 (5000 - 1000)
- ุงูุถุฑูุจุฉ: 600 (750 - 150)
- ุงูุฅุฌูุงูู: 4600 (5750 - 1150)
- ุงููุฑุชุฌุน: 1150
- ุงูุญุงูุฉ: sent (ูู ุชุชุบูุฑ)

**ุงูููุฏ ุงูุฃุตูู (ูุญุฏุซ):**
```
Debit: AR (Accounts Receivable) = 4600 (ูุนุฏู ูููุฑุชุฌุน)
Credit: Revenue = 4000 (ูุนุฏู ูููุฑุชุฌุน)
Credit: VAT Payable = 600 (ูุนุฏู ูููุฑุชุฌุน)
```

**ุญุฑูุฉ ุงููุฎุฒูู:**
```
Type: sale_return
Quantity: +2
Reference: invoice (INV-0001)
Journal Entry: null ุฃู ุงูููุฏ ุงูุฃุตูู
```

---

## ๐ ุงููุฑู ุจูู ุงูููุงุชูุฑ ุงููุฑุณูุฉ ูุงููุฏููุนุฉ

### ูุงุชูุฑุฉ ูุฑุณูุฉ (Sent)
- โ ุชุญุฏูุซ ุงููุงุชูุฑุฉ ููุณูุง
- โ ุชุญุฏูุซ ุงูููุฏ ุงูุฃุตูู (ุฅุฐุง ูุฌุฏ)
- โ ุญุฑูุฉ ูุฎุฒูู ููุท
- โ ูุง ููุฏ ุฌุฏูุฏ
- โ ูุง Customer Credit

### ูุงุชูุฑุฉ ูุฏููุนุฉ (Paid/Partially Paid)
- โ ุชุญุฏูุซ ุงููุงุชูุฑุฉ
- โ ุฅูุดุงุก ููุฏ ูุญุงุณุจู ุฌุฏูุฏ (ุนูุณ ุงูุฐูู ูุงูุฅูุฑุงุฏ)
- โ ุญุฑูุฉ ูุฎุฒูู
- โ Customer Credit (ุฅุฐุง ุงููุฏููุน > ุตุงูู ุงููุงุชูุฑุฉ)

---

## ๐งช ุงุฎุชุจุงุฑ ุงูุงูุชุซุงู

### ูุงุฆูุฉ ุงูุชุญูู
- [ ] ูู ูุชู ุฅูุดุงุก ุฃู ููุฏ ุฌุฏูุฏ ูู ููุน `sales_return`
- [ ] ุชู ุชุญุฏูุซ ุงููุงุชูุฑุฉ ุจุงูููู ุงูุตุญูุญุฉ
- [ ] ุชู ุชุญุฏูุซ ุงูููุฏ ุงูุฃุตูู (ุฅุฐุง ูุฌุฏ) ุจุงูููู ุงูุตุญูุญุฉ
- [ ] ุชู ุฅูุดุงุก ุญุฑูุงุช ูุฎุฒูู ุตุญูุญุฉ
- [ ] ูู ูุชู ุฅูุดุงุก ูููุฏ COGS
- [ ] ูู ูุชู ุฅูุดุงุก ูููุฏ Cash
- [ ] ูู ูุชู ุฅูุดุงุก Customer Credit
- [ ] ุฐูู ุงูุนููุงุก ูุชูุงุฒูุฉ ูุฏูููุฉ

### ุงุณุชุนูุงู SQL ููุชุญูู
```sql
-- ุงูุชุญูู ูู ุนุฏู ูุฌูุฏ ูููุฏ sales_return ุฌุฏูุฏุฉ ููููุงุชูุฑ ุงููุฑุณูุฉ
SELECT 
  je.id,
  je.reference_type,
  je.description,
  i.status,
  i.invoice_number
FROM journal_entries je
JOIN invoices i ON je.reference_id = i.id
WHERE je.reference_type = 'sales_return'
  AND i.status = 'sent'
  AND je.created_at > '2024-01-01'; -- ุชุงุฑูุฎ ุชุทุจูู ุงูุชุญุฏูุซ

-- ูุฌุจ ุฃู ุชููู ุงููุชูุฌุฉ ูุงุฑุบุฉ
```

---

## ๐ ููุงุญุธุงุช ุฅุถุงููุฉ

1. **ุงูุชูุงูู ูุน ุงููุธุงู ุงููุฏูู:**
   - ูุชู ุงุณุชุฎุฏุงู `/api/fix-invoice-return-sent` ูุฅุตูุงุญ ุงูุจูุงูุงุช ุงููุฏููุฉ
   - ูุชู ุญุฐู ูููุฏ `sales_return` ุงูุฎุงุทุฆุฉ
   - ูุชู ุชุญุฏูุซ ุงููููุฏ ูุงูููุงุชูุฑ ุจุงูููู ุงูุตุญูุญุฉ

2. **ุงูุฃูุงู:**
   - ุฌููุน ุงูุนูููุงุช ุชุชุทูุจ ูุตุงุฏูุฉ
   - ุงูุชุญูู ูู ุตูุงุญูุงุช ุงููุณุชุฎุฏู
   - ุงูุชุญูู ูู ุญุงูุฉ ุงููุงุชูุฑุฉ ูุจู ุงููุนุงูุฌุฉ

3. **ุงูุฃุฏุงุก:**
   - ูุนุงูุฌุฉ ุฏูุนูุฉ ููุจููุฏ
   - ุชุญุฏูุซุงุช ูุญุณููุฉ ูููุงุนุฏุฉ
   - ุชุณุฌูู ุดุงูู ููุนูููุงุช

4. **ุงูุชุฏููู:**
   - ุชุณุฌูู ุฌููุน ุงูุชุบููุฑุงุช ูู audit_log
   - ุชุชุจุน ุงููุณุชุฎุฏู ูุงูุชุงุฑูุฎ
   - ุฅููุงููุฉ ุงูุชุฑุงุฌุน ุนู ุงูุชุบููุฑุงุช

---

## ๐ ุงูุฎุทูุงุช ุงูุชุงููุฉ

1. **ุงุฎุชุจุงุฑ ุดุงูู:**
   - ุงุฎุชุจุงุฑ ูุนุงูุฌุฉ ูุฑุชุฌุน ุฌุฒุฆู
   - ุงุฎุชุจุงุฑ ูุนุงูุฌุฉ ูุฑุชุฌุน ููู
   - ุงุฎุชุจุงุฑ ุฅุตูุงุญ ุงูุจูุงูุงุช ุงููุฏููุฉ

2. **ุงูุชูุซูู:**
   - ุชุญุฏูุซ ุฏููู ุงููุณุชุฎุฏู
   - ุฅุถุงูุฉ ุฃูุซูุฉ ุนูููุฉ
   - ุชูุซูู ุงูุฃุฎุทุงุก ุงูุดุงุฆุนุฉ

3. **ุงูุชุฏุฑูุจ:**
   - ุชุฏุฑูุจ ูุฑูู ุงููุญุงุณุจุฉ
   - ุชูุถูุญ ุงููุฑู ุจูู ุงูุญุงูุงุช ุงููุฎุชููุฉ
   - ุดุฑุญ ุงูููุท ุงููุญุงุณุจู ุงูุตุญูุญ

---

## ๐ ุงูุฏุนู

ูู ุญุงูุฉ ูุฌูุฏ ุฃู ุงุณุชูุณุงุฑุงุช ุฃู ูุดุงูู:
1. ูุฑุงุฌุนุฉ ูุฐุง ุงูููู ุฃููุงู
2. ุงูุชุญูู ูู ุณุฌูุงุช ุงููุธุงู (audit_log)
3. ุงุณุชุฎุฏุงู ุฃุฏูุงุช ุงูุฅุตูุงุญ ุงููุชููุฑุฉ
4. ุงูุชูุงุตู ูุน ูุฑูู ุงูุชุทููุฑ

---

**ุขุฎุฑ ุชุญุฏูุซ:** 2024
**ุงูุฅุตุฏุงุฑ:** 1.0
**ุงูุญุงูุฉ:** ูุดุท โ
