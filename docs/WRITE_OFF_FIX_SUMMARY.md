# โ ููุฎุต ุงูุญู ุงูุฌุฐุฑู ููุดููุฉ ุงูุฑุตูุฏ ุงููุชุงุญ ูู ุงูุฅููุงู

## ๐ ุงููุดููุฉ

ุนูุฏ ุญูุธ ุนูููุฉ ุงูุฅููุงู ุชุธูุฑ ุงูุฑุณุงูุฉ:
```
ูุง ูููู ุฅููุงู ุงููุฎุฒูู ุจุฏูู ุฑุตูุฏ ูุนูู
SKU: suk (1001)
ุงูุฑุตูุฏ ุงููุชุงุญ = 0
ุงููุทููุจ = 50
warehouse_id = 3ca544b-931b-46b0-b429-a9bb7889fa3
```

ุฑุบู ุฃู ุงูุตูู ููุฌูุฏ ูุนูููุง ูู ูุฎุฒูู ุงููุฑุน.

## ๐ฏ ุงูุณุจุจ ุงูุฌุฐุฑู

**ุงููุดููุฉ ุงูุฑุฆูุณูุฉ:** ุฏุงูุฉ `get_available_inventory_quantity` ูุง ุชุฌูุจ `cost_center_id` ูู `branch` ุชููุงุฆูุงู.

**ุงูุชูุงุตูู:**
- ุฅุฐุง ูุงู `cost_center_id` NULLุ ุงูุดุฑุท `(p_cost_center_id IS NULL OR cost_center_id = p_cost_center_id)` ููุจู ุฃู `cost_center_id`
- ูุฐุง ูุคุฏู ูุญุณุงุจ ุฎุงุทุฆ ููุฑุตูุฏ ูุฃูู ูุฌูุน transactions ูู ุฌููุน `cost_center_id` ูู ุงููุฑุน
- ูุฌุจ ุญุณุงุจ ุงูุฑุตูุฏ ุจูุงุกู ุนูู `cost_center_id` ุงููุฑุชุจุท ุจู `branch` ุงููุญุฏุฏ

## โ ุงูุญู ุงููุทุจู

### 1. ุชุญุฏูุซ SQL Functions

**ุงูููู:** `scripts/FIX_write_off_available_quantity_FINAL.sql`

**ุงูุชุบููุฑุงุช:**
- โ `get_available_inventory_quantity`: ุฌูุจ `branch_id` ู `cost_center_id` ุชููุงุฆูุงู
- โ `approve_write_off`: ุฌูุจ `cost_center_id` ูู `branch` ุชููุงุฆูุงู
- โ `validate_write_off_items`: ุฌูุจ `cost_center_id` ูู `branch` ุชููุงุฆูุงู
- โ `validate_write_off_approval`: ุฌูุจ `cost_center_id` ูู `branch` ุชููุงุฆูุงู
- โ ุฅูุดุงุก View `inventory_available_balance` ูุญุณุงุจ ุงูุฑุตูุฏ ุจุดูู ููุญุฏ
- โ ุฅุถุงูุฉ Indexes ูุชุญุณูู ุงูุฃุฏุงุก

### 2. ุชุญุฏูุซ TypeScript Functions

**ุงูููู:** `lib/write-off-governance.ts`

**ุงูุชุบููุฑุงุช:**
- โ `calculateAvailableQuantityFallback`: ุฌูุจ `cost_center_id` ูู `branch` ุชููุงุฆูุงู

### 3. ุชุญุฏูุซ API Route

**ุงูููู:** `app/api/write-off/validate/route.ts`

**ุงูุชุบููุฑุงุช:**
- โ ุฌูุจ `cost_center_id` ูู `branch` ุชููุงุฆูุงู ุฅุฐุง ูู ููู ูุญุฏุฏุงู

## ๐ ุฎุทูุงุช ุงูุชุทุจูู

1. **ุชุดุบูู SQL Script:**
   ```bash
   # ุชุดุบูู ุงูููู ุงูุชุงูู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
   scripts/FIX_write_off_available_quantity_FINAL.sql
   ```

2. **ุงูุชุญูู ูู ุงูุชุญุฏูุซ:**
   - ุชุญูู ูู ุฑุณุงุฆู NOTICE ูู SQL
   - ุชุฃูุฏ ูู ุชุญุฏูุซ ุฌููุน ุงูุฏูุงู ูุงูู Triggers

3. **ุงุฎุชุจุงุฑ ุงูุญู:**
   - ุฅูุดุงุก ุนูููุฉ ุฅููุงู ุฌุฏูุฏุฉ
   - ุงูุชุญูู ูู ุญุณุงุจ ุงูุฑุตูุฏ ุจุดูู ุตุญูุญ
   - ุงูุชุฃูุฏ ูู ูุจูู/ุฑูุถ ุงูุฅููุงู ุจูุงุกู ุนูู ุงูุฑุตูุฏ ุงููุนูู

## โ ุงููุชูุฌุฉ ุงููุชููุนุฉ

1. **ุญุณุงุจ ุฏููู ููุฑุตูุฏ:**
   - ูุชู ุญุณุงุจ ุงูุฑุตูุฏ ุจูุงุกู ุนูู `cost_center_id` ุงูุตุญูุญ ุงููุฑุชุจุท ุจู `branch`
   - ูุง ูุชู ุงูุฎูุท ุจูู ุฑุตูุฏ `cost_center_id` ูุฎุชูู

2. **ุชูุญูุฏ ุงูููุทู:**
   - ููุณ ุงูููุทู ูู SQL ู TypeScript
   - ููุณ ุงูููุทู ูู ุงููุงุฌูุฉ ุงูุฃูุงููุฉ ูุงูุฎูููุฉ

3. **ุญูููุฉ ุฃูุถู:**
   - ุงุญุชุฑุงู ุฑุจุท `warehouse` โ `branch` โ `cost_center`
   - ููุน ุงูุฅููุงู ูู `cost_center_id` ุฎุงุทุฆ

## ๐ ุถูุงูุงุช ุงูุญูููุฉ

- โ ุงูุฅููุงู ูุชู ููุท ูู ุงููุฎุฒู ุงููุฑุชุจุท ุจุงููุฑุน
- โ ูุญุชุฑู ุงูุญูููุฉ (`branch_id` / `warehouse_id` / `cost_center_id`)
- โ ูุง ูุนุชูุฏ ุนูู ุฑุตูุฏ ุนุงู ุฃู ูุฎุฒู ุงูุชุฑุงุถู
- โ ูุง ููุณุฑ ุงูุตูุงุญูุงุช ูุงููุฑูุน ููุฑุงูุฒ ุงูุชูููุฉ

## ๐ ุงููููุงุช ุงููุนุฏูุฉ

1. `scripts/FIX_write_off_available_quantity_FINAL.sql` - SQL Functions ู Triggers
2. `lib/write-off-governance.ts` - TypeScript Functions
3. `app/api/write-off/validate/route.ts` - API Route

## ๐ ุงููุซุงุฆู

- [ุงูุชูุซูู ุงููุงูู](./WRITE_OFF_AVAILABLE_QUANTITY_FIX_COMPLETE.md)
