# 📌 ERP Accounting & Inventory Core Logic
## (MANDATORY FINAL SPECIFICATION)

> **⚠️ هذا المستند هو المرجع الوحيد للنمط المحاسبي والمخزني داخل النظام، وأي تنفيذ يخالفه يُعتبر خطأ جسيم.**

---

## 🔹 أولاً: Sales Invoices (فواتير البيع)

### 1️⃣ Draft (مسودة)
| العنصر | الحالة |
|--------|--------|
| قيد محاسبي | ❌ لا |
| حركة مخزون | ❌ لا |
| تجهيز بيانات | ✔️ نعم |
| قابلة للتعديل | ✔️ نعم |
| تظهر في التقارير | ❌ لا |

### 2️⃣ Sent / Confirmed (مرسلة / منفذة)
| العنصر | الحالة |
|--------|--------|
| خصم المخزون (Stock Out) | ✔️ فوري |
| قيد محاسبي | ❌ لا |
| حركة مخزنية | ✔️ بدون أثر مالي |
| تعديل الأصناف/الكميات | ❌ ممنوع |

### 3️⃣ Paid / Partially Paid (مدفوعة)
| العنصر | الحالة |
|--------|--------|
| قيد محاسبي | ✔️ نعم (عند الدفع فقط) |
| خصم المخزون | ❌ ممنوع (تم في Sent) |
| تحديث ذمم العميل | ✔️ نعم |

#### 📊 القيود المحاسبية عند الدفع (فواتير البيع):

```
┌─────────────────────────────────────────────────────────────────┐
│ 1️⃣ قيد الفاتورة (مرة واحدة - بإجمالي الفاتورة الكامل):        │
├─────────────────────────────────────────────────────────────────┤
│ reference_type: "invoice"                                       │
│ ─────────────────────────────────────────────────────────────── │
│ Debit:  الذمم المدينة (AR)      ← إجمالي الفاتورة              │
│ Credit: المبيعات (Revenue)       ← إجمالي الفاتورة              │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│ 2️⃣ قيد السداد (مع كل دفعة - بالمبلغ المدفوع):                 │
├─────────────────────────────────────────────────────────────────┤
│ reference_type: "invoice_payment"                               │
│ ─────────────────────────────────────────────────────────────── │
│ Debit:  النقد/البنك (Cash)       ← المبلغ المدفوع              │
│ Credit: الذمم المدينة (AR)       ← المبلغ المدفوع              │
└─────────────────────────────────────────────────────────────────┘
```

#### 📌 مثال عملي:
```
فاتورة INV-001 بإجمالي 10,000 جنيه
├── عند أول دفعة (5,000 جنيه):
│   ├── قيد الفاتورة: AR 10,000 / Revenue 10,000
│   └── قيد السداد: Cash 5,000 / AR 5,000
│
└── عند ثاني دفعة (5,000 جنيه):
    └── قيد السداد فقط: Cash 5,000 / AR 5,000
```

### ❌ ممنوع تماماً في فواتير البيع:
- خصم المخزون عند الدفع
- إنشاء قيد قبل الدفع
- ربط المخزون بالسداد

---

## 🔹 ثانياً: Sales Returns (مرتجعات فواتير البيع)

### 🔁 شروط عامة
- ❌ لا مرتجعات على Draft
- ✔️ مسموح فقط على: Sent, Paid, Partially Paid

### 🔁 المرتجع على Sent (مرسلة - غير مدفوعة)
| العنصر | الحالة |
|--------|--------|
| استرجاع المخزون | ✔️ نعم |
| قيد محاسبي | ❌ لا |
| رصيد عميل | ❌ لا |

### 🔁 المرتجع على Paid (مدفوعة بالكامل)
| العنصر | الحالة |
|--------|--------|
| استرجاع المخزون | ✔️ نعم |
| قيد محاسبي | ✔️ نعم |
| Customer Credit | ✔️ نعم |
| السداد | من صفحة العملاء → سند صرف |

#### 📊 قيد المرتجع على فاتورة مدفوعة:
```
┌─────────────────────────────────────────────────────────────────┐
│ reference_type: "sales_return"                                  │
├─────────────────────────────────────────────────────────────────┤
│ Debit:  المبيعات (Revenue)       ← قيمة المرتجع                │
│ Credit: سلف العملاء (Customer Credit) ← قيمة المرتجع           │
└─────────────────────────────────────────────────────────────────┘

💰 صرف رصيد العميل (من صفحة العملاء):
┌─────────────────────────────────────────────────────────────────┐
│ reference_type: "customer_credit_payment"                       │
├─────────────────────────────────────────────────────────────────┤
│ Debit:  سلف العملاء (Customer Credit) ← المبلغ المصروف        │
│ Credit: النقد/البنك (Cash)       ← المبلغ المصروف              │
└─────────────────────────────────────────────────────────────────┘
```

### 🔁 المرتجع على Partially Paid (مدفوعة جزئياً)
| العنصر | الحالة |
|--------|--------|
| استرجاع المخزون | ✔️ نعم |
| قيد محاسبي | ✔️ نعم |
| إعادة احتساب الذمم | ✔️ نعم |
| Customer Credit | ❌ إلا إذا المدفوع > صافي الفاتورة |

#### 📊 مثال على Partially Paid:
```
إجمالي الفاتورة: 900
المدفوع: 300
مرتجع: 300
➡️ الصافي: 600
➡️ المتبقي: 300
➡️ رصيد العميل: 0
```

---

## 🔹 ثالثاً: Purchase Invoices (فواتير الشراء)

### 1️⃣ Draft
- ❌ لا مخزون
- ❌ لا قيد

### 2️⃣ Received (مستلمة)
- ✔️ زيادة المخزون (Stock In)
- ❌ لا قيد محاسبي

### 3️⃣ Paid / Partially Paid
- ✔️ إنشاء القيد المحاسبي فقط
- ✔️ تحديث ذمم ورصيد المورد

#### 📊 القيود المحاسبية عند الدفع (فواتير الشراء):

```
┌─────────────────────────────────────────────────────────────────┐
│ 1️⃣ قيد الفاتورة (مرة واحدة - بإجمالي الفاتورة الكامل):        │
├─────────────────────────────────────────────────────────────────┤
│ reference_type: "bill"                                          │
│ ─────────────────────────────────────────────────────────────── │
│ Debit:  المخزون (Inventory)      ← إجمالي الفاتورة              │
│ Credit: الحسابات الدائنة (AP)    ← إجمالي الفاتورة              │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│ 2️⃣ قيد السداد (مع كل دفعة - بالمبلغ المدفوع):                 │
├─────────────────────────────────────────────────────────────────┤
│ reference_type: "bill_payment"                                  │
│ ─────────────────────────────────────────────────────────────── │
│ Debit:  الحسابات الدائنة (AP)    ← المبلغ المدفوع              │
│ Credit: النقد/البنك (Cash)       ← المبلغ المدفوع              │
└─────────────────────────────────────────────────────────────────┘
```

#### 📌 مثال عملي:
```
فاتورة شراء BILL-001 بإجمالي 20,000 جنيه
├── عند أول دفعة (10,000 جنيه):
│   ├── قيد الفاتورة: Inventory 20,000 / AP 20,000
│   └── قيد السداد: AP 10,000 / Cash 10,000
│
└── عند ثاني دفعة (10,000 جنيه):
    └── قيد السداد فقط: AP 10,000 / Cash 10,000
```

---

## 🔹 رابعاً: Purchase Returns (مرتجعات المشتريات)

> مرتجعات المشتريات تُنفذ بنفس منطق مرتجعات البيع ولكن بعكس التأثير

### 🔁 المرتجع على Received
- ✔️ خصم المخزون (Stock Out)
- ❌ لا قيد محاسبي
- ❌ لا رصيد مورد

### 🔁 المرتجع على Paid
- ✔️ خصم المخزون
- ✔️ قيد محاسبي عكسي
- ✔️ Supplier Debit Credit
- ✔️ يظهر في صفحة المورد

#### 📊 قيد مرتجع الشراء على فاتورة مدفوعة:
```
┌─────────────────────────────────────────────────────────────────┐
│ reference_type: "purchase_return"                               │
├─────────────────────────────────────────────────────────────────┤
│ Debit:  الحسابات الدائنة (AP)    ← قيمة المرتجع                │
│ Credit: المخزون (Inventory)      ← قيمة المرتجع                │
└─────────────────────────────────────────────────────────────────┘

💰 استقبال أموال من المورد (من صفحة الموردين):
┌─────────────────────────────────────────────────────────────────┐
│ reference_type: "supplier_debit_payment"                        │
├─────────────────────────────────────────────────────────────────┤
│ Debit:  النقد/البنك (Cash)       ← المبلغ المستلم              │
│ Credit: الحسابات الدائنة (AP)    ← المبلغ المستلم              │
└─────────────────────────────────────────────────────────────────┘
```

### 🔁 المرتجع على Partially Paid
- ✔️ خصم المخزون
- ✔️ قيد محاسبي
- ✔️ إعادة احتساب ذمم المورد
- ❌ لا رصيد مدين إلا إذا المرتجع > المتبقي

### 💰 تسوية رصيد المورد
- تتم من صفحة الموردين
- باستخدام زر **سند استقبال أموال**
- يتم اختيار الحساب المالي
- يتم إنشاء قيد محاسبي مستقل

---

## 🔒 قواعد النظام الصارمة (System Guards)

### 1️⃣ يمنع حذف:
- أي فاتورة لها حركة مخزون
- أي قيد محاسبي مرتبط بسند أو مرتجع

### 2️⃣ كل قيد محاسبي يحتوي:
- `reference_type`
- `reference_id`

### 3️⃣ كل حركة مخزون تحتوي:
- `source_document`
- `document_id`

### 4️⃣ التقارير تعتمد فقط على القيود المحاسبية

---

## ✅ الخلاصة النهائية

```
فصل تام بين:
├── المستندات
├── المخزون
├── المحاسبة
└── السداد

✔️ منع الازدواج
✔️ نمط ERP احترافي قابل للتدقيق والتوسع
```

---

## 📋 جدول ملخص سريع

| الحالة | المخزون | القيد المحاسبي | رصيد العميل/المورد |
|--------|---------|----------------|-------------------|
| **فاتورة بيع Draft** | ❌ | ❌ | ❌ |
| **فاتورة بيع Sent** | ✔️ خصم | ❌ | ❌ |
| **فاتورة بيع Paid** | ❌ (تم) | ✔️ قيد فاتورة + قيد سداد | ✔️ |
| **مرتجع على Sent** | ✔️ إرجاع | ❌ | ❌ |
| **مرتجع على Paid** | ✔️ إرجاع | ✔️ | ✔️ Credit |
| **فاتورة شراء Draft** | ❌ | ❌ | ❌ |
| **فاتورة شراء Received** | ✔️ إضافة | ❌ | ❌ |
| **فاتورة شراء Paid** | ❌ (تم) | ✔️ قيد فاتورة + قيد سداد | ✔️ |
| **مرتجع شراء على Received** | ✔️ خصم | ❌ | ❌ |
| **مرتجع شراء على Paid** | ✔️ خصم | ✔️ | ✔️ Debit |

---

## 📊 أنواع القيود المحاسبية (reference_type)

| النوع | الوصف | الحسابات |
|-------|-------|----------|
| `invoice` | قيد فاتورة مبيعات | Debit AR / Credit Revenue |
| `invoice_payment` | قيد سداد فاتورة مبيعات | Debit Cash / Credit AR |
| `bill` | قيد فاتورة شراء | Debit Inventory / Credit AP |
| `bill_payment` | قيد سداد فاتورة شراء | Debit AP / Credit Cash |
| `sales_return` | قيد مرتجع مبيعات | Debit Revenue / Credit Customer Credit |
| `purchase_return` | قيد مرتجع مشتريات | Debit AP / Credit Inventory |
| `customer_credit_payment` | صرف رصيد عميل | Debit Customer Credit / Credit Cash |
| `supplier_debit_payment` | استقبال أموال من مورد | Debit Cash / Credit AP |

