# ๐ ููุฎุต ุชุทุจูู ููุงุนุฏ ุงูุนุฑุถ ุญุณุจ ุงููุฑุน

## ๐ฏ ุงููุฏู
ุชุทุจูู **ุนุฒู ูุงูู** ุจูู ุงููุฑูุน ูุทูุจุงุช ููู ุงููุฎุฒููุ ูุน ุถูุงู ุชุญุฏูุซ ุงูุตูุงุญูุงุช ููุฑุงู ุนูุฏ ุชุบููุฑ ูุฑุน ุงููุณุชุฎุฏู.

---

## โ ุงูุชุบููุฑุงุช ุงููููุฐุฉ

### 1๏ธโฃ ุตูุญุฉ ูุงุฆูุฉ ุทูุจุงุช ุงูููู (`app/inventory-transfers/page.tsx`)

#### ุงูุชุบููุฑุงุช:
1. โ ุฅุถุงูุฉ ุฌูุจ `branch_id` ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
2. โ ููุชุฑุฉ ุทูุจุงุช ุงูููู ุญุณุจ ุงููุฑุน:
   - **Store Manager**: ูุฑู ููุท ุงูุทูุจุงุช ุงูููุฌูุฉ ููุฎุฒูู ูู ูุฑุนู
   - **Manager**: ูุฑู ููุท ุทูุจุงุช ุงูููู ุงูุฎุงุตุฉ ุจูุฑุนู (ุงููุตุฏุฑ ุฃู ุงููุฌูุฉ)
   - **Owner/Admin**: ูุฑูู ุฌููุน ุงูุทูุจุงุช
3. โ ุฅุถุงูุฉ event listener ูุฅุนุงุฏุฉ ุชุญููู ุงูุจูุงูุงุช ุนูุฏ ุชุบููุฑ ุงููุฑุน

#### ุงูููุฏ:
```typescript
// ุฌูุจ branch_id ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
const { data: member } = await supabase
  .from("company_members")
  .select("role, warehouse_id, branch_id")
  .eq("company_id", companyId)
  .eq("user_id", user.id)
  .single()

const userBranchId = member?.branch_id || null

// ููุชุฑุฉ ุญุณุจ ุงูุฏูุฑ ูุงููุฑุน
if (role === "store_manager" && userWarehouseId && userBranchId) {
  transfersQuery = transfersQuery
    .eq("destination_warehouse_id", userWarehouseId)
    .eq("destination_branch_id", userBranchId)
} else if (role === "manager" && userBranchId) {
  transfersQuery = transfersQuery
    .or(`source_branch_id.eq.${userBranchId},destination_branch_id.eq.${userBranchId}`)
}

// ุฅุนุงุฏุฉ ุชุญููู ุงูุจูุงูุงุช ุนูุฏ ุชุบููุฑ ุงููุฑุน
window.addEventListener('user_context_changed', handleUserContextChange)
```

---

### 2๏ธโฃ ุตูุญุฉ ุชูุงุตูู ุทูุจ ุงูููู (`app/inventory-transfers/[id]/page.tsx`)

#### ุงูุชุบููุฑุงุช:
1. โ ุฅุถุงูุฉ ุฌูุจ `branch_id` ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
2. โ ุงูุชุญูู ูู ุงูุตูุงุญูุงุช ุญุณุจ ุงููุฑุน:
   - **Store Manager**: ููููู ููุท ุฑุคูุฉ ุงูุทูุจุงุช ุงูููุฌูุฉ ููุฎุฒูู ูู ูุฑุนู
   - **Manager**: ููููู ููุท ุฑุคูุฉ ุงูุทูุจุงุช ุงูุฎุงุตุฉ ุจูุฑุนู
3. โ ุฑูุถ ุงููุตูู ูุฅุนุงุฏุฉ ุงูุชูุฌูู ุฅุฐุง ูุงู ุงูุทูุจ ูู ูุฑุน ุขุฎุฑ
4. โ ุฅุถุงูุฉ event listener ูุฅุนุงุฏุฉ ุชุญููู ุงูุจูุงูุงุช ุนูุฏ ุชุบููุฑ ุงููุฑุน

#### ุงูููุฏ:
```typescript
// ุงูุชุญูู ูู ุงูุตูุงุญูุงุช ุญุณุจ ุงููุฑุน
if (role === "store_manager" && warehouseId && branchId) {
  if (transfer.destination_warehouse_id !== warehouseId || 
      transfer.destination_branch_id !== branchId) {
    toast({ title: 'ุบูุฑ ูุตุฑุญ', variant: 'destructive' })
    router.push("/inventory-transfers")
    return
  }
} else if (role === "manager" && branchId) {
  if (transfer.source_branch_id !== branchId && 
      transfer.destination_branch_id !== branchId) {
    toast({ title: 'ุบูุฑ ูุตุฑุญ', variant: 'destructive' })
    router.push("/inventory-transfers")
    return
  }
}
```

---

### 3๏ธโฃ ุตูุญุฉ ุงููุณุชุฎุฏููู (`app/settings/users/page.tsx`)

#### ุงูุชุบููุฑุงุช:
1. โ ุฅุทูุงู event `user_context_changed` ุนูุฏ ุญูุธ ูุฑูุน ุงูููุธู
2. โ ุชุญุฏูุซ `branch_id` ู `warehouse_id` ูู `company_members`

#### ุงูููุฏ:
```typescript
// ุจุนุฏ ุญูุธ ูุฑูุน ุงูููุธู
window.dispatchEvent(new Event('user_context_changed'))
console.log("๐ Dispatched user_context_changed event after branch/warehouse update")
```

---

### 4๏ธโฃ ุงูุชูุซูู

#### ุงููููุงุช ุงููุญุฏุซุฉ:
1. โ `docs/INVENTORY_TRANSFERS_PERMISSIONS.md`
   - ุชุญุฏูุซ ุตูุงุญูุงุช Manager ู Store Manager
   - ุฅุถุงูุฉ ุฃูุซูุฉ ุนูููุฉ ุญุณุจ ุงููุฑุน
   - ุฅุถุงูุฉ ูุณู "ุชุญุฏูุซ ุงููุฑุน ูููุณุชุฎุฏู"

2. โ `docs/BRANCH_BASED_VISIBILITY_RULES.md` (ุฌุฏูุฏ)
   - ุดุฑุญ ุงูููุงุนุฏ ุงูุฅูุฒุงููุฉ
   - ุฃูุซูุฉ ุนูููุฉ
   - ุงูุชุทุจูู ุงูุชููู

3. โ `docs/BRANCH_VISIBILITY_TEST_CASES.md` (ุฌุฏูุฏ)
   - ุญุงูุงุช ุงุฎุชุจุงุฑ ุดุงููุฉ
   - ุณููุงุฑูููุงุช ูุฎุชููุฉ
   - ูุนุงููุฑ ุงููุฌุงุญ

---

## ๐ ุขููุฉ ุงูุชุญุฏูุซ ุงูููุฑู

### ููู ูุนููุ
1. ุนูุฏ ุชุบููุฑ ูุฑุน ุงููุณุชุฎุฏู ูู ุตูุญุฉ ุงููุณุชุฎุฏููู:
   - ูุชู ุชุญุฏูุซ `branch_id` ูู `company_members`
   - ูุชู ุฅุทูุงู event `user_context_changed`

2. ุตูุญุงุช ุทูุจุงุช ุงูููู ุชุณุชูุน ููุฐุง ุงูู event:
   - ุนูุฏ ุงุณุชูุจุงู ุงูู eventุ ูุชู ุฅุนุงุฏุฉ ุชุญููู ุงูุจูุงูุงุช
   - ูุชู ุฌูุจ `branch_id` ุงูุฌุฏูุฏ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
   - ูุชู ุชุทุจูู ุงูููุชุฑุฉ ุงูุฌุฏูุฏุฉ ููุฑุงู

3. **ูุง ููุฌุฏ cache**:
   - ูุชู ุฌูุจ `branch_id` ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ูู ูู ูุฑุฉ
   - ูุง ูุชู ุงูุงุญุชูุงุธ ุจุฃู session ุฃู localStorage

---

## ๐ ุฌุฏูู ุงูุตูุงุญูุงุช

| ุงูุฏูุฑ | ุงูููุชุฑุฉ | ุงูุญููู ุงููุณุชุฎุฏูุฉ | ูุซุงู |
|------|---------|-------------------|------|
| **Owner/Admin** | ูุง ููุชุฑุฉ | - | ูุฑู ุฌููุน ุงูุทูุจุงุช |
| **Manager** | ุญุณุจ ุงููุฑุน | `source_branch_id` OR `destination_branch_id` | ูุฑู ุทูุจุงุช ูุฑุนู ููุท |
| **Store Manager** | ุญุณุจ ุงููุฑุน ูุงููุฎุฒู | `destination_branch_id` AND `destination_warehouse_id` | ูุฑู ุทูุจุงุช ูุฎุฒูู ูู ูุฑุนู ููุท |

---

## ๐จ ููุงุท ูููุฉ

1. โ **ูุง cache**: ูุชู ุฌูุจ `branch_id` ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ูู ูู ูุฑุฉ
2. โ **ุชุญุฏูุซ ููุฑู**: ุนูุฏ ุชุบููุฑ ุงููุฑุนุ ูุชู ุชุญุฏูุซ ุงูุจูุงูุงุช ููุฑุงู
3. โ **ุนุฒู ูุงูู**: ูุง ูููู ุฑุคูุฉ ุจูุงูุงุช ูุฑูุน ุฃุฎุฑู
4. โ **ุฑูุถ ุงููุตูู**: ูุญุงููุฉ ุงููุตูู ูุทูุจ ูู ูุฑุน ุขุฎุฑ ูุชู ุฑูุถูุง
5. โ **event-driven**: ุงุณุชุฎุฏุงู events ูุชุญุฏูุซ ุงูุจูุงูุงุช ุนุจุฑ ุงูุตูุญุงุช

---

## ๐งช ุงูุงุฎุชุจุงุฑ

ุฑุงุฌุน ููู `docs/BRANCH_VISIBILITY_TEST_CASES.md` ููุญุตูู ุนูู ุญุงูุงุช ุงุฎุชุจุงุฑ ุดุงููุฉ.

---

## ๐ ููุงุญุธุงุช ุฅุถุงููุฉ

- ุงูููุฏ ูุนุชูุฏ ุนูู `source_branch_id` ู `destination_branch_id` ูู ุฌุฏูู `inventory_transfers`
- ูุฐู ุงูุญููู ูุชู ููุคูุง ุชููุงุฆูุงู ูู `warehouses.branch_id` ุนูุฏ ุฅูุดุงุก ุทูุจ ุงูููู
- ุงูููุฏ ูุชูุงูู ูุน ูุธุงู ุงููุฑูุน ุงููุชุนุฏุฏุฉ (Multi-Branch)

