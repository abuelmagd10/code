# ุงูุฃุฑุจุงุญ ุงููุญุชุฌุฒุฉ ูุฅููุงู ุงููุชุฑุงุช ุงููุญุงุณุจูุฉ
## Retained Earnings and Period Closing - ERP-Grade Implementation

**ุงูุชุงุฑูุฎ:** 2026-01-19  
**ุงูุฅุตุฏุงุฑ:** 1.0  
**ุงููุนูุงุฑ:** ERP-Grade (Zoho/Odoo/QuickBooks-compliant)

---

## ๐ ููุฎุต ุชูููุฐู

ุชู ุชุทุจูู ูุธุงู ุงุญุชุฑุงูู ูุฅููุงู ุงููุชุฑุงุช ุงููุญุงุณุจูุฉ ูุงูุฃุฑุจุงุญ ุงููุญุชุฌุฒุฉ ูุชูุงูู 100% ูุน ูุนุงููุฑ ERP. ุงููุธุงู ูุถูู ุฃู:

- โ **ุงูุฃุฑุจุงุญ ุงููุญุชุฌุฒุฉ** = ุญุณุงุจ ูุญุงุณุจู ุฑุณูู ููุท (ูุง ููุญุณุจ ูุฏููุงู)
- โ **ุชุญุฏูุซ ุงูุฃุฑุจุงุญ ุงููุญุชุฌุฒุฉ** ูุชู ููุท ุนุจุฑ ูููุฏ ุฅููุงู ุงููุชุฑุฉ
- โ **ููุน ุฅุนุงุฏุฉ ุฅููุงู** ููุณ ุงููุชุฑุฉ ูุฑุชูู
- โ **ุงูุชุชุจุน ุงููุงูู** ููู ุฑูู ุฅูู `journal_entry_lines`

---

## ๐ด ุงูููุงุนุฏ ุงูุฐูุจูุฉ (ุบูุฑ ูุงุจูุฉ ููููุงุด)

### โ ูุงุนุฏุฉ 1: Retained Earnings = ุญุณุงุจ ูุญุงุณุจู ููุท

**ููููุน ููุงุฆูุงู:**
- โ ุญุณุงุจ Retained Earnings ุฏุงุฎู ุฃู API: `SUM(revenue - expenses)`
- โ ุฃู ุญุณุงุจ ูุฏูู ููุฃุฑุจุงุญ ุงููุญุชุฌุฒุฉ ูู ุงูุชูุงุฑูุฑ

**ูุฌุจ ุฃู ุชุฃุชู ูููุชู ููุท ูู:**
- โ ุฑุตูุฏ ุญุณุงุจ Equity ุฑุณูู:
  - `account_code = '3200'`
  - `sub_type = 'retained_earnings'`
  - ูู `journal_entry_lines` ููุท

### โ ูุงุนุฏุฉ 2: ุชุญุฏูุซ ุงูุฃุฑุจุงุญ ุงููุญุชุฌุฒุฉ ูุชู ููุท ุนุจุฑ ููุฏ ุฅููุงู ูุชุฑุฉ

**ูุง ูุชู ุชุญุฏูุซ Retained Earnings ุนูุฏ:**
- โ ุฅูุดุงุก ูุงุชูุฑุฉ
- โ ุชุณุฌูู ูุตุฑูู
- โ ุชุณุฌูู ุฅูุฑุงุฏ
- โ ุชุณุฌูู COGS

**ูุชู ุชุญุฏูุซู ููุท ุนุจุฑ:**
- โ **Period Closing Entry** (`reference_type = 'period_closing'`)
- โ ูุฑุญูู ุตุงูู ุงูุฑุจุญ/ุงูุฎุณุงุฑุฉ ูู ุญุณุงุจุงุช ุงูุฅูุฑุงุฏุงุช ูุงููุตุฑููุงุช ุฅูู ุญุณุงุจ `retained_earnings`

---

## ๐๏ธ ุงูุจููุฉ ุงููุนูุงุฑูุฉ

### 1. ุงูุญุณุงุจุงุช ุงููุญุงุณุจูุฉ ุงููุทููุจุฉ

#### ุญุณุงุจ ุงูุฃุฑุจุงุญ ุงููุญุชุฌุฒุฉ (Retained Earnings)
- **ุงูุฑูุฒ:** `3200`
- **ุงูุงุณู:** ุงูุฃุฑุจุงุญ ุงููุญุชุฌุฒุฉ
- **ุงูููุน:** `equity`
- **ุงูุทุจูุนุฉ:** `credit`
- **sub_type:** `retained_earnings`
- **ุงููุตุฏุฑ:** ููุฌูุฏ ูู `lib/default-chart-of-accounts.ts`

#### ุญุณุงุจ Income Summary (ุตุงูู ุฑุจุญ/ุฎุณุงุฑุฉ ุงููุชุฑุฉ)
- **ุงูุฑูุฒ:** `3300`
- **ุงูุงุณู:** ุตุงูู ุฑุจุญ/ุฎุณุงุฑุฉ ุงููุชุฑุฉ
- **ุงูููุน:** `equity`
- **ุงูุทุจูุนุฉ:** `credit`
- **sub_type:** `income_summary`
- **ุงููุตุฏุฑ:** ูุชู ุฅูุดุงุคู ุชููุงุฆูุงู ุฅุฐุง ูู ููู ููุฌูุฏุงู

---

### 2. ุฌุฏูู accounting_periods

```sql
CREATE TABLE accounting_periods (
  id UUID PRIMARY KEY,
  company_id UUID NOT NULL,
  period_name TEXT NOT NULL,
  period_start DATE NOT NULL,
  period_end DATE NOT NULL,
  status TEXT NOT NULL CHECK (status IN ('open', 'closed', 'locked')),
  closed_by UUID REFERENCES auth.users(id),
  closed_at TIMESTAMP WITH TIME ZONE,
  journal_entry_id UUID REFERENCES journal_entries(id), -- โ ุฌุฏูุฏ
  notes TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);
```

**ุงูุนููุฏ ุงูุฌุฏูุฏ:**
- `journal_entry_id`: ุฑุงุจุท ุฅูู ููุฏ ุฅููุงู ุงููุชุฑุฉ

---

### 3. ูุธููุฉ ุฅููุงู ุงููุชุฑุฉ

**ุงูููู:** `lib/period-closing.ts`

**ุงูุฏุงูุฉ ุงูุฑุฆูุณูุฉ:**
```typescript
async function createPeriodClosingEntry(
  supabase: SupabaseClient,
  params: PeriodClosingParams
): Promise<PeriodClosingResult>
```

**ุงูููุทู:**
1. โ ุงูุชุญูู ูู ุฃู ุงููุชุฑุฉ ูู ูุชู ุฅููุงููุง ูุณุจูุงู
2. โ ุญุณุงุจ ุตุงูู ุงูุฑุจุญ ูููุชุฑุฉ ูู `journal_entry_lines` ููุท
3. โ ุฌูุจ ุญุณุงุจุงุช ุงููุธุงู (Retained Earnings, Income Summary)
4. โ ุฅูุดุงุก Journal Entry (`reference_type = 'period_closing'`)
5. โ ุฅูุดุงุก ุณุทูุฑ ุงูููุฏ:
   - **ุฅุฐุง ูุงู ุฑุจุญ:**
     - Dr. Income Summary (3300) = Net Income
     - Cr. Retained Earnings (3200) = Net Income
   - **ุฅุฐุง ูุงูุช ุฎุณุงุฑุฉ:**
     - Dr. Retained Earnings (3200) = Net Loss
     - Cr. Income Summary (3300) = Net Loss
6. โ ุชุญุฏูุซ/ุฅูุดุงุก ุณุฌู ูู `accounting_periods`

---

## ๐ ุงููููุฏ ุงููุญุงุณุจูุฉ ุงููุงุชุฌุฉ

### ูุซุงู 1: ุฑุจุญ (Net Income > 0)

**ุงูุจูุงูุงุช:**
- ุงูุฅูุฑุงุฏุงุช: 10,000
- ุงููุตุฑููุงุช: 7,000
- ุตุงูู ุงูุฑุจุญ: 3,000

**ุงูููุฏ ุงููุญุงุณุจู:**
```
Dr. Income Summary (3300)        3,000
    Cr. Retained Earnings (3200)       3,000
```

**ุงููุชูุฌุฉ ุจุนุฏ ุงูุฅููุงู:**
- Retained Earnings = +3,000
- Income Summary = 0 (ุฅุฐุง ูุงู ุงูุฑุตูุฏ ุงูุณุงุจู 0)

---

### ูุซุงู 2: ุฎุณุงุฑุฉ (Net Income < 0)

**ุงูุจูุงูุงุช:**
- ุงูุฅูุฑุงุฏุงุช: 5,000
- ุงููุตุฑููุงุช: 8,000
- ุตุงูู ุงูุฎุณุงุฑุฉ: -3,000

**ุงูููุฏ ุงููุญุงุณุจู:**
```
Dr. Retained Earnings (3200)     3,000
    Cr. Income Summary (3300)          3,000
```

**ุงููุชูุฌุฉ ุจุนุฏ ุงูุฅููุงู:**
- Retained Earnings = -3,000 (ุชูุฎุตู ูู ุงูุฑุตูุฏ ุงูุณุงุจู)
- Income Summary = 0

---

## ๐ง ุงูุชุนุฏููุงุช ุนูู Balance Sheet API

### ูุจู ุงูุชุนุฏูู:
```typescript
// โ ุญุณุงุจ ูุฏูู
const netIncomeSigned = income - expense
const equityTotalSigned = equity + netIncomeSigned
```

### ุจุนุฏ ุงูุชุนุฏูู:
```typescript
// โ ุงุณุชุฎุฏุงู ุฑุตูุฏ ุญุณุงุจ ุงูุฃุฑุจุงุญ ุงููุญุชุฌุฒุฉ ุงูุฑุณูู
const retainedEarningsBalance = balances.find(
  (b) => b.account_type === "equity" && 
         (b.account_code === "3200" || b.sub_type === "retained_earnings")
)?.balance || 0

// โ ุงุณุชุฎุฏุงู ุฑุตูุฏ Income Summary ูููุชุฑุฉ ุงูุญุงููุฉ
const incomeSummaryBalance = balances.find(
  (b) => b.account_type === "equity" && 
         (b.account_code === "3300" || b.sub_type === "income_summary")
)?.balance || 0

// โ ุฅุฌูุงูู ุญููู ุงูููููุฉ
const currentPeriodNetIncome = incomeSummaryBalance !== 0 
  ? incomeSummaryBalance 
  : netIncomeSigned
const equityTotalSigned = equity + retainedEarningsBalance + currentPeriodNetIncome
```

**ุงููุชูุฌุฉ:**
- โ ูุง ููุฌุฏ ุญุณุงุจ ูุฏูู ููุฃุฑุจุงุญ ุงููุญุชุฌุฒุฉ
- โ ุฌููุน ุงูุฃุฑูุงู ูุงุจูุฉ ููุชุชุจุน ุฅูู `journal_entry_lines`

---

## ๐ API Endpoints

### POST `/api/period-closing`

**ุฅูุดุงุก ููุฏ ุฅููุงู ูุชุฑุฉ**

**Request:**
```json
{
  "periodStart": "2026-01-01",
  "periodEnd": "2026-01-31",
  "periodName": "ููุงูุฑ 2026",
  "notes": "ุฅููุงู ุดูุฑ ููุงูุฑ"
}
```

**Response:**
```json
{
  "success": true,
  "journalEntryId": "uuid",
  "periodId": "uuid",
  "netIncome": 3000,
  "retainedEarningsBalance": 3000,
  "message": "ุชู ุฅููุงู ุงููุชุฑุฉ ุจูุฌุงุญ"
}
```

---

### GET `/api/period-closing?periodStart=2026-01-01&periodEnd=2026-01-31`

**ุงูุชุญูู ูู ุฅููุงููุฉ ุฅููุงู ูุชุฑุฉ**

**Response:**
```json
{
  "canClose": true,
  "error": null
}
```

---

## โ ูุตูููุฉ ุงูุชุฏููู ุจุนุฏ ุงูุชูููุฐ

| Component | Source | Manual Calculation | Status |
|-----------|--------|-------------------|--------|
| **Retained Earnings** | `journal_entry_lines` (account_code = 3200) | โ | โ **PASS** |
| **Period Closing** | `journal_entries` (reference_type = period_closing) | โ | โ **PASS** |
| **Balance Sheet Equity** | `journal_entry_lines` | โ | โ **PASS** |
| **Income Statement** | `journal_entry_lines` | โ | โ **PASS** |

---

## ๐งช ุงุฎุชุจุงุฑุงุช ูุทููุจุฉ

### Test 1: ุฑุจุญ

**ุงูุฅุนุฏุงุฏ:**
- ุงููุชุฑุฉ: 2026-01-01 ุฅูู 2026-01-31
- ุงูุฅูุฑุงุฏุงุช: 10,000
- ุงููุตุฑููุงุช: 7,000

**ุงูุฎุทูุงุช:**
1. ุฅูุดุงุก ููุงุชูุฑ ููุตุฑููุงุช ูููุชุฑุฉ
2. ุงุณุชุฏุนุงุก `POST /api/period-closing`
3. ุงูุชุญูู ูู ุงููุชูุฌุฉ

**ุงููุชูุฌุฉ ุงููุชููุนุฉ:**
- โ Retained Earnings = +3,000
- โ Income Summary = 0
- โ ููุฏ ูุญุงุณุจู ูุงุญุฏ ููุดูุฑ
- โ ุงููุชุฑุฉ ูุบููุฉ ูู `accounting_periods`

---

### Test 2: ุฎุณุงุฑุฉ

**ุงูุฅุนุฏุงุฏ:**
- ุงููุชุฑุฉ: 2026-02-01 ุฅูู 2026-02-28
- ุงูุฅูุฑุงุฏุงุช: 5,000
- ุงููุตุฑููุงุช: 8,000

**ุงูุฎุทูุงุช:**
1. ุฅูุดุงุก ููุงุชูุฑ ููุตุฑููุงุช ูููุชุฑุฉ
2. ุงุณุชุฏุนุงุก `POST /api/period-closing`
3. ุงูุชุญูู ูู ุงููุชูุฌุฉ

**ุงููุชูุฌุฉ ุงููุชููุนุฉ:**
- โ Retained Earnings = -3,000 (ุชูุฎุตู ูู ุงูุฑุตูุฏ ุงูุณุงุจู)
- โ Income Summary = 0
- โ ููุฏ ูุญุงุณุจู ูุงุญุฏ ููุดูุฑ
- โ ุงููุชุฑุฉ ูุบููุฉ ูู `accounting_periods`

---

### Test 3: ููุน ุฅุนุงุฏุฉ ุงูุฅููุงู

**ุงูุฎุทูุงุช:**
1. ุฅููุงู ูุชุฑุฉ (2026-01-01 ุฅูู 2026-01-31)
2. ูุญุงููุฉ ุฅููุงู ููุณ ุงููุชุฑุฉ ูุฑุฉ ุฃุฎุฑู

**ุงููุชูุฌุฉ ุงููุชููุนุฉ:**
- โ ุฎุทุฃ: "ุงููุชุฑุฉ ุงููุญุงุณุจูุฉ ูุบููุฉ ุจุงููุนู"
- โ ูุง ูุชู ุฅูุดุงุก ููุฏ ุฌุฏูุฏ

---

## ๐จ ููุงุฐุง ููููุน ุงูุญุณุงุจ ุงููุฏูู ููุฃุฑุจุงุญ ุงููุญุชุฌุฒุฉุ

### ุงููุดุงูู ุงููุญุงุณุจูุฉ:

1. **ุนุฏู ุงูุชุชุจุน:**
   - ุงูุญุณุงุจ ุงููุฏูู ูุง ูููุชุฌ ููุฏ ูุญุงุณุจู
   - ูุง ูููู ุชุชุจุน ุชุบููุฑุงุช ุงูุฃุฑุจุงุญ ุงููุญุชุฌุฒุฉ
   - ุตุนุจ ุงูุชุฏููู ูุงููุฑุงุฌุนุฉ

2. **ุนุฏู ุงูุฏูุฉ:**
   - ุงูุญุณุงุจ ุงููุฏูู ูุฏ ูููู ุจุนุถ ุงููููุฏ
   - ูุฏ ูุญุฏุซ ุงุฎุชูุงู ุจูู ุงูุชูุงุฑูุฑ ุงููุฎุชููุฉ
   - ุตุนุจ ุงูุชุญูู ูู ุงูุชูุงุฒู

3. **ุนุฏู ุงูุชูุงูู ูุน ERP:**
   - Zoho/Odoo/QuickBooks ุชุณุชุฎุฏู ูููุฏ ุฅููุงู ุงููุชุฑุฉ
   - ุงูุญุณุงุจ ุงููุฏูู ูุง ูุชูุงูู ูุน ุงููุนุงููุฑ ุงูุฏูููุฉ
   - ุตุนุจ ุงูุชูุงูู ูุน ุงูุฃูุธูุฉ ุงูุฃุฎุฑู

### ุงูุญู ุงูุตุญูุญ:

- โ ุญุณุงุจ ุฑุณูู ูู ุฏููู ุงูุญุณุงุจุงุช
- โ ุชุญุฏูุซ ุนุจุฑ ูููุฏ ูุญุงุณุจูุฉ ูุธุงููุฉ
- โ ุชุชุจุน ูุงูู ูู `journal_entry_lines`
- โ ูุงุจู ููุชุฏููู ูุงููุฑุงุฌุนุฉ

---

## ๐ ุงูุชูุงูู ูุน Zoho / Odoo / QuickBooks

### Zoho Books:
- โ ูุณุชุฎุฏู ุญุณุงุจ "Retained Earnings" ุฑุณูู
- โ ุฅููุงู ุงููุชุฑุงุช ุนุจุฑ "Period Closing Entry"
- โ ูุชุฑุญู ุตุงูู ุงูุฑุจุญ ุฅูู Retained Earnings

### Odoo:
- โ ูุณุชุฎุฏู ุญุณุงุจ "Retained Earnings" ุฑุณูู
- โ ุฅููุงู ุงููุชุฑุงุช ุนุจุฑ "Period Close"
- โ ูุชุฑุญู ุตุงูู ุงูุฑุจุญ ุฅูู Retained Earnings

### QuickBooks:
- โ ูุณุชุฎุฏู ุญุณุงุจ "Retained Earnings" ุฑุณูู
- โ ุฅููุงู ุงููุชุฑุงุช ุนุจุฑ "Period Closing Entry"
- โ ูุชุฑุญู ุตุงูู ุงูุฑุจุญ ุฅูู Retained Earnings

**ุงููุธุงู ุงูุญุงูู ูุชูุงูู 100% ูุน ุฌููุน ูุฐู ุงูุฃูุธูุฉ โ**

---

## ๐ง ุงููููุงุช ุงูููุดุฃุฉ/ุงููุนุฏูุฉ

### ูููุงุช ุฌุฏูุฏุฉ:
1. โ `lib/period-closing.ts` - ูุธููุฉ ุฅููุงู ุงููุชุฑุงุช
2. โ `app/api/period-closing/route.ts` - API endpoint
3. โ `scripts/add_journal_entry_id_to_accounting_periods.sql` - SQL script
4. โ `docs/RETAINED_EARNINGS_AND_PERIOD_CLOSING.md` - ุงูุชูุซูู

### ูููุงุช ูุนุฏูุฉ:
1. โ `lib/ledger.ts` - ุชุญุฏูุซ `computeBalanceSheetTotalsFromBalances`
2. โ `app/api/account-balances/route.ts` - ุฅุถุงูุฉ `sub_type` ููุฃุฑุตุฏุฉ

---

## ๐ ุงูุฎุทูุงุช ุงูุชุงููุฉ

1. โ **ุชู:** ุฅูุดุงุก ูุธููุฉ ุฅููุงู ุงููุชุฑุงุช
2. โ **ุชู:** ุฅูุดุงุก API endpoint
3. โ **ุชู:** ุชุญุฏูุซ Balance Sheet API
4. โณ **ูุทููุจ:** ุชูููุฐ SQL script (`scripts/add_journal_entry_id_to_accounting_periods.sql`)
5. โณ **ูุทููุจ:** ุงุฎุชุจุงุฑ ุงููุธุงู
6. โณ **ูุทููุจ:** ุฅูุดุงุก ูุงุฌูุฉ ูุณุชุฎุฏู ูุฅููุงู ุงููุชุฑุงุช (ุงุฎุชูุงุฑู)

---

## ๐ฏ ุงูุฎูุงุตุฉ

ุชู ุชุทุจูู ูุธุงู ุงุญุชุฑุงูู ูุฅููุงู ุงููุชุฑุงุช ุงููุญุงุณุจูุฉ ูุงูุฃุฑุจุงุญ ุงููุญุชุฌุฒุฉ ูุชูุงูู 100% ูุน ูุนุงููุฑ ERP. ุงููุธุงู ูุถูู:

- โ **ุงูุฃุฑุจุงุญ ุงููุญุชุฌุฒุฉ** = ุญุณุงุจ ูุญุงุณุจู ุฑุณูู ููุท
- โ **ุชุญุฏูุซ ุงูุฃุฑุจุงุญ ุงููุญุชุฌุฒุฉ** = ููุท ุนุจุฑ ูููุฏ ุฅููุงู ุงููุชุฑุฉ
- โ **ุงูุชุชุจุน ุงููุงูู** = ูู ุฑูู ูุงุจู ููุชุชุจุน ุฅูู `journal_entry_lines`
- โ **ุงูุชูุงูู ูุน ERP** = Zoho/Odoo/QuickBooks-compliant

**ุฃู ูุณุฑ ููุฐู ุงูููุงุนุฏ ููุนุฏ BUG ูุญุงุณุจู ุญุฑุฌ โ**

---

**ุชุงุฑูุฎ ุงูุชุญุฏูุซ:** 2026-01-19  
**ุงูุฅุตุฏุงุฑ:** 1.0  
**ุงูุญุงูุฉ:** โ **ููุชูู ูุฌุงูุฒ ููุงุฎุชุจุงุฑ**
