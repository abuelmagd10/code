# ููุงุนุฏ ุณูุงูุฉ ุงูุจูุงูุงุช - Data Integrity Rules

## ๐ ูุธุฑุฉ ุนุงูุฉ

ูุฐุง ุงููุณุชูุฏ ููุซู ุฌููุน ุงูููุงุนุฏ ูุงููุนุงููุฑ ุงูุชู ูุฌุจ ุงุชุจุงุนูุง ูุถูุงู ุณูุงูุฉ ุงูุจูุงูุงุช ูู ุงููุธุงู.

---

## ๐ซ ุงูููุงุนุฏ ุงูุญุฑุฌุฉ (CRITICAL RULES)

### 1๏ธโฃ **ููุงุชูุฑ ุงูุดุฑุงุก (Bills)**

#### โ **ููููุน ููุนุงู ุจุงุชุงู:**
- ุฅูุดุงุก ูุงุชูุฑุฉ ุดุฑุงุก ุจุฏูู ุฃุตูุงู (bill_items)
- ุชุญููู ูุงุชูุฑุฉ ุฅูู ุญุงูุฉ "ูุณุชููุฉ" (received) ุฃู "ูุฏููุนุฉ" (paid) ุจุฏูู ุฃุตูุงู
- ุญุฐู ูุงุชูุฑุฉ ูุฏููุนุฉ ุฃู ููุง ุฏูุนุงุช ูุณุฌูุฉ

#### โ **ูุฌุจ:**
- ูู ูุงุชูุฑุฉ ุดุฑุงุก ูุฌุจ ุฃู ุชุญุชูู ุนูู ุตูู ูุงุญุฏ ุนูู ุงูุฃูู
- ูู ุตูู ูุฌุจ ุฃู ูููู ูู:
  - `product_id` (ูุนุฑู ุงูููุชุฌ)
  - `quantity > 0` (ุงููููุฉ ุฃูุจุฑ ูู ุตูุฑ)
  - `unit_price >= 0` (ุงูุณุนุฑ ุตูุฑ ุฃู ุฃูุจุฑ)
- ุนูุฏ ุชุญููู ุงููุงุชูุฑุฉ ุฅูู "ูุณุชููุฉ" ุฃู "ูุฏููุนุฉ":
  - ูุชู ุฅูุดุงุก ุญุฑูุงุช ูุฎุฒูู (inventory_transactions) ุชููุงุฆูุงู
  - ูุชู ุฅูุดุงุก ูููุฏ ูุญุงุณุจูุฉ (journal_entries) ุชููุงุฆูุงู

#### ๐ง **ุงูุญูุงูุฉ ุงููุทุจูุฉ:**
- Database Trigger: `trg_check_bill_has_items`
- Frontend Validation: `lib/validation/bill-validation.ts`
- Form Validation: `app/bills/new/page.tsx` (line 378)

---

### 2๏ธโฃ **ููุงุชูุฑ ุงูุจูุน (Invoices)**

#### โ **ููููุน ููุนุงู ุจุงุชุงู:**
- ุฅูุดุงุก ูุงุชูุฑุฉ ุจูุน ุจุฏูู ุฃุตูุงู (invoice_lines)
- ุฅูุดุงุก ูุงุชูุฑุฉ ุจูุน ุจุฏูู ุฃูุฑ ุจูุน (sales_order_id)
- ุชุญููู ูุงุชูุฑุฉ ุฅูู ุญุงูุฉ "ูุฑุณูุฉ" (sent) ุฃู "ูุฏููุนุฉ" (paid) ุจุฏูู ุฃุตูุงู
- ุญุฐู ูุงุชูุฑุฉ ูุฏููุนุฉ ุฃู ููุง ุฏูุนุงุช ูุณุฌูุฉ

#### โ **ูุฌุจ:**
- ูู ูุงุชูุฑุฉ ุจูุน ูุฌุจ ุฃู ุชุญุชูู ุนูู ุตูู ูุงุญุฏ ุนูู ุงูุฃูู
- ูู ูุงุชูุฑุฉ ูุฌุจ ุฃู ุชููู ูุฑุชุจุทุฉ ุจุฃูุฑ ุจูุน
- ูู ุตูู ูุฌุจ ุฃู ูููู ูู:
  - `product_id` (ูุนุฑู ุงูููุชุฌ)
  - `quantity > 0` (ุงููููุฉ ุฃูุจุฑ ูู ุตูุฑ)
  - `unit_price >= 0` (ุงูุณุนุฑ ุตูุฑ ุฃู ุฃูุจุฑ)
- ุนูุฏ ุชุญููู ุงููุงุชูุฑุฉ ุฅูู "ูุฑุณูุฉ":
  - ูุชู ุฅูุดุงุก ุญุฑูุงุช ูุฎุฒูู (inventory_transactions) ุชููุงุฆูุงู
  - ูุชู ุฅูุดุงุก ูููุฏ COGS (journal_entries) ุชููุงุฆูุงู (Accrual Basis)

#### ๐ง **ุงูุญูุงูุฉ ุงููุทุจูุฉ:**
- Database Trigger: `trg_check_invoice_has_lines`
- Frontend Validation: `lib/validation/invoice-validation.ts`
- Form Validation: `app/invoices/new/page.tsx` (line 522-537)

---

### 3๏ธโฃ **ุญุฑูุงุช ุงููุฎุฒูู (Inventory Transactions)**

#### โ **ููููุน ููุนุงู ุจุงุชุงู:**
- ุฅูุดุงุก ุญุฑูุฉ ูุฎุฒูู ูู ููุน "ุดุฑุงุก" (purchase) ุฃู "ุจูุน" (sale) ุจุฏูู ููุฏ ูุญุงุณุจู
- ุญุฑูุงุช ุงููุฎุฒูู ูุฌุจ ุฃู ุชููู ูุฑุชุจุทุฉ ุจู `journal_entry_id`

#### โ **ูุฌุจ:**
- ูู ุญุฑูุฉ ุดุฑุงุก ูุฌุจ ุฃู ุชููู ูุฑุชุจุทุฉ ุจูุงุชูุฑุฉ ุดุฑุงุก (bill_id)
- ูู ุญุฑูุฉ ุจูุน ูุฌุจ ุฃู ุชููู ูุฑุชุจุทุฉ ุจูุงุชูุฑุฉ ุจูุน (invoice_id)
- ูู ุญุฑูุฉ ูุฌุจ ุฃู ุชููู ููุง ููุฏ ูุญุงุณุจู (journal_entry_id)

#### ๐ง **ุงูุญูุงูุฉ ุงููุทุจูุฉ:**
- Database Trigger: `trg_check_transaction_has_journal`
- Auto-creation Trigger: `trg_auto_create_bill_transaction`

---

### 4๏ธโฃ **ุงููููุฏ ุงููุญุงุณุจูุฉ (Journal Entries)**

#### โ **ููููุน ููุนุงู ุจุงุชุงู:**
- ุฅูุดุงุก ููุฏ ูุญุงุณุจู ุบูุฑ ูุชูุงุฒู (ุงููุฏูู โ ุงูุฏุงุฆู)
- ุฅูุดุงุก ููุฏ COGS ุจุฏูู ูุฑุฌุน ูุงุชูุฑุฉ (reference_id)
- ุญุฐู ููุฏ ูุญุงุณุจู ูุฑุชุจุท ุจูุงุชูุฑุฉ ูุฏููุนุฉ

#### โ **ูุฌุจ:**
- ูู ููุฏ ูุญุงุณุจู ูุฌุจ ุฃู ูููู ูุชูุงุฒูุงู: `SUM(debit) = SUM(credit)`
- ูููุฏ COGS ูุฌุจ ุฃู ุชููู ูุฑุชุจุทุฉ ุจูุงุชูุฑุฉ ุจูุน ุตุญูุญุฉ
- ูููุฏ COGS ูุชู ุฅูุดุงุคูุง ุชููุงุฆูุงู ุนูุฏ ุชุญููู ุงููุงุชูุฑุฉ ุฅูู "ูุฑุณูุฉ" (Accrual Basis)

#### ๐ง **ุงูุญูุงูุฉ ุงููุทุจูุฉ:**
- Database Trigger: `trg_check_journal_balance_update`
- Database Trigger: `trg_check_cogs_has_invoice`
- Validation Trigger: `trg_validate_cogs_amount`

---

### 5๏ธโฃ **ุฏูุนุงุช FIFO (FIFO Cost Lots)**

#### โ **ููููุน ููุนุงู ุจุงุชุงู:**
- ุงููููุฉ ุงููุชุจููุฉ (remaining_quantity) ูุง ูููู ุฃู ุชููู ุณุงูุจุฉ

#### โ **ูุฌุจ:**
- `remaining_quantity >= 0` ุฏุงุฆูุงู

#### ๐ง **ุงูุญูุงูุฉ ุงููุทุจูุฉ:**
- Database Trigger: `trg_check_fifo_lot_quantity`

---

## ๐ ูุธุงู ุงููุฑุงูุจุฉ ุงูุชููุงุฆู

### ุงูุณูุฑุจุช: `scripts/automated-health-check.js`

ูููู ุจูุญุต:
1. โ ููุงุชูุฑ ุดุฑุงุก ุจุฏูู ุฃุตูุงู
2. โ ููุงุชูุฑ ุจูุน ุจุฏูู ุฃุตูุงู
3. โ ุนุฏู ุชุทุงุจู ุฑุตูุฏ ุงููุฎุฒูู ุงููุญุงุณุจู ูุน ุงููุฎุฒูู ุงููุนูู
4. โ ุญุฑูุงุช ูุฎุฒูู ุจุฏูู ูููุฏ ูุญุงุณุจูุฉ
5. โ ูููุฏ ูุญุงุณุจูุฉ ุบูุฑ ูุชูุงุฒูุฉ

### ููููุฉ ุงูุชุดุบูู:
```bash
# ุชุดุบูู ูุฏูู
node scripts/automated-health-check.js

# ุฌุฏููุฉ ููููุฉ (cron)
# ุฃุถู ุฅูู crontab:
0 2 * * * cd /path/to/project && node scripts/automated-health-check.js
```

---

## ๐ง ูููุงุช ุงูุญูุงูุฉ

### Database Level:
- `scripts/200_add_data_integrity_constraints.sql` - ุงููููุฏ ุนูู ูุณุชูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
- `scripts/210_add_validation_triggers.sql` - Triggers ููุชุญูู ุงูุชููุงุฆู

### Application Level:
- `lib/validation/bill-validation.ts` - Validation ูููุงุชูุฑ ุงูุดุฑุงุก
- `lib/validation/invoice-validation.ts` - Validation ูููุงุชูุฑ ุงูุจูุน

### Monitoring:
- `scripts/automated-health-check.js` - ูุธุงู ุงููุฑุงูุจุฉ ุงูุชููุงุฆู
- `scripts/inventory-audit.js` - ูุฑุงุฌุนุฉ ุงููุฎุฒูู ุงูุดุงููุฉ

---

## ๐ ุงูููุท ุงููุญุงุณุจู ุงููุนุชูุฏ

### **Accrual Basis (ุฃุณุงุณ ุงูุงุณุชุญูุงู)**

#### ููุงุชูุฑ ุงูุจูุน:
- **Draft (ูุณูุฏุฉ):** ูุง ูููุฏ ููุง ูุฎุฒูู
- **Sent (ูุฑุณูุฉ):** ูููุฏ COGS + ุญุฑูุงุช ูุฎุฒูู (ุจุฏูู ูููุฏ ูุงููุฉ)
- **Paid (ูุฏููุนุฉ):** ูููุฏ ูุงููุฉ ูุงููุฉ

#### ููุงุชูุฑ ุงูุดุฑุงุก:
- **Draft (ูุณูุฏุฉ):** ูุง ูููุฏ ููุง ูุฎุฒูู
- **Received (ูุณุชููุฉ):** ุญุฑูุงุช ูุฎุฒูู ููุท (ุจุฏูู ูููุฏ ูุงููุฉ)
- **Paid (ูุฏููุนุฉ):** ูููุฏ ูุงููุฉ ูุงููุฉ

**ูุฐุง ุงูููุท ูุทุงุจู 100% ูููุท Zoho Books**

---

## โ๏ธ ุชุญุฐูุฑุงุช ูููุฉ

1. **ูุง ุชูู ุฃุจุฏุงู ุจุฅูุดุงุก ููุงุชูุฑ ุจุฏูู ุฃุตูุงู**
2. **ูุง ุชูู ุจุชุนุฏูู ุงููููุฏ ุงููุญุงุณุจูุฉ ูุฏููุงู** - ุงุณุชุฎุฏู ูุงุฌูุฉ ุงููุธุงู
3. **ูุง ุชูู ุจุญุฐู ุญุฑูุงุช ุงููุฎุฒูู ูุฏููุงู** - ุงุณุชุฎุฏู ูุงุฌูุฉ ุงููุธุงู
4. **ูู ุจุชุดุบูู Health Check ุฏูุฑูุงู** ููุชุฃูุฏ ูู ุณูุงูุฉ ุงูุจูุงูุงุช
5. **ุฑุงุฌุน ุงูุชูุงุฑูุฑ ุงููุงููุฉ ุดูุฑูุงู** ููุชุฃูุฏ ูู ุงูุชุทุงุจู

---

## ๐ ูู ุญุงูุฉ ูุฌูุฏ ูุดุงูู

1. ูู ุจุชุดุบูู: `npm run inventory:audit`
2. ูู ุจุชุดุบูู: `node scripts/automated-health-check.js`
3. ุฑุงุฌุน ุงูุชูุฑูุฑ: `health-check-report.json`
4. ุงุณุชุฎุฏู ุฃุฏูุงุช ุงูุฅุตูุงุญ ุงููุชููุฑุฉ ูู `scripts/`

---

**ุขุฎุฑ ุชุญุฏูุซ:** 2025-12-24  
**ุงูุฅุตุฏุงุฑ:** 1.0  
**ุงูุญุงูุฉ:** โ ูุทุจู ูููุนูู

