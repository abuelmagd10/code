# تحليل منطق العمل - الفواتير (Invoices Business Logic)

## 1. دورة حياة الفاتورة (Invoice Lifecycle)
تنتقل الفاتورة عبر الحالات التالية:
- **Draft (مسودة):** الحالة الأولية. قابلة للتعديل والحذف. لا تؤثر على المخزون أو الحسابات.
- **Sent (مرسلة):** تم اعتماد الفاتورة. يتم خصم المخزون. يتم إثبات الاستحقاق (AR).
- **Paid (مدفوعة):** تم استلام كامل المبلغ.
- **Partially Paid (مدفوعة جزئياً):** تم استلام جزء من المبلغ.
- **Returned / Fully Returned (مرتجعة):** تم إرجاع البضاعة بالكامل.
- **Partially Returned (مرتجعة جزئياً):** تم إرجاع جزء من البضاعة.
- **Cancelled (ملغاة):** تم إلغاء الفاتورة (عادة قبل الدفع/الإرسال أو كبديل للحذف).

## 2. قواعد الحذف (Deletion Rules)
تم تطبيق حمايات صارمة لمنع حذف البيانات المؤثرة محاسبياً:
- **المسموح:** حذف الفواتير في حالة `draft` فقط.
- **الممنوع:**
  - الفواتير التي لها حركات مخزون (`inventory_transactions`).
  - الفواتير التي لها قيود محاسبية (`journal_entries`).
  - الفواتير التي لها دفعات مسجلة (`payments`).
- **عند الحذف:**
  - يتم حذف بنود الفاتورة (`invoice_items`).
  - يتم فك ارتباط أمر البيع (`sales_orders`) وإعادته لحالة `draft`.

## 3. منطق المرتجعات (Returns Logic)
المرتجع هو عملية معقدة تشمل المخزون والحسابات:
- **التحقق:**
  - لا يمكن عمل مرتجع لفاتورة `draft` أو `cancelled`.
  - يجب توفر كمية متاحة للإرجاع (الكمية الأصلية - ما تم إرجاعه سابقاً).
  - للفواتير المدفوعة، يجب وجود قيود محاسبية أصلية لضمان سلامة التدقيق.
- **التأثير المخزني:**
  - يتم إنشاء حركة `sale_return` تزيد المخزون.
  - يدعم النظام "الإرجاع كرصيد فقط" (Credit Only) للبضائع التالفة التي لا تعود للمخزون.
- **التأثير المالي:**
  - يتم إنشاء رصيد دائن للعميل (`customer_credits`) بقيمة المرتجع.
  - **للفواتير المرسلة (`sent`):** يتم تعديل قيد الذمم (`AR`) الأصلي وتحديث الفاتورة مباشرة (تخفيض القيمة).
  - **للفواتير المدفوعة (`paid`):** يتم إنشاء قيد محاسبي جديد يعكس الإيراد والضريبة (`Revenue` & `VAT`) مقابل رصيد العميل.
- **تحديث الفاتورة:**
  - يتم تحديث `returned_amount` و `total_amount` و `paid_amount` (يتم عكس جزء من المدفوعات لرصيد العميل).

## 4. العلاقة مع أوامر البيع (Sales Orders Linkage)
- العلاقة: `1 Sales Order` -> `1 Invoice` (حالياً، أو `1:N` نظرياً ولكن الكود يتعامل مع `sales_order_id` في الفاتورة).
- **تزامن الحالة:**
  - `Invoice Created` -> `Order Status: Invoiced`
  - `Invoice Returned` -> `Order Status: Returned` / `Partially Returned`
  - `Invoice Deleted` -> `Order Status: Draft`

## 5. الصلاحيات (Permissions)
- `view`: للجميع (مع تصفية للموظفين العاديين لرؤية فواتيرهم فقط).
- `create/edit`: للموظفين المصرح لهم.
- `delete`: مقيدة جداً (فقط Draft).
- `return`: تتطلب صلاحيات خاصة وتدقيق مالي.

## 6. ملاحظات فنية (Technical Implementation)
- يتم استخدام `RPC` (`update_invoice_after_return`) لتحديث الفواتير المدفوعة لتجاوز قيود التكامل المرجعي أحياناً أو لضمان الذرية (Atomicity).
- يتم استخدام `useTransition` لتحسين أداء الفلترة في الواجهة الأمامية.
- يتم الاعتماد على `getActiveCompanyId` لضمان العزل بين الشركات (Multi-tenancy).
