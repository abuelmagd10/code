# ๐ ููุธููุฉ ุงููุณุฎ ุงูุงุญุชูุงุทู ูุงูุงุณุชุนุงุฏุฉ - ุฏููู ุงูุชูููุฐ

## ๐ ูุธุฑุฉ ุนุงูุฉ

ุชู ุชูููุฐ ููุธููุฉ ูุณุฎ ุงุญุชูุงุทู ูุงุณุชุนุงุฏุฉ ุงุญุชุฑุงููุฉ ูุขููุฉ ููุธุงู ERB_VitaSlims ERPุ ูุตููุฉ ูุชููู:
- โ **ุขููุฉ**: ุตูุงุญูุงุช ูุญุฏุฏุฉุ ุชุญูู ูุฒุฏูุฌุ ุชุณุฌูู ูุงูู
- โ **ููุซููุฉ**: ูุญุต ุดุงูู ูุจู ุงูุงุณุชุนุงุฏุฉุ ุชุญูู ูู ุงูุณูุงูุฉ
- โ **ุงุญุชุฑุงููุฉ**: ูุงุฌูุฉ ูุณุชุฎุฏู ูุงุถุญุฉุ ุฑุณุงุฆู ูููููุฉุ ุชูุงุฑูุฑ ุชูุตูููุฉ
- โ **ุขููุฉ ููุฅูุชุงุฌ**: ูุง ุชุนุฏูู ุนูู ุงูููุทู ุงููุญุงุณุจูุ Additive Only

---

## ๐๏ธ ุงูุจููุฉ ุงููุนูุงุฑูุฉ

### 1. ุงููููุงุช ุงูุฃุณุงุณูุฉ

#### Backend (Server-side)
```
lib/backup/
โโโ types.ts                 # ุฃููุงุน ุงูุจูุงูุงุช ูุงูุซูุงุจุช
โโโ export-utils.ts          # ุฏูุงู ุงูุชุตุฏูุฑ
โโโ validation-utils.ts      # ุฏูุงู ุงูุชุญูู
โโโ restore-utils.ts         # ุฏูุงู ุงูุงุณุชุนุงุฏุฉ

app/api/backup/
โโโ export/route.ts          # API: ุชุตุฏูุฑ ูุณุฎุฉ ุงุญุชูุงุทูุฉ
โโโ validate/route.ts        # API: ุงูุชุญูู ูู ุตุญุฉ ุงููุณุฎุฉ
โโโ restore/route.ts         # API: ุงุณุชุนุงุฏุฉ ูุณุฎุฉ ุงุญุชูุงุทูุฉ
```

#### Frontend (Client-side)
```
app/settings/backup/
โโโ page.tsx                 # ุตูุญุฉ ุงููุณุฎ ุงูุงุญุชูุงุทู ุงูุฑุฆูุณูุฉ

components/backup/
โโโ RestoreDialog.tsx        # ูุงูุฐุฉ ุงูุงุณุชุนุงุฏุฉ ูุน ุงูุชุญูู
โโโ ValidationReport.tsx     # ุชูุฑูุฑ ุงูุชุญูู ุงูุชูุตููู
```

---

## ๐ ูุธุงู ุงูุตูุงุญูุงุช

### ุงูุชุตุฏูุฑ (Export)
- **ุงููุณููุญ**: Owner, Admin
- **ุงูุชุญูู**: `requireOwnerOrAdmin()`
- **ุงูุณุจุจ**: ุญูุงูุฉ ุงูุจูุงูุงุช ุงูุญุณุงุณุฉ

### ุงูุงุณุชุนุงุฏุฉ (Restore)
- **ุงููุณููุญ**: Owner ููุท
- **ุงูุชุญูู**: `requireOwner()`
- **ุงูุณุจุจ**: ุนูููุฉ ุฎุทูุฑุฉ ุชุณุชุจุฏู ุฌููุน ุงูุจูุงูุงุช

---

## ๐ฆ ูููู ููู ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ

```json
{
  "metadata": {
    "version": "2.0",
    "system_version": "1.0.0",
    "created_at": "2024-01-01T00:00:00Z",
    "created_by": "user-id",
    "company_id": "company-id",
    "company_name": "ุดุฑูุฉ ุงููุซุงู",
    "backup_type": "full",
    "total_records": 1500,
    "checksum": "sha256-hash"
  },
  "schema_info": {
    "tables": ["companies", "invoices", ...],
    "table_versions": {}
  },
  "data": {
    "companies": [...],
    "chart_of_accounts": [...],
    "invoices": [...],
    ...
  },
  "excluded_data": {
    "reason": "security",
    "tables": ["auth.users", "auth.sessions", ...]
  }
}
```

---

## ๐ ุณูุฑ ุงูุนูู (Workflow)

### ุนูููุฉ ุงูุชุตุฏูุฑ

```
1. ุงููุณุชุฎุฏู ูุถุบุท "ุชุตุฏูุฑ ูุณุฎุฉ ุงุญุชูุงุทูุฉ"
   โ
2. ุงูุชุญูู ูู ุงูุตูุงุญูุงุช (Owner/Admin)
   โ
3. ุฌูุน ุงูุจูุงูุงุช ูู ุฌููุน ุงูุฌุฏุงูู (ุญุณุจ ุงูุชุฑุชูุจ)
   โ
4. ุงุณุชุจุนุงุฏ ุงูุจูุงูุงุช ุงูุญุณุงุณุฉ (passwords, tokens)
   โ
5. ุญุณุงุจ Checksum ููุชุญูู ูู ุงูุณูุงูุฉ
   โ
6. ุชุณุฌูู ูู Audit Log
   โ
7. ุชูุฒูู ููู JSON
```

### ุนูููุฉ ุงูุงุณุชุนุงุฏุฉ

```
1. ุงููุณุชุฎุฏู ูุฎุชุงุฑ ููู ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ
   โ
2. ูุฑุงุกุฉ ูุชุญููู ุงูููู
   โ
3. ูุฑุญูุฉ ุงูุชุญูู (Validation Phase)
   โโโ ุงูุชุญูู ูู ุฅุตุฏุงุฑ ุงููุธุงู
   โโโ ุงูุชุญูู ูู Checksum
   โโโ ุงูุชุญูู ูู ุฃู ุงูุดุฑูุฉ ูุงุฑุบุฉ
   โโโ ุงูุชุญูู ูู ุณูุงูุฉ ุงูุนูุงูุงุช (Foreign Keys)
   โโโ ุงูุชุญูู ูู ุณูุงูุฉ ุงููููุฏ ุงููุญุงุณุจูุฉ
   โ
4. ุนุฑุถ ุชูุฑูุฑ ุงูุชุญูู ุงูุชูุตููู
   โโโ ูุนูููุงุช ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ
   โโโ ููุฎุต ุงูุนูููุฉ (ุนุฏุฏ ุงูุณุฌูุงุชุ ุงูููุช ุงููุชููุน)
   โโโ ุชูุงุตูู ุงูุฌุฏุงูู
   โโโ ุงูุชุญุฐูุฑุงุช ูุงูุฃุฎุทุงุก
   โโโ ุชูููู ุงููุฎุงุทุฑ
   โ
5. ูุฑุญูุฉ ุงูุชุฃููุฏ ุงููุฒุฏูุฌ (Double Confirmation)
   โโโ ูุชุงุจุฉ "RESTORE" ููุชุฃููุฏ
   โโโ ุชุญุฏูุฏ checkbox "ุฃููู ุฃู ูุฐู ุงูุนูููุฉ ูุง ูููู ุงูุชุฑุงุฌุน ุนููุง"
   โ
6. ูุฑุญูุฉ ุงูุชูููุฐ (Execution Phase)
   โโโ ุญุฐู ุงูุจูุงูุงุช ุงูุญุงููุฉ (ุจุชุฑุชูุจ ุนูุณู)
   โโโ ุงุณุชุนุงุฏุฉ ุงูุจูุงูุงุช (ุญุณุจ ุงูุชุฑุชูุจ)
   โโโ ุงูุชุญูู ูู ุงูุณูุงูุฉ ุจุนุฏ ุงูุงุณุชุนุงุฏุฉ
   โโโ ุชุณุฌูู ูู Audit Log
   โ
7. ุฅุนุงุฏุฉ ุชุญููู ุงูุตูุญุฉ
```

---

## โ ูุญูุตุงุช ุงูุชุญูู (Validation Checks)

### 1. ุงูุชุญูู ูู ุฅุตุฏุงุฑ ุงููุธุงู
- **ุงููุฏู**: ุถูุงู ุชูุงูู ุงููุณุฎุฉ ูุน ุงููุธุงู ุงูุญุงูู
- **ุงููุญุต**: `backup.system_version === CURRENT_VERSION`

### 2. ุงูุชุญูู ูู Checksum
- **ุงููุฏู**: ุถูุงู ุนุฏู ุชูู ุงูุจูุงูุงุช
- **ุงููุญุต**: `SHA256(data) === backup.checksum`

### 3. ุงูุชุญูู ูู ุฃู ุงูุดุฑูุฉ ูุงุฑุบุฉ
- **ุงููุฏู**: ููุน ููุฏุงู ุงูุจูุงูุงุช ุงูุญุงููุฉ
- **ุงููุญุต**: `invoices.count === 0 && journal_entries.count === 0`

### 4. ุงูุชุญูู ูู ุณูุงูุฉ ุงูุนูุงูุงุช
- **ุงููุฏู**: ุถูุงู ุนุฏู ูุฌูุฏ ุนูุงูุงุช ููุณูุฑุฉ
- **ุงููุญุต**: ุฌููุน `customer_id` ูู `invoices` ููุฌูุฏุฉ ูู `customers`

### 5. ุงูุชุญูู ูู ุณูุงูุฉ ุงููููุฏ ุงููุญุงุณุจูุฉ
- **ุงููุฏู**: ุถูุงู ุชูุงุฒู ุงููููุฏ
- **ุงููุญุต**: `SUM(debit) === SUM(credit)` ููู ููุฏ

---

## ๐ ุงูุฃูุงู ูุงูุญูุงูุฉ

### 1. ุงุณุชุจุนุงุฏ ุงูุจูุงูุงุช ุงูุญุณุงุณุฉ
```typescript
const EXCLUDED_FIELDS = [
  'password', 'encrypted_password', 'password_hash',
  'api_key', 'secret_key', 'access_token', 'refresh_token'
]

const EXCLUDED_TABLES = [
  'auth.users', 'auth.sessions', 'auth.refresh_tokens',
  'company_invitations'
]
```

### 2. ุชุณุฌูู ุฌููุน ุงูุนูููุงุช
```typescript
await logAudit({
  company_id: companyId,
  user_id: user.id,
  action: 'backup_export',
  target_table: 'system',
  target_id: companyId,
  description: `ุชุตุฏูุฑ ูุณุฎุฉ ุงุญุชูุงุทูุฉ ูุงููุฉ (${totalRecords} ุณุฌู)`,
  metadata: { total_records, size_mb, duration_seconds }
})
```

### 3. ุฑุณุงุฆู ุฎุทุฃ ุขููุฉ
- โ **ูุง ุชุนุฑุถ**: ุชูุงุตูู SQLุ ุฃุฎุทุงุก Supabase ุงูุฏุงุฎููุฉ
- โ **ุชุนุฑุถ**: ุฑุณุงุฆู ูุงุถุญุฉ ููููููุฉ ูููุณุชุฎุฏู
- โ **ุชุณุฌู**: ุงูุฃุฎุทุงุก ุงูุชูุตูููุฉ ูู Console ููุท

---

## ๐ ุชุฑุชูุจ ุงูุฌุฏุงูู (Critical!)

```typescript
const EXPORT_ORDER = [
  // 1. ุงูุฌุฏุงูู ุงููุณุชููุฉ
  'companies', 'chart_of_accounts', 'customers', 'suppliers', 'products',
  
  // 2. ุงููุณุชูุฏุงุช ุงูุฑุฆูุณูุฉ
  'invoices', 'bills', 'sales_orders', 'purchase_orders',
  
  // 3. ุชูุงุตูู ุงููุณุชูุฏุงุช
  'invoice_items', 'bill_items', 'sales_order_items',
  
  // 4. ุงููููุฏ ูุงููุฏููุนุงุช
  'journal_entries', 'journal_entry_lines', 'payments',
  
  // 5. ุงููุฎุฒูู ูุงูุฃุตูู
  'inventory_transactions', 'fixed_assets'
]
```

**โ๏ธ ููู ุฌุฏุงู**: ูุฌุจ ุงูุงูุชุฒุงู ุจูุฐุง ุงูุชุฑุชูุจ ูุชุฌูุจ ุฃุฎุทุงุก Foreign Key!

---

## ๐งช ุณููุงุฑูู ุงูุงุฎุชุจุงุฑ

```bash
# 1. ุฅูุดุงุก ุจูุงูุงุช ุชุฌุฑูุจูุฉ
- ุฅูุดุงุก ุดุฑูุฉ ุฌุฏูุฏุฉ
- ุฅุถุงูุฉ 10 ุนููุงุก
- ุฅุถุงูุฉ 5 ููุงุชูุฑ
- ุฅุถุงูุฉ 3 ูููุฏ ูุญุงุณุจูุฉ

# 2. ุชุตุฏูุฑ ูุณุฎุฉ ุงุญุชูุงุทูุฉ
- ุชุณุฌูู ุงูุฏุฎูู ูู Owner
- ุงูุฐูุงุจ ุฅูู ุงูุฅุนุฏุงุฏุงุช > ุงููุณุฎ ุงูุงุญุชูุงุทู
- ุงูุถุบุท ุนูู "ุชุตุฏูุฑ ูุณุฎุฉ ุงุญุชูุงุทูุฉ ูุงููุฉ"
- ุญูุธ ุงูููู

# 3. ุญุฐู ุงูุจูุงูุงุช
- ุญุฐู ุฌููุน ุงูููุงุชูุฑ
- ุญุฐู ุฌููุน ุงููููุฏ ุงููุญุงุณุจูุฉ

# 4. ุงุณุชุนุงุฏุฉ ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ
- ุงุฎุชูุงุฑ ููู ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ
- ูุฑุงุฌุนุฉ ุชูุฑูุฑ ุงูุชุญูู
- ูุชุงุจุฉ "RESTORE" ููุชุฃููุฏ
- ุชุญุฏูุฏ checkbox
- ุงูุถุบุท ุนูู "ุงุณุชุนุงุฏุฉ ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ"

# 5. ุงูุชุญูู ูู ุงููุชุงุฆุฌ
โ ุฌููุน ุงูููุงุชูุฑ ุนุงุฏุช
โ ุฌููุน ุงููููุฏ ุงููุญุงุณุจูุฉ ุนุงุฏุช
โ ุงูุฃุฑุตุฏุฉ ูุชุทุงุจูุฉ 100%
โ ูุง ุชูุฌุฏ ุฃุฎุทุงุก Foreign Key
โ ุฌููุน ุงููููุฏ ูุชูุงุฒูุฉ
```

---

## ๐ ููุงุญุธุงุช ูููุฉ

### โ ูุง ุชู ุชูููุฐู
- [x] ูุธุงู ุชุตุฏูุฑ ุขูู ูุน ุงุณุชุจุนุงุฏ ุงูุจูุงูุงุช ุงูุญุณุงุณุฉ
- [x] ูุธุงู ุชุญูู ุดุงูู ูุจู ุงูุงุณุชุนุงุฏุฉ
- [x] ุชูุฑูุฑ ุชูุตููู ูุจู ุงูุชูููุฐ
- [x] ุชุฃููุฏ ูุฒุฏูุฌ ูุจู ุงูุงุณุชุนุงุฏุฉ
- [x] ุตูุงุญูุงุช ูุญุฏุฏุฉ (Owner/Admin)
- [x] ุชุณุฌูู ูุงูู ูู Audit Log
- [x] ูุงุฌูุฉ ูุณุชุฎุฏู ุงุญุชุฑุงููุฉ
- [x] ุฑุณุงุฆู ูุงุถุญุฉ ุบูุฑ ุชูููุฉ

### โ๏ธ ุงููููุฏ ุงูุญุงููุฉ
- ุงููุธุงู ูุฏุนู ููุท **RESTORE_TO_EMPTY** (ุงุณุชุนุงุฏุฉ ูุดุฑูุฉ ูุงุฑุบุฉ)
- ูุง ูุฏุนู **RESTORE_WITH_MERGE** (ุฏูุฌ ุฐูู) - ูุนูุฏ ุฌุฏุงู ุญุงููุงู
- ูุฌุจ ุฃู ุชููู ุงูุดุฑูุฉ ุงููุณุชูุฏูุฉ ูุงุฑุบุฉ ุชูุงูุงู

### ๐ฎ ุชุญุณููุงุช ูุณุชูุจููุฉ
- [ ] ุฏุนู ุงููุณุฎ ุงูุงุญุชูุงุทู ุงูุฌุฒุฆู (Partial Backup)
- [ ] ุฏุนู ุงููุณุฎ ุงูุงุญุชูุงุทู ุงููุฌุฏูู (Scheduled Backup)
- [ ] ุฏุนู ุงูุชุฎุฒูู ุงูุณุญุงุจู (S3, Google Drive)
- [ ] ุฏุนู ุงูุงุณุชุนุงุฏุฉ ุงูุงูุชูุงุฆูุฉ (Selective Restore)
- [ ] ุฏุนู ุงูุฏูุฌ ุงูุฐูู (Smart Merge)

---

## ๐ฏ ุงูุฎูุงุตุฉ

ุชู ุชูููุฐ ููุธููุฉ ูุณุฎ ุงุญุชูุงุทู ูุงุณุชุนุงุฏุฉ ุงุญุชุฑุงููุฉ ูุขููุฉุ ุฌุงูุฒุฉ ููุงุณุชุฎุฏุงู ูู ุจูุฆุงุช ุงูุฅูุชุงุฌุ ูุน:
- โ **ุฃูุงู ูุงูู**: ุตูุงุญูุงุชุ ุชุญููุ ุชุณุฌูู
- โ **ููุซูููุฉ ุนุงููุฉ**: ูุญุต ุดุงููุ ุชุญูู ูู ุงูุณูุงูุฉ
- โ **ุชุฌุฑุจุฉ ูุณุชุฎุฏู ููุชุงุฒุฉ**: ูุงุถุญุฉุ ูููููุฉุ ุงุญุชุฑุงููุฉ
- โ **Additive Only**: ูุง ุชุนุฏูู ุนูู ุงูููุทู ุงููุญุงุณุจู

**ุฌุงูุฒ ููุงุฎุชุจุงุฑ ูุงูุฅูุชุงุฌ! ๐**

