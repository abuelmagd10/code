name: CI - Tests & Lint

# This workflow runs on every push to main/develop branches
# - Critical tests: Always run (no database required)
# - Integration tests: Only run if Supabase credentials are configured
# - E2E tests: Only run if Supabase credentials are configured
# - Security checks: Always run
# Last updated: 2026-01-27

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest

    env:
      NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
      SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
      NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint || echo "Linter not configured - skipping"
        continue-on-error: true

      - name: Run critical tests
        run: npm test -- tests/critical
        continue-on-error: false

      - name: Check Supabase credentials
        id: check-credentials
        run: |
          if [ -n "${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}" ] && [ -n "${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" ]; then
            echo "credentials_available=true" >> $GITHUB_OUTPUT
          else
            echo "credentials_available=false" >> $GITHUB_OUTPUT
          fi

      - name: Run API integration tests
        if: steps.check-credentials.outputs.credentials_available == 'true'
        run: npm test -- tests/integration
        continue-on-error: true

      - name: Skip integration tests (no credentials)
        if: steps.check-credentials.outputs.credentials_available == 'false'
        run: echo "âš ï¸ Skipping integration tests - Supabase credentials not configured"

      - name: Run E2E tests
        if: steps.check-credentials.outputs.credentials_available == 'true'
        run: npm test -- tests/e2e
        continue-on-error: true

      - name: Skip E2E tests (no credentials)
        if: steps.check-credentials.outputs.credentials_available == 'false'
        run: echo "âš ï¸ Skipping E2E tests - Supabase credentials not configured"

  security-check:
    name: Security Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for secureApiRequest usage
        run: |
          # Check that critical endpoints use secureApiRequest
          if ! grep -r "requireOwnerOrAdmin\|secureApiRequest" app/api/fix-inventory/route.ts; then
            echo "âŒ fix-inventory missing secureApiRequest"
            exit 1
          fi
          if ! grep -r "requireOwnerOrAdmin\|secureApiRequest" app/api/fix-sent-invoice-journals/route.ts; then
            echo "âŒ fix-sent-invoice-journals missing secureApiRequest"
            exit 1
          fi
          if ! grep -r "requireOwnerOrAdmin\|secureApiRequest" app/api/repair-invoice/route.ts; then
            echo "âŒ repair-invoice missing secureApiRequest"
            exit 1
          fi
          echo "âœ… Security checks passed"

      - name: Check for NextResponse.json usage in critical endpoints
        run: |
          # Critical endpoints should NOT use NextResponse.json for errors
          if grep -r "NextResponse.json.*error" app/api/fix-inventory/route.ts; then
            echo "âŒ fix-inventory still uses NextResponse.json for errors"
            exit 1
          fi
          if grep -r "NextResponse.json.*error" app/api/fix-sent-invoice-journals/route.ts; then
            echo "âŒ fix-sent-invoice-journals still uses NextResponse.json for errors"
            exit 1
          fi
          echo "âœ… Error handling checks passed"

  deploy:
    name: Deploy to Vercel (production)
    needs: [test, security-check]
    runs-on: ubuntu-latest
    # âœ… Ù†Ø´Ø± ÙÙ‚Ø· Ø¹Ù†Ø¯ push Ù…Ø¨Ø§Ø´Ø±Ø© Ø¹Ù„Ù‰ main (Ù„ÙŠØ³ Ø¹Ù„Ù‰ PR)
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    env:
      VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
      VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
      VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      # ğŸ” Ø³Ø­Ø¨ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Vercel Ù„Ù„Ø¨ÙŠØ¦Ø© Ø§Ù„Ø¥Ù†ØªØ§Ø¬ÙŠØ©
      - name: Pull Vercel environment
        run: npx vercel pull --yes --environment=production --token=$VERCEL_TOKEN

      # ğŸ—ï¸ Ø¨Ù†Ø§Ø¡ Ù…Ø³Ø¨Ù‚ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Vercel
      - name: Build project with Vercel
        run: npx vercel build --prod --token=$VERCEL_TOKEN

      # ğŸš€ Ù†Ø´Ø± Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø¨Ù†ÙŠØ© Ø¥Ù„Ù‰ Ø§Ù„Ø¥Ù†ØªØ§Ø¬
      - name: Deploy prebuilt artifacts to production
        run: npx vercel deploy --prebuilt --prod --token=$VERCEL_TOKEN

