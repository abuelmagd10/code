name: CI - Tests & Lint

# This workflow runs on every push to main/develop branches
# - Critical tests: Always run (no database required)
# - Integration tests: Only run if Supabase credentials are configured
# - E2E tests: Only run if Supabase credentials are configured
# - Security checks: Always run
# Last updated: 2025-12-21

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest

    env:
      NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
      SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
      NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint || echo "Linter not configured - skipping"
        continue-on-error: true

      - name: Run critical tests
        run: npm test -- tests/critical
        continue-on-error: false

      - name: Check Supabase credentials
        id: check-credentials
        run: |
          if [ -n "${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}" ] && [ -n "${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" ]; then
            echo "credentials_available=true" >> $GITHUB_OUTPUT
          else
            echo "credentials_available=false" >> $GITHUB_OUTPUT
          fi

      - name: Run API integration tests
        if: steps.check-credentials.outputs.credentials_available == 'true'
        run: npm test -- tests/integration
        continue-on-error: false

      - name: Skip integration tests (no credentials)
        if: steps.check-credentials.outputs.credentials_available == 'false'
        run: echo "⚠️ Skipping integration tests - Supabase credentials not configured"

      - name: Run E2E tests
        if: steps.check-credentials.outputs.credentials_available == 'true'
        run: npm test -- tests/e2e
        continue-on-error: false

      - name: Skip E2E tests (no credentials)
        if: steps.check-credentials.outputs.credentials_available == 'false'
        run: echo "⚠️ Skipping E2E tests - Supabase credentials not configured"

  security-check:
    name: Security Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for secureApiRequest usage
        run: |
          # Check that critical endpoints use secureApiRequest
          if ! grep -r "requireOwnerOrAdmin\|secureApiRequest" app/api/fix-inventory/route.ts; then
            echo "❌ fix-inventory missing secureApiRequest"
            exit 1
          fi
          if ! grep -r "requireOwnerOrAdmin\|secureApiRequest" app/api/fix-sent-invoice-journals/route.ts; then
            echo "❌ fix-sent-invoice-journals missing secureApiRequest"
            exit 1
          fi
          if ! grep -r "requireOwnerOrAdmin\|secureApiRequest" app/api/repair-invoice/route.ts; then
            echo "❌ repair-invoice missing secureApiRequest"
            exit 1
          fi
          echo "✅ Security checks passed"

      - name: Check for NextResponse.json usage in critical endpoints
        run: |
          # Critical endpoints should NOT use NextResponse.json for errors
          if grep -r "NextResponse.json.*error" app/api/fix-inventory/route.ts; then
            echo "❌ fix-inventory still uses NextResponse.json for errors"
            exit 1
          fi
          if grep -r "NextResponse.json.*error" app/api/fix-sent-invoice-journals/route.ts; then
            echo "❌ fix-sent-invoice-journals still uses NextResponse.json for errors"
            exit 1
          fi
          echo "✅ Error handling checks passed"

