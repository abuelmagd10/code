# ๐ ููุฎุต ูุธุงู ุฅุดุนุงุฑุงุช ุฏุงุฆู ุงูููุฑุฏูู (Vendor Credits)

## ๐ฏ ูุธุฑุฉ ุนุงูุฉ

ุชู ุชุทููุฑ ูุธุงู **ุฅุดุนุงุฑุงุช ุฏุงุฆู ุงูููุฑุฏูู** ููุชูุงูู ูุน ุฃุนูู ูุนุงููุฑ ุงููุญุงุณุจุฉ ุงูุฏูููุฉ (IFRS) ููุทุจู:

โ **ูุตู ุงูููุงู** (Separation of Duties)  
โ **ุณูุฑ ุนูู ุงูููุงููุงุช** (Approval Workflow)  
โ **ุงูุชุญูู ูู ุงููุตูู** (Role-Based Access Control)  
โ **ุงูุชุชุจุน ุงููุงูู** (Complete Audit Trail)  
โ **ุงูุญูุงูุฉ ูู ุงูุชูุงุนุจ** (Data Protection)

---

## ๐ ุฏูุฑุฉ ุญูุงุฉ ุงูุฅุดุนุงุฑ

```
1. ูุณูุฏุฉ (Draft)
   โ
2. ูู ุงูุชุธุงุฑ ุงูููุงููุฉ (Pending Approval)
   โ
3. ููุงูู ุนููู (Approved) ุฃู ูุฑููุถ (Rejected)
   โ
4. ูุทุจู (Applied)
   โ
5. ูุบูู (Closed)
```

---

## ๐ฅ ุงูุฃุฏูุงุฑ ูุงูุตูุงุญูุงุช

### ๐ต ุงููุงูู (Owner)
- โ ุฅูุดุงุก ูุนุฑุถ ูุชุนุฏูู ุฌููุน ุงูุฅุดุนุงุฑุงุช
- โ ุงูููุงููุฉ ูุงูุชุทุจูู
- ๐ ูุฑู ุฌููุน ุงูุฅุดุนุงุฑุงุช ุจุฏูู ูููุฏ

### ๐ต ุงููุฏูุฑ (Admin)
- โ ุฅูุดุงุก ูุนุฑุถ ูุชุนุฏูู ุฌููุน ุงูุฅุดุนุงุฑุงุช
- โ ุงูููุงููุฉ ูุงูุชุทุจูู
- ๐ ูุฑู ุฌููุน ุงูุฅุดุนุงุฑุงุช ุจุฏูู ูููุฏ

### ๐ข ูุฏูุฑ ุงููุฑุน (Manager)
- โ ุฅูุดุงุก ูุนุฑุถ ูุชุนุฏูู ุฅุดุนุงุฑุงุช ุงููุฑุน
- โ ุงูููุงููุฉ ูุงูุชุทุจูู ูุฅุดุนุงุฑุงุช ุงููุฑุน
- ๐ ูุฑู ููุท ุฅุดุนุงุฑุงุช ูุฑุนู

### ๐ก ุงููุญุงุณุจ (Accountant)
- โ ุฅูุดุงุก ูุนุฑุถ ูุชุนุฏูู ุงูุฅุดุนุงุฑุงุช
- โ ุงูููุงููุฉ ูุงูุชุทุจูู
- ๐ ูุฑู ุฅุดุนุงุฑุงุช ูุฑุนู ููุฑูุฒ ุงูุชูููุฉ

### ๐ด ุงูููุธู (Staff)
- โ ุฅูุดุงุก ูุนุฑุถ ูุชุนุฏูู ุฅุดุนุงุฑุงุชู ููุท
- โ ูุง ููููู ุงูููุงููุฉ ุฃู ุงูุชุทุจูู
- ๐ ูุฑู ููุท ุงูุฅุดุนุงุฑุงุช ุงูุชู ุฃูุดุฃูุง

---

## ๐ ุงูุญููู ุงูุฌุฏูุฏุฉ

| ุงูุญูู | ุงููุตู |
|------|-------|
| `created_by` | ูู ุฃูุดุฃ ุงูุฅุดุนุงุฑ |
| `approval_status` | ุญุงูุฉ ุงูููุงููุฉ |
| `submitted_by` | ูู ูุฏู ููููุงููุฉ |
| `submitted_at` | ุชุงุฑูุฎ ุงูุชูุฏูู |
| `approved_by` | ูู ูุงูู |
| `approved_at` | ุชุงุฑูุฎ ุงูููุงููุฉ |
| `rejected_by` | ูู ุฑูุถ |
| `rejected_at` | ุชุงุฑูุฎ ุงูุฑูุถ |
| `rejection_reason` | ุณุจุจ ุงูุฑูุถ |
| `applied_by` | ูู ุทุจู ุงูุฅุดุนุงุฑ |
| `applied_at` | ุชุงุฑูุฎ ุงูุชุทุจูู |
| `application_payment_id` | ุณูุฏ ุงูุตุฑู ุงููุฑุชุจุท |
| `branch_id` | ุงููุฑุน |
| `cost_center_id` | ูุฑูุฒ ุงูุชูููุฉ |

---

## ๐ง ุงูุฏูุงู ุงููุชุงุญุฉ

### 1๏ธโฃ ุชูุฏูู ููููุงููุฉ
```sql
SELECT * FROM submit_vendor_credit_for_approval(
  p_vendor_credit_id := 'uuid',
  p_submitted_by := 'user-uuid'
);
```

### 2๏ธโฃ ุงูููุงููุฉ
```sql
SELECT * FROM approve_vendor_credit(
  p_vendor_credit_id := 'uuid',
  p_approved_by := 'user-uuid',
  p_notes := 'ููุงุญุธุงุช'
);
```
โ๏ธ **ููู:** ุงูููุดุฆ ูุง ููููู ุงูููุงููุฉ ุนูู ุฅุดุนุงุฑู (ูุตู ุงูููุงู)

### 3๏ธโฃ ุงูุฑูุถ
```sql
SELECT * FROM reject_vendor_credit(
  p_vendor_credit_id := 'uuid',
  p_rejected_by := 'user-uuid',
  p_rejection_reason := 'ุณุจุจ ุงูุฑูุถ'
);
```

### 4๏ธโฃ ุงูุชุทุจูู (ุฅูุดุงุก ุณูุฏ ุตุฑู)
```sql
SELECT * FROM apply_vendor_credit_to_payment(
  p_vendor_credit_id := 'uuid',
  p_payment_id := 'payment-uuid',
  p_amount_to_apply := 1000.00,
  p_applied_by := 'user-uuid'
);
```

---

## ๐ก๏ธ ุงูุญูุงูุฉ ูุงููููุฏ

### โ ูุง ูููู ูุนูู:
- ุชุนุฏูู ุงูุฅุดุนุงุฑ ูู ุญุงูุฉ **ูุณูุฏุฉ** ุฃู **ูุฑููุถ**
- ุญุฐู ุงูุฅุดุนุงุฑ ูู ุญุงูุฉ **ูุณูุฏุฉ** ุฃู **ูุฑููุถ**
- ุงูููุงููุฉ ูู ูุจู ุดุฎุต **ุบูุฑ ุงูููุดุฆ**

### โ ูุง ูุง ูููู ูุนูู:
- ุชุนุฏูู ุงูุฅุดุนุงุฑ ุจุนุฏ ุงูููุงููุฉ
- ุญุฐู ุงูุฅุดุนุงุฑ ุจุนุฏ ุงูุชูุฏูู ููููุงููุฉ
- ุงูููุงููุฉ ุนูู ุฅุดุนุงุฑ ุฃูุดุฃุชู ุฃูุช
- ุชุทุจูู ุฅุดุนุงุฑ ุบูุฑ ููุงูู ุนููู

---

## ๐ ูุซุงู ุนููู

### ุงูุณููุงุฑูู: ูุฑุชุฌุน ุจุถุงุนุฉ ุชุงููุฉ

#### 1. ุงูููุธู ููุดุฆ ุงูุฅุดุนุงุฑ
```typescript
const { data: vc } = await supabase
  .from('vendor_credits')
  .insert({
    company_id: companyId,
    supplier_id: supplierId,
    credit_number: 'VC-2026-001',
    total_amount: 5000,
    created_by: staffUserId,
    branch_id: branchId,
    approval_status: 'draft',
    notes: 'ูุฑุชุฌุน ุจุถุงุนุฉ ุชุงููุฉ - ูุงุชูุฑุฉ ุฑูู INV-123'
  })
```

#### 2. ุงูููุธู ููุฏู ููููุงููุฉ
```typescript
await supabase.rpc('submit_vendor_credit_for_approval', {
  p_vendor_credit_id: vc.id,
  p_submitted_by: staffUserId
})
```

#### 3. ุงููุฏูุฑ ููุงูู
```typescript
await supabase.rpc('approve_vendor_credit', {
  p_vendor_credit_id: vc.id,
  p_approved_by: managerId,
  p_notes: 'ุชู ุงูุชุญูู - ููุงูู'
})
```

#### 4. ุงููุญุงุณุจ ูุทุจู (ููุดุฆ ุณูุฏ ุตุฑู)
```typescript
// ุฅูุดุงุก ุณูุฏ ุงูุตุฑู
const { data: payment } = await supabase
  .from('payments')
  .insert({
    company_id: companyId,
    supplier_id: supplierId,
    amount: 5000,
    payment_type: 'vendor_credit_refund'
  })

// ุฑุจุท ุงูุฅุดุนุงุฑ ุจุณูุฏ ุงูุตุฑู
await supabase.rpc('apply_vendor_credit_to_payment', {
  p_vendor_credit_id: vc.id,
  p_payment_id: payment.id,
  p_amount_to_apply: 5000,
  p_applied_by: accountantId
})
```

---

## ๐ ุงูุชุซุจูุช

### 1. ุชุดุบูู ุงูุณูุฑูุจุช
```bash
psql -U your_user -d your_database -f scripts/100_vendor_credits_access_control_upgrade.sql
```

### 2. ุงูุชุญูู
```sql
-- ุงูุชุญูู ูู ุงูุญููู
SELECT column_name FROM information_schema.columns 
WHERE table_name = 'vendor_credits' 
  AND column_name IN ('created_by', 'approval_status');

-- ุงูุชุญูู ูู ุงูุฏูุงู
SELECT routine_name FROM information_schema.routines 
WHERE routine_name LIKE '%vendor_credit%';
```

---

## ๐ ุงููููุงุช ุงููููุฉ

1. **ุงูุจุฏุก ุงูุณุฑูุน:** `START_HERE_VENDOR_CREDITS.md`
2. **ุงูุฏููู ุงูุดุงูู:** `VENDOR_CREDITS_ACCESS_CONTROL_GUIDE.md`
3. **ุงูุณูุฑูุจุช:** `scripts/100_vendor_credits_access_control_upgrade.sql`
4. **ุงูููุฏ:** `lib/vendor-credits-access.ts`

---

## โ ุงูููุงุฆุฏ

โ **ุงูุชุซุงู ูุงูู** ูููุนุงููุฑ ุงููุญุงุณุจูุฉ ุงูุฏูููุฉ (IFRS)  
โ **ูุตู ุงูููุงู** ูููุน ุงูุชูุงุนุจ ูุงูุงุญุชูุงู  
โ **ุชุชุจุน ูุงูู** ููู ุฎุทูุฉ ูู ุฏูุฑุฉ ุงูุฅุดุนุงุฑ  
โ **ุญูุงูุฉ ุงูุจูุงูุงุช** ูู ุงูุชุนุฏูู ุฃู ุงูุญุฐู ุบูุฑ ุงููุตุฑุญ  
โ **ุชุญูู ุฏููู** ูู ุงููุตูู ุญุณุจ ุงูุฏูุฑ ูุงูุตูุงุญูุงุช  
โ **ูุงุจู ููุชุฏููู** ุจุงููุงูู ูุน ุณุฌู ุฒููู ููู ุนูููุฉ

---

**ุขุฎุฑ ุชุญุฏูุซ:** 2026-01-09  
**ุงูุฅุตุฏุงุฑ:** 2.0.0 - Access Control & Approval Workflow

