# ๐ ูุธุงู ุงูุงุณุชุฑุฏุงุฏ ุงูููุฏู (Refund Policy Engine)

## ๐ ูุธุฑุฉ ุนุงูุฉ

ูุธุงู ูุชูุงูู ูุฅุฏุงุฑุฉ ุทูุจุงุช ุงูุงุณุชุฑุฏุงุฏ ุงูููุฏู ูุน:
- โ ุญูููุฉ ูุงููุฉ (Company โ Branch โ Cost Center โ Warehouse)
- โ ุณูุฑ ุนูู ููุงููุงุช ูุชุนุฏุฏ ุงููุณุชููุงุช
- โ ููุน ุงูุชูุฑุงุฑ ูุงูุงุญุชูุงู
- โ ุชุฏููู ูุงูู ููู ุงูุนูููุงุช
- โ ุฑุจุท ุชููุงุฆู ุจุงููุณุชูุฏุงุช ุงูุฃุตููุฉ

---

## ๐ฏ ูุณุงุฑ ุงูุงุณุชุฑุฏุงุฏ ุงูููุฏู

### 1๏ธโฃ ุฅูุดุงุก ุทูุจ ุงูุงุณุชุฑุฏุงุฏ

**API**: `POST /api/refund-requests`

**ุงูุญููู ุงูุฅูุฒุงููุฉ**:
```typescript
{
  source_type: 'invoice' | 'sales_return' | 'payment',
  source_id: string,
  requested_amount: number,
  reason: string,
  attachments?: string[]  // ุงุฎุชูุงุฑู
}
```

**ุงูุชุญููุงุช ุงูุชููุงุฆูุฉ**:
- โ ุงููุณุชูุฏ ุงูุฃุตูู ููุฌูุฏ ูุตุงูุญ
- โ ุงููุณุชูุฏ ููุณ ููุบู ุฃู ูุณูุฏุฉ
- โ ูุง ููุฌุฏ ุทูุจ ุงุณุชุฑุฏุงุฏ ูุดุท ุขุฎุฑ
- โ ุงููุจูุบ ุงููุทููุจ ุตุญูุญ ููุง ูุชุฌุงูุฒ ุงููุชุจูู
- โ ุชุทุจูู ุงูุญูููุฉ ุงููุงููุฉ

**ุงูุญุงูุฉ ุงูุฃูููุฉ**: `pending`

---

### 2๏ธโฃ ุณูุฑ ุงูุนูู ููููุงููุฉ

#### ููุงุนุฏ ุงูููุงููุฉ ุญุณุจ ุงููุจูุบ:

| ุงููุจูุบ | ุงูููุงูููู ุงููุทููุจูู |
|--------|---------------------|
| 0 - 1,000 | ูุฏูุฑ ุงููุฑุน |
| 1,001 - 5,000 | ูุฏูุฑ ุงููุฑุน + ุงููุฏูุฑ ุงููุงูู |
| 5,001+ | ูุฏูุฑ ุงููุฑุน + ุงููุฏูุฑ ุงููุงูู + ุงููุฏูุฑ ุงูุนุงู |

#### ูุฑุงุญู ุงูููุงููุฉ:

```
pending โ branch_approved โ finance_approved โ approved
```

**API**: `POST /api/refund-requests/approve`

```typescript
{
  refund_request_id: string,
  approved_amount?: number,  // ุงุฎุชูุงุฑู - ุงูุชุฑุงุถูุงู ููุณ ุงููุจูุบ ุงููุทููุจ
  notes?: string
}
```

**ุงูุชุญููุงุช**:
- โ ุงููุณุชุฎุฏู ูุฏูู ุตูุงุญูุฉ ุงูููุงููุฉ ูู ูุฐู ุงููุฑุญูุฉ
- โ ุงูุทูุจ ูู ุงูุญุงูุฉ ุงูุตุญูุญุฉ
- โ ุชุณุฌูู ูู ูุงูู ููุชู

---

### 3๏ธโฃ ุฑูุถ ุงูุทูุจ

**API**: `POST /api/refund-requests/reject`

```typescript
{
  refund_request_id: string,
  rejection_reason: string  // ุฅูุฒุงูู
}
```

**ุงููุชูุฌุฉ**:
- ุงูุญุงูุฉ ุชุตุจุญ: `rejected`
- ุชุณุฌูู ูู ุฑูุถ ููุชู ูุงูุณุจุจ
- ูุง ูููู ุงูููุงููุฉ ุจุนุฏ ุงูุฑูุถ ุฅูุง ุจุฅุนุงุฏุฉ ุงููุชุญ

---

### 4๏ธโฃ ุฅุตุฏุงุฑ ุณูุฏ ุงูุตุฑู

**API**: `POST /api/refund-requests/disburse`

```typescript
{
  refund_request_id: string,
  payment_method: 'cash' | 'bank_transfer' | 'check',
  notes?: string
}
```

**ุงูุดุฑูุท**:
- โ ุงูุทูุจ ูู ุญุงูุฉ `approved`
- โ ูุง ููุฌุฏ ุณูุฏ ุตุฑู ูุณุจู (ููุน ุงูุชูุฑุงุฑ)
- โ ุชุทุจูู ุงูุญูููุฉ ุนูู ุณูุฏ ุงูุตุฑู

**ุงููุชูุฌุฉ**:
- ุฅูุดุงุก ุณูุฏ ุตุฑู ุฌุฏูุฏ
- ุฑุจุท ุงูุณูุฏ ุจุงูุทูุจ
- ุงูุญุงูุฉ ุชุตุจุญ: `disbursed`
- ุชุณุฌูู ูู ุตุฑู ููุชู

---

### 5๏ธโฃ ุฅุนุงุฏุฉ ูุชุญ ุงูุทูุจ

**API**: `POST /api/refund-requests/reopen`

```typescript
{
  refund_request_id: string,
  reason: string  // ุฅูุฒุงูู
}
```

**ุงูุดุฑูุท**:
- โ ููุท ุงููุฏูุฑ ุงูุนุงู ููููู ุฅุนุงุฏุฉ ุงููุชุญ
- โ ุงูุทูุจ ููุณ ูู ุญุงูุฉ `disbursed`
- โ ูุง ููุฌุฏ ุณูุฏ ุตุฑู ูุฑุชุจุท

**ุงููุชูุฌุฉ**:
- ุงูุญุงูุฉ ุชุนูุฏ ุฅูู: `pending`
- ุญุฐู ุฌููุน ุงูููุงููุงุช ุงูุณุงุจูุฉ
- ุชุณุฌูู ุณุจุจ ุฅุนุงุฏุฉ ุงููุชุญ

---

## ๐ ุงูุญูููุฉ ุงููุทุจูุฉ

### ุนูู ุทูุจุงุช ุงูุงุณุชุฑุฏุงุฏ:

```typescript
const governance = await enforceGovernance()
const dataWithGovernance = addGovernanceData(body, governance)
validateGovernanceData(dataWithGovernance, governance)
```

**ุงูุญููู ุงูุฅูุฒุงููุฉ**:
- `company_id` - ุนุฒู ุงูุดุฑูุงุช
- `branch_id` - ุงูุชุญูู ูู ุงููุฑูุน
- `cost_center_id` - ุงูุชุญูู ูู ูุฑุงูุฒ ุงูุชูููุฉ
- `warehouse_id` - ุงูุชุญูู ูู ุงููุณุชูุฏุนุงุช

### ุนูู ุณูุฏุงุช ุงูุตุฑู:

ููุณ ุงูุญูููุฉ ุชุทุจู ุนูู ุณูุฏุงุช ุงูุตุฑู ูุถูุงู:
- โ ุงูุณูุฏ ููุชูู ูููุณ ุงูุดุฑูุฉ
- โ ุงูุณูุฏ ููุชูู ูููุณ ุงููุฑุน
- โ ุงูุณูุฏ ูุฑุชุจุท ุจูุฑูุฒ ุงูุชูููุฉ ุงูุตุญูุญ
- โ ุงูุณูุฏ ูุฑุชุจุท ุจุงููุณุชูุฏุน ุงูุตุญูุญ

---

## ๐ซ ููุน ุงูุงุญุชูุงู ูุงูุชูุฑุงุฑ

### 1. ููุน ุทูุจุงุช ูุชุนุฏุฏุฉ ูุดุทุฉ:

```sql
CONSTRAINT unique_active_refund_per_source 
  UNIQUE (source_type, source_id, status) 
  WHERE status IN ('pending', 'branch_approved', 'finance_approved', 'approved')
```

### 2. ููุน ุณูุฏ ุตุฑู ููุฑุฑ:

```typescript
const duplicateCheck = await RefundPolicyEngine.preventDuplicateDisbursement(
  supabase,
  refund_request_id
)
```

### 3. ุงูุชุญูู ูู ุงููุจูุบ ุงููุชุจูู:

```typescript
const totalRefunded = previousRefunds.reduce((sum, r) => sum + r.approved_amount, 0)
const remainingAmount = maxAmount - totalRefunded

if (requestedAmount > remainingAmount) {
  throw new Error('ุงููุจูุบ ูุชุฌุงูุฒ ุงููุชุจูู ููุงุณุชุฑุฏุงุฏ')
}
```

---

## ๐ ุณุฌู ุงูุชุฏููู (Audit Trail)

### ุงูุฃุญุฏุงุซ ุงููุณุฌูุฉ:

| ุงูุญุฏุซ | ุงููุตู |
|-------|-------|
| `created` | ุฅูุดุงุก ุทูุจ ุฌุฏูุฏ |
| `approved` | ููุงููุฉ ุนูู ุงูุทูุจ |
| `rejected` | ุฑูุถ ุงูุทูุจ |
| `disbursed` | ุฅุตุฏุงุฑ ุณูุฏ ุงูุตุฑู |
| `reopened` | ุฅุนุงุฏุฉ ูุชุญ ุงูุทูุจ |
| `cancelled` | ุฅูุบุงุก ุงูุทูุจ |

### ุงูุจูุงูุงุช ุงููุณุฌูุฉ:

```typescript
{
  refund_request_id: string,
  action: string,
  user_id: string,
  details: {
    previous_status?: string,
    new_status?: string,
    approved_amount?: number,
    rejection_reason?: string,
    voucher_id?: string,
    // ... ุงููุฒูุฏ
  },
  created_at: timestamp
}
```

---

## ๐๏ธ ูููู ูุงุนุฏุฉ ุงูุจูุงูุงุช

### ุงูุฌุฏุงูู:

1. **refund_requests** - ุทูุจุงุช ุงูุงุณุชุฑุฏุงุฏ
2. **disbursement_vouchers** - ุณูุฏุงุช ุงูุตุฑู
3. **refund_audit_logs** - ุณุฌู ุงูุชุฏููู

### ุงูุนูุงูุงุช:

```
refund_requests
  โโโ source (invoice/sales_return/payment)
  โโโ requested_by โ users
  โโโ branch_approved_by โ users
  โโโ finance_approved_by โ users
  โโโ final_approved_by โ users
  โโโ rejected_by โ users
  โโโ disbursed_by โ users
  โโโ disbursement_voucher โ disbursement_vouchers

disbursement_vouchers
  โโโ refund_request โ refund_requests
  โโโ created_by โ users

refund_audit_logs
  โโโ refund_request โ refund_requests
  โโโ user โ users
```

---

## ๐ ุงูุฃูุงู

### Row Level Security (RLS):

```sql
-- ุนุฒู ุงูุดุฑูุงุช
CREATE POLICY refund_requests_company_isolation ON refund_requests
  FOR ALL
  USING (company_id IN (
    SELECT company_id FROM company_members WHERE user_id = auth.uid()
  ));
```

### ุตูุงุญูุงุช ุงูููุงููุฉ:

| ุงูุฏูุฑ | ุงูุตูุงุญูุงุช |
|-------|-----------|
| `manager` | ููุงููุฉ ูุฏูุฑ ุงููุฑุน |
| `accountant` | ููุงููุฉ ุงููุฏูุฑ ุงููุงูู |
| `gm` / `admin` | ุงูููุงููุฉ ุงูููุงุฆูุฉ |
| `gm` / `admin` | ุฅุนุงุฏุฉ ูุชุญ ุงูุทูุจุงุช |

---

## ๐ ุฃูุซูุฉ ุงูุงุณุชุฎุฏุงู

### ุฅูุดุงุก ุทูุจ ุงุณุชุฑุฏุงุฏ:

```typescript
const response = await fetch('/api/refund-requests', {
  method: 'POST',
  body: JSON.stringify({
    source_type: 'invoice',
    source_id: 'invoice-uuid',
    requested_amount: 500,
    reason: 'ููุชุฌ ูุนูุจ',
    attachments: ['photo1.jpg', 'photo2.jpg']
  })
})
```

### ุงูููุงููุฉ ุนูู ุงูุทูุจ:

```typescript
const response = await fetch('/api/refund-requests/approve', {
  method: 'POST',
  body: JSON.stringify({
    refund_request_id: 'request-uuid',
    approved_amount: 450,  // ุชุนุฏูู ุงููุจูุบ
    notes: 'ููุงูู ูุน ุชุฎููุถ 50 ุฑูุงู'
  })
})
```

### ุฅุตุฏุงุฑ ุณูุฏ ุงูุตุฑู:

```typescript
const response = await fetch('/api/refund-requests/disburse', {
  method: 'POST',
  body: JSON.stringify({
    refund_request_id: 'request-uuid',
    payment_method: 'cash',
    notes: 'ุชู ุงูุตุฑู ููุฏุงู'
  })
})
```

---

## โ ูุงุฆูุฉ ุงูุชุญูู

### ูุจู ุงูุฅูุชุงุฌ:

- [x] ุชุทุจูู ุงูุญูููุฉ ุนูู ุฌููุน APIs
- [x] ููุน ุงูุชูุฑุงุฑ ูุงูุงุญุชูุงู
- [x] ุณูุฑ ุนูู ุงูููุงููุงุช
- [x] ุณุฌู ุงูุชุฏููู ุงููุงูู
- [x] Row Level Security
- [x] ุงูุชุญูู ูู ุงูุตูุงุญูุงุช
- [x] ุฑุจุท ุจุงููุณุชูุฏุงุช ุงูุฃุตููุฉ
- [x] ููุน ุณูุฏ ุตุฑู ููุฑุฑ

### ุงูุงุฎุชุจุงุฑุงุช ุงููุทููุจุฉ:

- [ ] ุฅูุดุงุก ุทูุจ ุงุณุชุฑุฏุงุฏ ุตุญูุญ
- [ ] ุฑูุถ ุทูุจ ุจูุจูุบ ุฎุงุทุฆ
- [ ] ุฑูุถ ุทูุจ ููุณุชูุฏ ููุบู
- [ ] ุฑูุถ ุทูุจ ููุฑุฑ
- [ ] ุณูุฑ ุนูู ุงูููุงููุงุช ุงููุงูู
- [ ] ููุน ุตุฑู ุจุฏูู ููุงููุฉ
- [ ] ููุน ุณูุฏ ุตุฑู ููุฑุฑ
- [ ] ุฅุนุงุฏุฉ ูุชุญ ุทูุจ
- [ ] ุงูุชุญูู ูู ุณุฌู ุงูุชุฏููู

---

## ๐ฏ ุงูุฎูุงุตุฉ

ูุธุงู ุงูุงุณุชุฑุฏุงุฏ ุงูููุฏู ุงูุขู:

โ **ูุญูู ุจุงููุงูู** - ุญูููุฉ ุนูู 4 ูุณุชููุงุช  
โ **ููุงููุงุช ูุชุนุฏุฏุฉ** - ุญุณุจ ุงููุจูุบ ูุงูุฏูุฑ  
โ **ููุน ุงูุงุญุชูุงู** - ูุง ุชูุฑุงุฑุ ูุง ุชุฌุงูุฒ  
โ **ุชุฏููู ูุงูู** - ูู ุฎุทูุฉ ูุณุฌูุฉ  
โ **ุงุญุชุฑุงูู** - ุฌุงูุฒ ููุฅูุชุงุฌ

**๐ ุฌุงูุฒ ููุงุณุชุฎุฏุงู ูู ุจูุฆุฉ ุงูุฅูุชุงุฌ**

---

**ุชุงุฑูุฎ ุงูุฅูุดุงุก**: 2024-01-15  
**ุงูุฅุตุฏุงุฑ**: 1.0.0  
**ุงูุญุงูุฉ**: โ ููุชูู ููุฎุชุจุฑ
