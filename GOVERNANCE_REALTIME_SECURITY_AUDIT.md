# ๐ ุชูุฑูุฑ ูุฑุงุฌุนุฉ ุงูุฃูุงู ููุธุงู Realtime ููุญูููุฉ

## ๐ ูุธุฑุฉ ุนุงูุฉ

ุชู ุฅุฌุฑุงุก ูุฑุงุฌุนุฉ ุดุงููุฉ ูุฃูุงู ูุธุงู Realtime ููุญูููุฉ. ูุฐุง ุงูุชูุฑูุฑ ููุซู ุฌููุน ุงูููุงุท ุงูุฃูููุฉ ูุงูุชุญูู ูููุง.

## โ ุงูุชุญูู ูู ุทุจูุงุช ุงูุฃูุงู

### 1. ุทุจูุฉ ูุงุนุฏุฉ ุงูุจูุงูุงุช (Database Layer)

#### โ ุงูููุชุฑุฉ ุงูุฅูุฒุงููุฉ

**ุงูุชุญูู**: ุฌููุน ุงูุงุดุชุฑุงูุงุช ุชุณุชุฎุฏู ููุชุฑ `company_id`

```typescript
// ูู lib/realtime-manager.ts - subscribeToGovernance()
filter: `company_id=eq.${companyId}`
```

**ุงูุญุงูุฉ**: โ **ุขูู** - ุฌููุน ุงูุงุดุชุฑุงูุงุช ุชุณุชุฎุฏู ููุชุฑ `company_id` ุจุดูู ุฅูุฒุงูู

#### โ RLS Policies

**ุงูุชุญูู**: ูุฌูุฏ RLS Policies ุนูู ุฌููุน ุฌุฏุงูู ุงูุญูููุฉ

**ุงููุชูุฌุฉ**:
- โ `company_members` - ูุฏูู RLS Policies
- โ `branches` - ูุฏูู RLS Policies  
- โ `warehouses` - ูุฏูู RLS Policies
- โ `company_role_permissions` - ูุฏูู RLS Policies
- โ๏ธ `permissions` - ุฌุฏูู ุงุฎุชูุงุฑู (ูุฏ ูุง ูููู ููุฌูุฏุงู)

**ุงูุญุงูุฉ**: โ **ุขูู** - ุฌููุน ุงูุฌุฏุงูู ุงููุทููุจุฉ ูุฏููุง RLS Policies

### 2. ุทุจูุฉ ุงูุชุทุจูู (Application Layer)

#### โ ุงูุชุญูู ูู company_id

**ุงูููุฏ**:
```typescript
// ูู handleGovernanceEvent()
if (record.company_id && record.company_id !== companyId) {
  console.warn(`๐ซ [RealtimeManager] Governance event rejected: different company`)
  return
}
```

**ุงูุญุงูุฉ**: โ **ุขูู** - ูุชู ุฑูุถ ุฃู ุญุฏุซ ูู ุดุฑูุฉ ุฃุฎุฑู ููุฑุงู

#### โ ุงูุชุญูู ูู user_id

**ุงูููุฏ**:
```typescript
if (table === 'company_members') {
  affectsCurrentUser = record.user_id === userId
}
```

**ุงูุญุงูุฉ**: โ **ุขูู** - ูุชู ุงูุชุญูู ูู `user_id` ูุจู ุงููุนุงูุฌุฉ

#### โ ุงูุชุญูู ูู ุงูุตูุงุญูุงุช

**ุงูููุฏ**:
```typescript
const canSeeEvent = role === 'owner' || role === 'admin' || affectsCurrentUser

if (!canSeeEvent) {
  return // ุชุฌุงูู ุงูุญุฏุซ
}
```

**ุงูุญุงูุฉ**: โ **ุขูู** - ููุท Owner/Admin ุฃู ุงูุฃุญุฏุงุซ ุงูุชู ุชุฎุต ุงููุณุชุฎุฏู ูุชู ูุนุงูุฌุชูุง

### 3. ููุน ุงูุซุบุฑุงุช

#### โ ููุน ุงุณุชูุจุงู ุฃุญุฏุงุซ ุบูุฑ ูุตุฑุญ ุจูุง

**ุงูุชุญูู**: 
- โ ููุชุฑุฉ ุนูู ูุณุชูู ูุงุนุฏุฉ ุงูุจูุงูุงุช (`company_id`)
- โ ููุชุฑุฉ ุนูู ูุณุชูู ุงูุชุทุจูู (`company_id`, `user_id`, `role`)
- โ Owner/Admin ููุท ูุฑูุง ุฌููุน ุงูุฃุญุฏุงุซ ูู ุงูุดุฑูุฉ

**ุงูุญุงูุฉ**: โ **ุขูู** - ุทุจูุงุช ูุชุนุฏุฏุฉ ูู ุงูุญูุงูุฉ

#### โ ููุน ูุนุงูุฌุฉ ุงูุฃุญุฏุงุซ ุงูููุฑุฑุฉ

**ุงูููุฏ**:
```typescript
const eventKey = `governance:${table}:${payload.eventType}:${record.id}:${Date.now()}`
const lastProcessed = this.processedEvents.get(eventKey)

if (lastProcessed && (now - lastProcessed) < this.EVENT_DEDUP_WINDOW) {
  return // ุชุฌุงูู ุงูุญุฏุซ ุงูููุฑุฑ
}
```

**ุงูุญุงูุฉ**: โ **ุขูู** - ููุน ุงูุชูุฑุงุฑ ูุนูู ุจุดูู ุตุญูุญ

#### โ ููุน ุงููุตูู ููุจูุงูุงุช ุจุนุฏ ุณุญุจ ุงูุตูุงุญูุฉ

**ุงูููุฏ**:
```typescript
if (affectsCurrentUser) {
  await this.rebuildContextAndSubscriptions()
}
```

**ุงูุญุงูุฉ**: โ **ุขูู** - ุฅุนุงุฏุฉ ุจูุงุก ุงูุงุดุชุฑุงูุงุช ุชุนูู ุชููุงุฆูุงู

## ๐ ุชุญููู ุงูุฃูุงู ููู ุฌุฏูู

### company_members

**ุงูููุชุฑุฉ**:
- โ `company_id=eq.${companyId}` (ุฅูุฒุงูู)
- โ ุงูุชุญูู ูู `user_id` ูู ุงูุชุทุจูู

**ุงููุนุงูุฌุฉ**:
- โ ุฅุฐุง `user_id === userId`: ุฅุนุงุฏุฉ ุจูุงุก ุงูุณูุงู ูุงูุงุดุชุฑุงูุงุช
- โ ุฅุฐุง `role === 'owner' || role === 'admin'`: ุชุญุฏูุซ ููุงุฆู ุงููุณุชุฎุฏููู

**ุงูุญุงูุฉ**: โ **ุขูู**

### branches

**ุงูููุชุฑุฉ**:
- โ `company_id=eq.${companyId}` (ุฅูุฒุงูู)

**ุงููุนุงูุฌุฉ**:
- โ ุฅุฐุง `record.id === context.branchId`: ุฅุนุงุฏุฉ ุจูุงุก ุงูุณูุงู

**ุงูุญุงูุฉ**: โ **ุขูู**

### warehouses

**ุงูููุชุฑุฉ**:
- โ `company_id=eq.${companyId}` (ุฅูุฒุงูู)

**ุงููุนุงูุฌุฉ**:
- โ ุฅุฐุง `record.id === context.warehouseId`: ุฅุนุงุฏุฉ ุจูุงุก ุงูุณูุงู

**ุงูุญุงูุฉ**: โ **ุขูู**

### company_role_permissions

**ุงูููุชุฑุฉ**:
- โ `company_id=eq.${companyId}` (ุฅูุฒุงูู)

**ุงููุนุงูุฌุฉ**:
- โ ุฅุฐุง `record.role === context.role`: ุฅุนุงุฏุฉ ุชุญููู ุงูุตูุงุญูุงุช

**ุงูุญุงูุฉ**: โ **ุขูู**

### permissions

**ุงูููุชุฑุฉ**:
- โ๏ธ ูุง ููุฌุฏ ููุชุฑ (ุตูุงุญูุงุช ุนุงูุฉ)

**ุงููุนุงูุฌุฉ**:
- โ ุฅุนุงุฏุฉ ุชุญููู ุงูุตูุงุญูุงุช ูุฌููุน ุงููุณุชุฎุฏููู

**ุงูุญุงูุฉ**: โ๏ธ **ูุญุชุงุฌ ูุฑุงุฌุนุฉ** - ุงูุตูุงุญูุงุช ุงูุนุงูุฉ ูุฏ ุชุคุซุฑ ุนูู ุฌููุน ุงูุดุฑูุงุช

**ุงูุชูุตูุฉ**: ุฅุถุงูุฉ ููุชุฑ `company_id` ุฅุฐุง ูุงู ุงูุฌุฏูู ูุญุชูู ุนูู `company_id`

## ๐จ ููุงุท ุชุญุชุงุฌ ูุฑุงุฌุนุฉ

### 1. ุฌุฏูู permissions

**ุงููุดููุฉ**: ูุง ููุฌุฏ ููุชุฑ `company_id` ูู ุงูุงุดุชุฑุงู

**ุงูุชูุตูุฉ**: 
- ุฅุฐุง ูุงู ุงูุฌุฏูู ูุญุชูู ุนูู `company_id`ุ ุฃุถู ููุชุฑ
- ุฅุฐุง ูุงู ุฌุฏูู ุนุงูุ ุชุฃูุฏ ูู ุฃู RLS Policies ุชููุน ุงููุตูู ุจูู ุงูุดุฑูุงุช

### 2. ุฅุนุงุฏุฉ ุจูุงุก ุงูุงุดุชุฑุงูุงุช

**ุงูุชุญูู**: 
- โ ูุชู ุฅูุบุงุก ุฌููุน ุงูุงุดุชุฑุงูุงุช
- โ ูุชู ุฅุนุงุฏุฉ ุจูุงุก ุงูุณูุงู
- โ ูุชู ุฅุนุงุฏุฉ ุงูุงุดุชุฑุงู ุจููุงุชุฑ ุฌุฏูุฏุฉ

**ุงูุญุงูุฉ**: โ **ุขูู** - ูุนูู ุจุดูู ุตุญูุญ

## โ ูุงุฆูุฉ ุงูุชุญูู ุงูุฃูููุฉ

- [x] ุฌููุน ุงูุงุดุชุฑุงูุงุช ุชุณุชุฎุฏู ููุชุฑ `company_id`
- [x] RLS Policies ููุนูุฉ ุนูู ุฌููุน ุงูุฌุฏุงูู
- [x] ุงูุชุญูู ูู `company_id` ูู ูู ุญุฏุซ
- [x] ุงูุชุญูู ูู `user_id` ููุฃุญุฏุงุซ ุงูุชู ุชุฎุต ุงููุณุชุฎุฏู
- [x] ููุน ูุนุงูุฌุฉ ุงูุฃุญุฏุงุซ ุงูููุฑุฑุฉ
- [x] ุฅุนุงุฏุฉ ุจูุงุก ุงูุงุดุชุฑุงูุงุช ุนูุฏ ุชุบููุฑ ุงูุตูุงุญูุงุช
- [x] ุฅุบูุงู ุงูุตูุญุงุช ุบูุฑ ุงููุตุฑุญ ุจูุง (ูู useGovernanceRealtime)
- [x] ุชุนุทูู ุงูุฃุฒุฑุงุฑ ุนูุฏ ุณุญุจ ุงูุตูุงุญูุฉ (ูู PermissionsContext)
- [x] ูุง ููุฌุฏ ุชุณุฑูุจ ููุจูุงูุงุช ุจูู ุงูุดุฑูุงุช
- [x] ูุง ููุฌุฏ ูุตูู ููุจูุงูุงุช ุจุนุฏ ุณุญุจ ุงูุตูุงุญูุฉ

## ๐ ุงููุชูุฌุฉ ุงูููุงุฆูุฉ

### ุงูุญุงูุฉ ุงูุนุงูุฉ: โ **ุขูู**

**ุงูุชูููู**:
- **ุทุจูุฉ ูุงุนุฏุฉ ุงูุจูุงูุงุช**: โ ุขูู
- **ุทุจูุฉ ุงูุชุทุจูู**: โ ุขูู
- **ููุน ุงูุซุบุฑุงุช**: โ ุขูู
- **ุฅุนุงุฏุฉ ุจูุงุก ุงูุงุดุชุฑุงูุงุช**: โ ุขูู

**ุงูุชูุตูุงุช**:
1. โ๏ธ ูุฑุงุฌุนุฉ ุฌุฏูู `permissions` ูุฅุถุงูุฉ ููุชุฑ `company_id` ุฅุฐุง ูุฒู ุงูุฃูุฑ
2. โ ุฌููุน ุงูููุงุท ุงูุฃุฎุฑู ุขููุฉ

## ๐ ุงููุฑุงุฌุน

- `lib/realtime-manager.ts` - Realtime Manager
- `hooks/use-governance-realtime.ts` - Governance Hook
- `GOVERNANCE_REALTIME_SECURITY_RULES.md` - ููุงุนุฏ ุงูุฃูุงู
- `scripts/verify_governance_realtime.sql` - Script ุงูุชุญูู

---

**ุชุงุฑูุฎ ุงููุฑุงุฌุนุฉ**: 2026-01-23
**ุงูุญุงูุฉ**: โ **ููุงูู ุนูู ุงููุดุฑ** (ูุน ูุฑุงุฌุนุฉ ุฌุฏูู permissions)
