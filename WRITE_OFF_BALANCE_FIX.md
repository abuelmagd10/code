# ุฅุตูุงุญ ูุดููุฉ ุงูููุฏ ุบูุฑ ุงููุชูุงุฒู ุนูุฏ ุงุนุชูุงุฏ ุฅููุงู ุงููุฎุฒูู

## ๐จ ุงููุดููุฉ

ุนูุฏ ูุญุงููุฉ ุงุนุชูุงุฏ ุฅููุงู ุงููุฎุฒููุ ูุธูุฑ ุงูุฎุทุฃ ุงูุชุงูู:

```
โ ุฎุทุฃ: ุงูููุฏ ุบูุฑ ูุชูุงุฒู
ุงููุฏูู = 100.00
ุงูุฏุงุฆู = 0.00
ุงููุฑู = 100.00
```

### ุงูุณุจุจ ุงูุฌุฐุฑู

1. **ุฏุงูุฉ `approve_write_off`** ูุงูุช ุชุฏุฑุฌ ุณุทูุฑ ุงูููุฏ ุจุดูู ูููุตู:
   - ุฃููุงู: ุฅุฏุฑุงุฌ ุงูุณุทุฑ ุงููุฏูู (ุญุณุงุจ ูุตุฑูู ุงูุฅููุงู)
   - ุซุงููุงู: ุฅุฏุฑุงุฌ ุงูุณุทุฑ ุงูุฏุงุฆู (ุญุณุงุจ ุงููุฎุฒูู)

2. **ุงูู trigger `check_journal_entry_balance`** ูุนูู `FOR EACH ROW`:
   - ุจุนุฏ ุฅุฏุฑุงุฌ ุงูุณุทุฑ ุงูุฃูู (ุงููุฏูู ููุท)ุ ูุชุญูู ุงูู trigger ูู ุงูุชูุงุฒู
   - ูุฌุฏ ุฃู ุงููุฏูู = 100 ูุงูุฏุงุฆู = 0ุ ููุฑูุถ ุงูุนูููุฉ ูุจู ุฅุฏุฑุงุฌ ุงูุณุทุฑ ุงูุซุงูู

## โ ุงูุญู

### 1. ุชุนุฏูู ุฏุงูุฉ `approve_write_off`

ุชู ุชุนุฏูู ุงูุฏุงูุฉ ูุฅุฏุฑุงุฌ ููุง ุงูุณุทุฑูู (ุงููุฏูู ูุงูุฏุงุฆู) ูู ููุณ ุงูุฃูุฑ `INSERT`:

```sql
-- ุฅุฏุฑุงุฌ ููุง ุงูุณุทุฑูู ูู ููุณ ุงูุฃูุฑ ูุถูุงู ุงูุชูุงุฒู
INSERT INTO journal_entry_lines (
  journal_entry_id, account_id, debit_amount, credit_amount, description
) VALUES 
  -- ุฎุตู ุญุณุงุจ ูุตุฑูู ุงูุฅููุงู
  (
    v_journal_id, p_expense_account_id, v_write_off.total_cost, 0,
    'ูุตุฑูู ุฅููุงู ูุฎุฒูู - ' || v_write_off.write_off_number
  ),
  -- ุฏุงุฆู ุญุณุงุจ ุงููุฎุฒูู
  (
    v_journal_id, p_inventory_account_id, 0, v_write_off.total_cost,
    'ุชุฎููุถ ุงููุฎุฒูู - ' || v_write_off.write_off_number
  );
```

### 2. ุชุนุฏูู ุงูู trigger ููุตุจุญ DEFERRABLE

ุชู ุชุนุฏูู ุงูู triggers ูุชููู `DEFERRABLE INITIALLY DEFERRED`:

```sql
CREATE TRIGGER trg_check_journal_balance_insert
AFTER INSERT ON journal_entry_lines
FOR EACH ROW
DEFERRABLE INITIALLY DEFERRED
EXECUTE FUNCTION check_journal_entry_balance();
```

**ุงููุฒุงูุง:**
- ูุคุฌู ุงูุชุญูู ูู ุงูุชูุงุฒู ุญุชู ููุงูุฉ ุงููุนุงููุฉ (transaction)
- ูุณูุญ ุจุฅุฏุฑุงุฌ ุฌููุน ุณุทูุฑ ุงูููุฏ ูุจู ุงูุชุญูู ูู ุงูุชูุงุฒู
- ูุญุงูุธ ุนูู ุณูุงูุฉ ุงูุจูุงูุงุช ูุน ุงูุณูุงุญ ุจุฅุฏุฑุงุฌ ุณุทูุฑ ูุชุนุฏุฏุฉ

## ๐ ุฎุทูุงุช ุงูุชุทุจูู

### 1. ุชุทุจูู ุงูุฅุตูุงุญ

```bash
psql -U postgres -d your_database -f scripts/fix_write_off_balance_issue.sql
```

ุฃู ูู ุฏุงุฎู psql:

```sql
\i scripts/fix_write_off_balance_issue.sql
```

### 2. ุงูุชุญูู ูู ุงููููุฏ ุงูููุฌูุฏุฉ

```bash
psql -U postgres -d your_database -f scripts/check_write_off_journal_balance.sql
```

### 3. ุงุฎุชุจุงุฑ ุงูุฅุตูุงุญ

1. ุงูุชูู ุฅูู: **ุงููุฎุฒูู โ ุฅููุงู ุงููุฎุฒูู**
2. ุงุฎุชุฑ ุฅููุงู ูู ุญุงูุฉ "ููุฏ ุงูุงูุชุธุงุฑ"
3. ุงุถุบุท "ุงุนุชูุงุฏ ุงูุฅููุงู"
4. ุงุฎุชุฑ:
   - ุญุณุงุจ ูุตุฑูู ุงูุฅููุงู (ูุซูุงู: 5500)
   - ุญุณุงุจ ุงููุฎุฒูู (ูุซูุงู: 1200)
5. ุงุถุบุท "ุงุนุชูุงุฏ"

**ุงููุชูุฌุฉ ุงููุชููุนุฉ:**
- โ ูุชู ุฅูุดุงุก ููุฏ ูุชูุงุฒู (ุงููุฏูู = ุงูุฏุงุฆู)
- โ ูุชู ุฎุตู ุงููููุฉ ูู ุงููุฎุฒูู
- โ ุชุชุบูุฑ ุญุงูุฉ ุงูุฅููุงู ุฅูู "ูุนุชูุฏ"

## ๐ ุงููููุงุช ุงููุนุฏูุฉ

1. **`scripts/041_inventory_write_offs.sql`**
   - ุชุนุฏูู ุฏุงูุฉ `approve_write_off` ูุฅุฏุฑุงุฌ ููุง ุงูุณุทุฑูู ูู ููุณ ุงูุฃูุฑ

2. **`scripts/011_journal_entry_balance_check.sql`**
   - ุฅุถุงูุฉ `DEFERRABLE INITIALLY DEFERRED` ููู triggers

3. **`scripts/apply_phase1_fixes_clean.sql`**
   - ุชุญุฏูุซ ุงูู triggers ูุชููู DEFERRABLE

4. **`scripts/apply_phase1_fixes.sql`**
   - ุชุญุฏูุซ ุงูู triggers ูุชููู DEFERRABLE

## ๐ ุงููููุงุช ุงูุฌุฏูุฏุฉ

1. **`scripts/fix_write_off_balance_issue.sql`**
   - ููู SQL ูุชุทุจูู ุงูุฅุตูุงุญ ุนูู ูุงุนุฏุฉ ุงูุจูุงูุงุช

2. **`scripts/check_write_off_journal_balance.sql`**
   - ููู SQL ููุชุญูู ูู ุชูุงุฒู ุงููููุฏ ุงูููุฌูุฏุฉ

## โ๏ธ ููุงุญุธุงุช ูููุฉ

1. **DEFERRABLE Triggers:**
   - ุชุนูู ููุท ุฏุงุฎู ูุนุงููุฉ (transaction)
   - ุฅุฐุง ูู ุชูู ุฏุงุฎู ูุนุงููุฉุ ุณุชุนูู ูุงููุนุชุงุฏ
   - ุฏุงูุฉ `approve_write_off` ุชุนูู ุฏุงุฎู ูุนุงููุฉ ุชููุงุฆูุงู

2. **ุงููููุฏ ุงูููุฌูุฏุฉ:**
   - ุฅุฐุง ูุงู ููุงู ูููุฏ ุบูุฑ ูุชูุงุฒูุฉ ูู ูุญุงููุงุช ุณุงุจูุฉุ ูุฌุจ ุฅุตูุงุญูุง ูุฏููุงู
   - ุงุณุชุฎุฏู `scripts/check_write_off_journal_balance.sql` ููุชุญูู

3. **ุงูุงุฎุชุจุงุฑ:**
   - ุชุฃูุฏ ูู ุงุฎุชุจุงุฑ ุงูุฅุตูุงุญ ุนูู ุจูุฆุฉ ุงูุชุทููุฑ ุฃููุงู
   - ุชุญูู ูู ุฃู ุฌููุน ุงููููุฏ ุงูุฌุฏูุฏุฉ ูุชูุงุฒูุฉ

## ๐ ุงูุชุญูู ูู ุงูุฅุตูุงุญ

ุจุนุฏ ุชุทุจูู ุงูุฅุตูุงุญุ ุชุญูู ูู:

```sql
-- ุงูุชุญูู ูู ุฃู ุงูู triggers ูุญุฏุซุฉ
SELECT tgname, tgenabled, tgisinternal 
FROM pg_trigger 
WHERE tgname LIKE '%journal_balance%';

-- ูุฌุจ ุฃู ุชุฑู:
-- trg_check_journal_balance_insert: DEFERRABLE
-- trg_check_journal_balance_update: DEFERRABLE  
-- trg_check_journal_balance_delete: DEFERRABLE

-- ุงูุชุญูู ูู ุฏุงูุฉ approve_write_off
SELECT proname, prosrc 
FROM pg_proc 
WHERE proname = 'approve_write_off';
```

## โ ุงููุชูุฌุฉ ุงูููุงุฆูุฉ

ุจุนุฏ ุชุทุจูู ุงูุฅุตูุงุญ:
- โ ูููู ุงุนุชูุงุฏ ุฅููุงูุงุช ุงููุฎุฒูู ุจุฏูู ุฃุฎุทุงุก
- โ ูุชู ุฅูุดุงุก ูููุฏ ูุญุงุณุจูุฉ ูุชูุงุฒูุฉ ุชููุงุฆูุงู
- โ ูุชู ุฎุตู ุงููููุฉ ูู ุงููุฎุฒูู ุจุดูู ุตุญูุญ
- โ ูุชู ุชุญุฏูุซ ุญุงูุฉ ุงูุฅููุงู ุฅูู "ูุนุชูุฏ"
