# ุชุทุจูู ุฅุตูุงุญ ูุดููุฉ ุฅููุงู ุงููุฎุฒูู
# Apply Write-off Balance Fix

## ๐ฏ ุงูุทุฑููุฉ ุงูุณุฑูุนุฉ

### ุงูุฎุทูุฉ 1: ูุชุญ Supabase SQL Editor

1. ุงูุชุญ **Supabase Dashboard**
2. ุงุฐูุจ ุฅูู **Database** โ **SQL Editor**
3. ุงุถุบุท **New Query**

### ุงูุฎุทูุฉ 2: ูุณุฎ ูุชูููุฐ ุงูุฅุตูุงุญ

1. ุงูุชุญ ุงูููู: `scripts/fix_write_off_balance_issue.sql`
2. **ุงูุณุฎ ุงููุญุชูู ูุงููุงู** (Ctrl+A ุซู Ctrl+C)
3. **ุงูุตู ูู SQL Editor** (Ctrl+V)
4. ุงุถุบุท **Run** ุฃู **Ctrl+Enter**

### ุงูุฎุทูุฉ 3: ุงูุชุญูู ูู ุงููุฌุงุญ

ุจุนุฏ ุงูุชูููุฐุ ูุฌุจ ุฃู ุชุฑู:
- โ `COMMIT` - ุชู ุชูููุฐ ุงููุนุงููุฉ ุจูุฌุงุญ
- โ ูุง ุฃุฎุทุงุก

### ุงูุฎุทูุฉ 4: ุงูุชุญูู ูู ุงููููุฏ ุงูููุฌูุฏุฉ (ุงุฎุชูุงุฑู)

1. ุงูุชุญ ุงูููู: `scripts/check_write_off_journal_balance.sql`
2. ุงูุณุฎ ุงููุญุชูู
3. ุงูุตู ูู SQL Editor
4. ุงุถุบุท Run

**ุงููุชูุฌุฉ ุงููุชููุนุฉ:**
- ุฅุฐุง ูุงูุช ููุงู ูููุฏ ุบูุฑ ูุชูุงุฒูุฉุ ุณุชุธูุฑ ูู ุงููุชุงุฆุฌ
- ุฅุฐุง ูู ุชูู ููุงู ูููุฏ ุบูุฑ ูุชูุงุฒูุฉุ ุณุชููู ุงููุชุงุฆุฌ ูุงุฑุบุฉ

---

## โ ุงุฎุชุจุงุฑ ุงูุฅุตูุงุญ

ุจุนุฏ ุชุทุจูู ุงูุฅุตูุงุญ:

1. ุงูุชูู ุฅูู ุงูุชุทุจูู: **ุงููุฎุฒูู โ ุฅููุงู ุงููุฎุฒูู**
2. ุงุฎุชุฑ ุฅููุงู ูู ุญุงูุฉ "ููุฏ ุงูุงูุชุธุงุฑ" (ูุซูุงู: WO-2025-0004)
3. ุงุถุบุท **"ุงุนุชูุงุฏ ุงูุฅููุงู"**
4. ุงุฎุชุฑ:
   - **ุญุณุงุจ ูุตุฑูู ุงูุฅููุงู:** (ูุซูุงู: 5500 - ุงููุงู ูุฎุฒูู ุดุฑูุงุช ุงูุดุญู)
   - **ุญุณุงุจ ุงููุฎุฒูู:** (ูุซูุงู: 1200 - ุงููุฎุฒูู)
5. ุงุถุบุท **"ุงุนุชูุงุฏ"**

**ุงููุชูุฌุฉ ุงููุชููุนุฉ:**
- โ ูุชู ุฅูุดุงุก ููุฏ ูุชูุงุฒู (ุงููุฏูู = ุงูุฏุงุฆู)
- โ ูุชู ุฎุตู ุงููููุฉ ูู ุงููุฎุฒูู
- โ ุชุชุบูุฑ ุญุงูุฉ ุงูุฅููุงู ุฅูู "ูุนุชูุฏ"
- โ ูุง ุชุธูุฑ ุฑุณุงูุฉ ุฎุทุฃ

---

## ๐ ุงูุชุญูู ูู ุงูุฅุตูุงุญ (SQL)

ููููู ุงูุชุญูู ูู ุฃู ุงูุฅุตูุงุญ ุชู ุชุทุจููู ุจูุฌุงุญ:

```sql
-- ุงูุชุญูู ูู ุฃู ุงูู triggers ูุญุฏุซุฉ
SELECT 
  tgname as trigger_name,
  CASE 
    WHEN tgdeferrable THEN 'DEFERRABLE'
    ELSE 'NOT DEFERRABLE'
  END as deferrable_status
FROM pg_trigger 
WHERE tgname LIKE '%journal_balance%'
ORDER BY tgname;

-- ูุฌุจ ุฃู ุชุฑู:
-- trg_check_journal_balance_insert: DEFERRABLE
-- trg_check_journal_balance_update: DEFERRABLE  
-- trg_check_journal_balance_delete: DEFERRABLE
```

```sql
-- ุงูุชุญูู ูู ุฏุงูุฉ approve_write_off
SELECT 
  proname as function_name,
  CASE 
    WHEN prosrc LIKE '%VALUES%' AND prosrc LIKE '%p_expense_account_id%' AND prosrc LIKE '%p_inventory_account_id%' 
    THEN 'โ ูุญุฏุซุฉ - ุชุฏุฑุฌ ููุง ุงูุณุทุฑูู ูุนุงู'
    ELSE 'โ ูุฏููุฉ - ุชุญุชุงุฌ ุชุญุฏูุซ'
  END as status
FROM pg_proc 
WHERE proname = 'approve_write_off';
```

---

## โ๏ธ ููุงุญุธุงุช ูููุฉ

1. **ุงููุณุฎ ุงูุงุญุชูุงุทู:**
   - ูููุตุญ ุจุนูู ูุณุฎุฉ ุงุญุชูุงุทูุฉ ูุจู ุงูุชุทุจูู (ุฎุงุตุฉ ูู Production)
   - ููููู ุงุณุชุฎุฏุงู Supabase Dashboard โ Database โ Backups

2. **ุงูุจูุฆุฉ:**
   - ุชุฃูุฏ ูู ุชุทุจูู ุงูุฅุตูุงุญ ุนูู ุงูุจูุฆุฉ ุงูุตุญูุญุฉ
   - Development โ Staging โ Production

3. **ุงููููุฏ ุงูููุฌูุฏุฉ:**
   - ุฅุฐุง ูุงู ููุงู ูููุฏ ุบูุฑ ูุชูุงุฒูุฉ ูู ูุญุงููุงุช ุณุงุจูุฉุ ูุฌุจ ุฅุตูุงุญูุง ูุฏููุงู
   - ุงุณุชุฎุฏู `scripts/check_write_off_journal_balance.sql` ููุชุญูู

---

## ๐ ุงูุฏุนู

ุฅุฐุง ูุงุฌูุช ุฃู ูุดุงูู:
1. ุชุญูู ูู ุฑุณุงุฆู ุงูุฎุทุฃ ูู SQL Editor
2. ุฑุงุฌุน ููู `WRITE_OFF_BALANCE_FIX.md` ููุชูุงุตูู ุงููุงููุฉ
3. ุชุฃูุฏ ูู ุฃู ุฌููุน ุงููููุงุช ูุญุฏุซุฉ

---

**ุชุงุฑูุฎ ุงูุฅูุดุงุก:** 2025-01-27  
**ุงูุญุงูุฉ:** โ ุฌุงูุฒ ููุชุทุจูู
