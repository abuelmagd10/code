# ๐ ุฏููู ุชุทุจูู ูุธุงู ุงูุชุญูู ูู ุงูุฑุคูุฉ - APIs & RLS

## ๐ ููุฎุต ุงูุชุทุจูู

ุชู ุชุทุจูู ูุธุงู ุงูุชุญูู ูู ุงููุตูู ูุงูุฑุคูุฉ (Data Visibility & Access Control) ุจุดูู ุดุงูู ุนูู:

### โ ุงูููููุงุช ุงูููุชููุฉ

#### 1. ุงููุธุงู ุงูุฃุณุงุณู
- โ `lib/data-visibility-control.ts` - ุงููุธุงู ุงูููุญุฏ
- โ `docs/DATA_VISIBILITY_GOVERNANCE.md` - ุงูุชูุซูู

#### 2. ูุงุฌูุงุช ุงููุณุชุฎุฏู (Frontend)
- โ `app/invoices/page.tsx` - ุงูููุงุชูุฑ
- โ `app/sales-orders/page.tsx` - ุฃูุงูุฑ ุงูุจูุน  
- โ `app/purchase-orders/page.tsx` - ุฃูุงูุฑ ุงูุดุฑุงุก
- โ `app/bills/page.tsx` - ููุงุชูุฑ ุงูุดุฑุงุก
- โ `app/sales-returns/page.tsx` - ูุฑุชุฌุนุงุช ุงููุจูุนุงุช
- โ `app/customer-debit-notes/page.tsx` - ุฅุดุนุงุฑุงุช ูุฏูู ุงูุนููุงุก
- โ `app/vendor-credits/page.tsx` - ุฅุดุนุงุฑุงุช ุฏุงุฆู ุงูููุฑุฏูู

#### 3. APIs (Backend)
- โ `app/api/invoices/route.ts` - API ุงูููุงุชูุฑ
- โ `app/api/sales-orders/route.ts` - API ุฃูุงูุฑ ุงูุจูุน
- โ `app/api/bills/route.ts` - API ููุงุชูุฑ ุงูุดุฑุงุก (ุฌุฏูุฏ)
- โ `app/api/purchase-orders/route.ts` - API ุฃูุงูุฑ ุงูุดุฑุงุก (ุฌุฏูุฏ)
- โ `app/api/sales-returns/route.ts` - API ูุฑุชุฌุนุงุช ุงููุจูุนุงุช (ุฌุฏูุฏ)
- โ `app/api/customer-debit-notes/route.ts` - API ุฅุดุนุงุฑุงุช ูุฏูู ุงูุนููุงุก (ุฌุฏูุฏ)
- โ `app/api/vendor-credits/route.ts` - API ุฅุดุนุงุฑุงุช ุฏุงุฆู ุงูููุฑุฏูู (ุฌุฏูุฏ)

#### 4. ูุงุนุฏุฉ ุงูุจูุงูุงุช (RLS Policies)
- โ `scripts/data_visibility_rls_policies.sql` - ุณูุงุณุงุช ุงูุฃูุงู

---

## ๐ฏ ูุตูููุฉ ุงูุตูุงุญูุงุช

| ุงูุฏูุฑ | ุงููุทุงู | ุงููููุฏ |
|-------|--------|--------|
| **Staff** | ูุง ุฃูุดุฃู ููุท | `created_by_user_id` + `branch_id` + `cost_center_id` + `warehouse_id` |
| **Accountant** | ูุทุงู ุงูุนูู | `branch_id` + `cost_center_id` (ุจุฏูู ููุฏ ุงูููุดุฆ) |
| **Manager** | ูุทุงู ุงูุนูู | `branch_id` + `cost_center_id` (ุจุฏูู ููุฏ ุงูููุดุฆ) |
| **General Manager** | ุงูุดุฑูุฉ ูุงููุฉ | `company_id` ููุท |
| **Owner/Admin** | ุงูุดุฑูุฉ ูุงููุฉ | `company_id` ููุท |

---

## ๐ง ููููุฉ ุงูุชุทุจูู

### ุงูุฎุทูุฉ 1: ุชุทุจูู RLS Policies
```sql
-- ุชุดุบูู ุงูููู ูู Supabase SQL Editor
\i scripts/data_visibility_rls_policies.sql
```

### ุงูุฎุทูุฉ 2: ุงูุชุญูู ูู APIs
ุฌููุน APIs ุงูุฌุฏูุฏุฉ ุชุณุชุฎุฏู ุงููุธุงู ุงูููุญุฏ:
```typescript
// ูุซุงู ูู API
query = await applyDataVisibilityFilter(supabase, query, "invoices", user.id, companyId)
```

### ุงูุฎุทูุฉ 3: ุงุฎุชุจุงุฑ ุงููุธุงู
1. ุชุณุฌูู ุฏุฎูู ุจุฃุฏูุงุฑ ูุฎุชููุฉ
2. ุงูุชุญูู ูู ุฑุคูุฉ ุงูุจูุงูุงุช ุงูููุงุณุจุฉ
3. ุงุฎุชุจุงุฑ ุฅูุดุงุก/ุชุนุฏูู ุงููุณุชูุฏุงุช

---

## ๐ ุงูููุงุฆุฏ ุงููุญููุฉ

### ๐ ุงูุฃูุงู
- **ุญูุงูุฉ ุนูู ูุณุชูู ูุงุนุฏุฉ ุงูุจูุงูุงุช**: RLS policies ุชููุน ุงููุตูู ุบูุฑ ุงููุตุฑุญ
- **ุญูุงูุฉ ุนูู ูุณุชูู ุงูุชุทุจูู**: APIs ุชุทุจู ุงูููุงุนุฏ ูุจู ุงููุตูู ููุจูุงูุงุช
- **ุญูุงูุฉ ุนูู ูุณุชูู ุงููุงุฌูุฉ**: Frontend ูุฎูู ุงูุจูุงูุงุช ุบูุฑ ุงููุณููุญุฉ

### โก ุงูุฃุฏุงุก
- **ููุงุฑุณ ูุญุณูุฉ**: ุชู ุฅูุดุงุก ููุงุฑุณ ููุญููู ุงููุณุชุฎุฏูุฉ ูู ุงูููุชุฑุฉ
- **ุงุณุชุนูุงูุงุช ูุญุณูุฉ**: ุชุทุจูู ุงูููุงุชุฑ ุนูู ูุณุชูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
- **ุชูููู ููู ุงูุจูุงูุงุช**: ุฌูุจ ุงูุจูุงูุงุช ุงููุณููุญุฉ ููุท

### ๐ฏ ุณูููุฉ ุงูุตูุงูุฉ
- **ูุธุงู ููุญุฏ**: ุฏุงูุฉ ูุงุญุฏุฉ ูุชุทุจูู ุงูููุงุนุฏ
- **ุชูุซูู ุดุงูู**: ุฏููู ูุงุถุญ ููู ูููู
- **ูุงุจููุฉ ุงูุชูุณุน**: ุณูููุฉ ุฅุถุงูุฉ ุฌุฏุงูู ุฌุฏูุฏุฉ

---

## ๐ ุงูุฎุทูุงุช ุงูุชุงููุฉ

### ุงููุฑุญูุฉ ุงูุฃููู (ููุชููุฉ)
- โ ุชุทุจูู ุงููุธุงู ุนูู ุงููุณุชูุฏุงุช ุงูุฃุณุงุณูุฉ
- โ ุฅูุดุงุก APIs ููุญุฏุฉ
- โ ุชุทุจูู RLS policies

### ุงููุฑุญูุฉ ุงูุซุงููุฉ (ุงุฎุชูุงุฑูุฉ)
- ๐ ุชุทุจูู ุงููุธุงู ุนูู ุฌุฏุงูู ุฃุฎุฑู (customers, suppliers, products)
- ๐ ุฅุถุงูุฉ ูุธุงู ูุดุงุฑูุฉ ุงูุตูุงุญูุงุช ุงููุชูุฏู
- ๐ ุชุทุจูู ุงููุธุงู ุนูู ุงูุชูุงุฑูุฑ

### ุงููุฑุญูุฉ ุงูุซุงูุซุฉ (ูุณุชูุจููุฉ)
- ๐ ุฅุถุงูุฉ audit logs ูููุตูู ููุจูุงูุงุช
- ๐ ุชุทุจูู data masking ููุจูุงูุงุช ุงูุญุณุงุณุฉ
- ๐ ุฅุถุงูุฉ ูุธุงู ุฅุดุนุงุฑุงุช ูููุตูู ุบูุฑ ุงููุตุฑุญ

---

## ๐งช ุงุฎุชุจุงุฑ ุงููุธุงู

### ุงุฎุชุจุงุฑ ุงูุฃุฏูุงุฑ
```bash
# ุงุฎุชุจุงุฑ ุฏูุฑ Staff
curl -H "Authorization: Bearer <staff_token>" \
     "http://localhost:3000/api/invoices"

# ุงุฎุชุจุงุฑ ุฏูุฑ Manager  
curl -H "Authorization: Bearer <manager_token>" \
     "http://localhost:3000/api/invoices"

# ุงุฎุชุจุงุฑ ุฏูุฑ Admin
curl -H "Authorization: Bearer <admin_token>" \
     "http://localhost:3000/api/invoices"
```

### ุงุฎุชุจุงุฑ RLS
```sql
-- ุงุฎุชุจุงุฑ ูููุธู
SET session.user_id = '<staff_user_id>';
SELECT * FROM invoices; -- ูุฌุจ ุฃู ูุฑู ููุงุชูุฑู ููุท

-- ุงุฎุชุจุงุฑ ููุฏูุฑ
SET session.user_id = '<manager_user_id>';  
SELECT * FROM invoices; -- ูุฌุจ ุฃู ูุฑู ููุงุชูุฑ ูุฑุนู

-- ุงุฎุชุจุงุฑ ููุงูู
SET session.user_id = '<owner_user_id>';
SELECT * FROM invoices; -- ูุฌุจ ุฃู ูุฑู ูู ุงูููุงุชูุฑ
```

---

## ๐ ุงูุฏุนู ูุงููุณุงุนุฏุฉ

### ุงููููุงุช ุงููุฑุฌุนูุฉ
- `lib/data-visibility-control.ts` - ุงูููุฏ ุงูุฃุณุงุณู
- `docs/DATA_VISIBILITY_GOVERNANCE.md` - ุงูุชูุซูู ุงูุชูุตููู
- `scripts/data_visibility_rls_policies.sql` - ุณูุงุณุงุช ูุงุนุฏุฉ ุงูุจูุงูุงุช

### ุงููุดุงูู ุงูุดุงุฆุนุฉ
1. **ุนุฏู ุธููุฑ ุงูุจูุงูุงุช**: ุชุญูู ูู ุงูุฏูุฑ ูุงููุฑุน ุงููุฎุตุต
2. **ุฎุทุฃ ูู RLS**: ุชุญูู ูู ุชุทุจูู ุงูุณูุงุณุงุช ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
3. **ุจุทุก ูู ุงูุฃุฏุงุก**: ุชุญูู ูู ูุฌูุฏ ุงูููุงุฑุณ ุงููุทููุจุฉ

---

## โ ุญุงูุฉ ุงูุชุทุจูู: ููุชูู 100%

๐ **ุชู ุชุทุจูู ูุธุงู ุงูุชุญูู ูู ุงูุฑุคูุฉ ุจูุฌุงุญ ุนูู ุฌููุน ุงูููููุงุช!**

- โ Frontend: 7 ุตูุญุงุช
- โ Backend: 7 APIs  
- โ Database: 7 RLS policies
- โ Documentation: ุดุงูู ูููุตู