# ๐ ุตูุงุญูุงุช ุงูุฅุดุนุงุฑุงุช ุญุณุจ ุงูุฃุฏูุงุฑ

## ๐ ูุธุฑุฉ ุนุงูุฉ

ูุฐุง ุงููุณุชูุฏ ูุดุฑุญ ููู ูุชู ููุชุฑุฉ ุงูุฅุดุนุงุฑุงุช ููู ุฏูุฑ ูู ุงููุธุงู.

---

## ๐ญ ุงูุฃุฏูุงุฑ ูู ุงููุธุงู

- **Owner** (ุงููุงูู)
- **Admin** (ุงููุฏูุฑ)
- **Manager** (ุงููุฏูุฑ ุงูุชูููุฐู)
- **Accountant** (ุงููุญุงุณุจ)
- **Warehouse Manager** (ูุฏูุฑ ุงููุฎุฒู)
- **Staff** (ุงูููุธู)

---

## โ ุตูุงุญูุงุช ูู ุฏูุฑ

### 1๏ธโฃ Owner (ุงููุงูู)

**ูุฑู:**
- โ **ุฌููุน ุงูุฅุดุนุงุฑุงุช** ูู ุงูุดุฑูุฉ ุจุบุถ ุงููุธุฑ ุนู:
  - `assigned_to_user` (ุงููุณุชุฎุฏู ุงููุฎุตุต)
  - `assigned_to_role` (ุงูุฏูุฑ ุงููุฎุตุต)
  - `branch_id` (ุงููุฑุน)
  - `warehouse_id` (ุงููุฎุฒู)

**ูุซุงู:**
- ุฅุดุนุงุฑ ูุฎุตุต ูู `accountant` โ โ ูุธูุฑ ูููุงูู
- ุฅุดุนุงุฑ ูู ูุฑุน ุขุฎุฑ โ โ ูุธูุฑ ูููุงูู
- ุฅุดุนุงุฑ ูู ูุฎุฒู ุขุฎุฑ โ โ ูุธูุฑ ูููุงูู

---

### 2๏ธโฃ Admin (ุงููุฏูุฑ)

**ูุฑู:**
- โ **ุฌููุน ุงูุฅุดุนุงุฑุงุช** ูู ุงูุดุฑูุฉ ุจุบุถ ุงููุธุฑ ุนู:
  - `assigned_to_user`
  - `assigned_to_role`
  - `branch_id`
  - `warehouse_id`

**ูุซุงู:**
- ุฅุดุนุงุฑ ูุฎุตุต ูู `manager` โ โ ูุธูุฑ ูููุฏูุฑ
- ุฅุดุนุงุฑ ูู ูุฑุน ุขุฎุฑ โ โ ูุธูุฑ ูููุฏูุฑ
- ุฅุดุนุงุฑ ูู ูุฎุฒู ุขุฎุฑ โ โ ูุธูุฑ ูููุฏูุฑ

---

### 3๏ธโฃ ุจุงูู ุงูุฃุฏูุงุฑ (Manager, Accountant, Warehouse Manager, Staff)

**ูุฑูู ููุท:**

#### ุฃ) ุงูุฅุดุนุงุฑุงุช ุงููุฎุตุตุฉ ููู ูุจุงุดุฑุฉ:
- โ `assigned_to_user = user_id` โ ูุธูุฑ ูููุณุชุฎุฏู ุงููุญุฏุฏ
- โ `assigned_to_user IS NULL` โ ูุธูุฑ ููุฌููุน (ุฅุดุนุงุฑ ุนุงู)

#### ุจ) ุงูุฅุดุนุงุฑุงุช ุงููุฎุตุตุฉ ูุฏูุฑูู:
- โ `assigned_to_role = user_role` โ ูุธูุฑ ููู ูููู ูุฐุง ุงูุฏูุฑ
- โ `assigned_to_role IS NULL` โ ูุธูุฑ ููุฌููุน (ุฅุดุนุงุฑ ุนุงู)

#### ุฌ) ุงูุฅุดุนุงุฑุงุช ูู ูุฑุนูู:
- โ `branch_id = user_branch_id` โ ูุธูุฑ ููุณุชุฎุฏูู ูุฐุง ุงููุฑุน
- โ `branch_id IS NULL` โ ูุธูุฑ ูุฌููุน ุงููุฑูุน (ุฅุดุนุงุฑ ุนุงู)
- โ๏ธ ุฅุฐุง ูู ููู ุงููุณุชุฎุฏู ูุฑุชุจุท ุจูุฑุน (`branch_id IS NULL`) โ ูุฑู ุงูุฅุดุนุงุฑุงุช ุงูุนุงูุฉ ููุท

#### ุฏ) ุงูุฅุดุนุงุฑุงุช ูู ูุฎุฒููู:
- โ `warehouse_id = user_warehouse_id` โ ูุธูุฑ ููุณุชุฎุฏูู ูุฐุง ุงููุฎุฒู
- โ `warehouse_id IS NULL` โ ูุธูุฑ ูุฌููุน ุงููุฎุงุฒู (ุฅุดุนุงุฑ ุนุงู)
- โ๏ธ ุฅุฐุง ูู ููู ุงููุณุชุฎุฏู ูุฑุชุจุท ุจูุฎุฒู (`warehouse_id IS NULL`) โ ูุฑู ุงูุฅุดุนุงุฑุงุช ุงูุนุงูุฉ ููุท

---

## ๐ ุฃูุซูุฉ ุนูููุฉ

### ูุซุงู 1: Manager ูู ูุฑุน "ุงููุงูุฑุฉ"

**ุงูุฅุดุนุงุฑุงุช ุงูุชู ูุฑุงูุง:**
- โ ุฅุดุนุงุฑ ูุฎุตุต ูู `manager` ูู ูุฑุน "ุงููุงูุฑุฉ"
- โ ุฅุดุนุงุฑ ุนุงู (`assigned_to_role IS NULL`) ูู ูุฑุน "ุงููุงูุฑุฉ"
- โ ุฅุดุนุงุฑ ูุฎุตุต ูู ูุจุงุดุฑุฉ (`assigned_to_user = manager_id`)
- โ ุฅุดุนุงุฑ ูุฎุตุต ูู `accountant` ูู ูุฑุน "ุงููุงูุฑุฉ" (ุฅุฐุง ูุงู `assigned_to_role = 'accountant'`)
- โ ุฅุดุนุงุฑ ูู ูุฑุน "ุงูุฅุณููุฏุฑูุฉ" (ูุง ูู ููู `branch_id IS NULL`)

---

### ูุซุงู 2: Accountant ุจุฏูู ูุฑุน ูุญุฏุฏ

**ุงูุฅุดุนุงุฑุงุช ุงูุชู ูุฑุงูุง:**
- โ ุฅุดุนุงุฑ ุนุงู (`assigned_to_role IS NULL` ู `branch_id IS NULL`)
- โ ุฅุดุนุงุฑ ูุฎุตุต ูู ูุจุงุดุฑุฉ (`assigned_to_user = accountant_id`)
- โ ุฅุดุนุงุฑ ูุฎุตุต ูู `accountant` (`assigned_to_role = 'accountant'`)
- โ ุฅุดุนุงุฑ ูู ูุฑุน ูุญุฏุฏ (ูุฃูู ููุณ ูุฑุชุจุท ุจูุฑุน)

---

### ูุซุงู 3: Warehouse Manager ูู ูุฎุฒู "ุงูุฑุฆูุณู"

**ุงูุฅุดุนุงุฑุงุช ุงูุชู ูุฑุงูุง:**
- โ ุฅุดุนุงุฑ ูุฎุตุต ูู `warehouse_manager` ูู ูุฎุฒู "ุงูุฑุฆูุณู"
- โ ุฅุดุนุงุฑ ุนุงู (`warehouse_id IS NULL`)
- โ ุฅุดุนุงุฑ ูุฎุตุต ูู ูุจุงุดุฑุฉ
- โ ุฅุดุนุงุฑ ูู ูุฎุฒู ุขุฎุฑ (ูุง ูู ููู `warehouse_id IS NULL`)

---

## ๐ ููุทู ุงูููุชุฑุฉ ูู SQL

```sql
-- ููุชุฑุฉ ุญุณุจ assigned_to_user
AND (
  v_user_role IN ('owner', 'admin')  -- Owner/Admin: ูู ุดูุก
  OR n.assigned_to_user = p_user_id  -- ูุฎุตุต ูููุณุชุฎุฏู
  OR n.assigned_to_user IS NULL      -- ุนุงู
)

-- ููุชุฑุฉ ุญุณุจ assigned_to_role
AND (
  v_user_role IN ('owner', 'admin')  -- Owner/Admin: ูู ุดูุก
  OR n.assigned_to_role IS NULL      -- ุนุงู
  OR n.assigned_to_role = v_user_role  -- ูุฎุตุต ููุฏูุฑ
  OR (n.assigned_to_role = 'admin' AND v_user_role = 'owner')  -- Owner ูุฑู Admin
)

-- ููุชุฑุฉ ุญุณุจ branch_id
AND (
  v_user_role IN ('owner', 'admin')  -- Owner/Admin: ูู ุดูุก
  OR p_branch_id IS NULL             -- ุงููุณุชุฎุฏู ููุณ ูุฑุชุจุท ุจูุฑุน
  OR n.branch_id = p_branch_id       -- ููุณ ุงููุฑุน
  OR n.branch_id IS NULL             -- ุฅุดุนุงุฑ ุนุงู (ุฌููุน ุงููุฑูุน)
)

-- ููุชุฑุฉ ุญุณุจ warehouse_id
AND (
  v_user_role IN ('owner', 'admin')  -- Owner/Admin: ูู ุดูุก
  OR p_warehouse_id IS NULL          -- ุงููุณุชุฎุฏู ููุณ ูุฑุชุจุท ุจูุฎุฒู
  OR n.warehouse_id = p_warehouse_id -- ููุณ ุงููุฎุฒู
  OR n.warehouse_id IS NULL          -- ุฅุดุนุงุฑ ุนุงู (ุฌููุน ุงููุฎุงุฒู)
)
```

---

## โ๏ธ ููุงุญุธุงุช ูููุฉ

1. **ุงูุฅุดุนุงุฑุงุช ุงูุนุงูุฉ (`assigned_to_user IS NULL` ู `assigned_to_role IS NULL`):**
   - ุชุธูุฑ ูุฌููุน ุงููุณุชุฎุฏููู ูู ุงูุดุฑูุฉ
   - ุจุบุถ ุงููุธุฑ ุนู ุงููุฑุน ุฃู ุงููุฎุฒู

2. **ุงูุฅุดุนุงุฑุงุช ุงููุคุฑุดูุฉ:**
   - ูุง ุชุธูุฑ ูู ุงููุงุฆูุฉ ุงูุงูุชุฑุงุถูุฉ
   - ุชุธูุฑ ููุท ุนูุฏ ุงุฎุชูุงุฑ ููุชุฑ "Archived"

3. **ุงูุฅุดุนุงุฑุงุช ุงูููุชููุฉ ุงูุตูุงุญูุฉ (`expires_at < NOW()`):**
   - ูุง ุชุธูุฑ ุฃุจุฏุงู

4. **Owner ูุฑู ุฅุดุนุงุฑุงุช Admin:**
   - ุฅุฐุง ูุงู `assigned_to_role = 'admin'` โ ูุธูุฑ ูููุงูู ุฃูุถุงู

---

## ๐ ููุฎุต ุณุฑูุน

| ุงูุฏูุฑ | assigned_to_user | assigned_to_role | branch_id | warehouse_id |
|------|------------------|------------------|------------|---------------|
| **Owner** | โ ูู ุดูุก | โ ูู ุดูุก | โ ูู ุดูุก | โ ูู ุดูุก |
| **Admin** | โ ูู ุดูุก | โ ูู ุดูุก | โ ูู ุดูุก | โ ูู ุดูุก |
| **ุจุงูู ุงูุฃุฏูุงุฑ** | โ ูุฎุตุต ููู ุฃู ุนุงู | โ ูุฎุตุต ูุฏูุฑูู ุฃู ุนุงู | โ ูุฑุนูู ุฃู ุนุงู | โ ูุฎุฒููู ุฃู ุนุงู |

---

## ๐ง ุงูุชุทุจูู

ูุชูุนูู ูุฐู ุงูุตูุงุญูุงุชุ ุดุบูู:

```sql
scripts/fix_archived_notifications.sql
```

ูุฐุง ุงูู script ูุญุฏุซ ุฏุงูุฉ `get_user_notifications` ูุชุทุจูู ุงูููุทู ุฃุนูุงู.
