# ๐ ุฏููู ูุฑุงุฌุนุฉ ูุฑุชุฌุนุงุช ุงููุดุชุฑูุงุช
# Purchase Returns Review Guide

**ุชุงุฑูุฎ:** 2026-01-05  
**ุงูุดุฑูุฉ:** "ุชุณุช"  
**ุงููุฏู:** ุงูุชุญูู ูู ุฃู ูุธุงู ERP ูุนุงูุฌ ุงููุฑุชุฌุนุงุช ุจุงููุงูู ููุญุฏุซ ุงููุฎุฒูู ุจุดูู ุตุญูุญ

---

## โ ุงููุดููุฉ ุงูููุชุดูุฉ

### ุงูุญุงูุฉ ุงูุญุงููุฉ:
ูุงุชูุฑุฉ ูุดุชุฑูุงุช (BILL-0001) ุชู ุนูู ูุฑุชุฌุน ูุงูู ุนูููุงุ ูููู:
- โ **ูุง ุชูุฌุฏ ุญุฑูุงุช ูุฎุฒูู** (`inventory_transactions`) ูุฑุชุจุทุฉ ุจุงููุฑุชุฌุน
- โ ุชู ุฅูุดุงุก ุงููููุฏ ุงููุญุงุณุจูุฉ
- โ ุชู ุชุญุฏูุซ `bill_items.returned_quantity`

### ุงููุชูุฌุฉ:
ุตูุญุฉ ุงููุฎุฒูู ูู ุชูุญุฏุซ - ุงููููุงุช ูู ุงููุฎุฒูู ูู ุชุชุบูุฑ.

---

## โ ุงููุทููุจ ุงูุชุญูู ููู

### 1. ุญุฑูุงุช ุงููุฎุฒูู (Inventory Transactions)

**ุงููุชููุน:**
- โ ูุชู ุฅูุดุงุก ุญุฑูุฉ ูุฎุฒูู ูู ููุน `purchase_return`
- โ `quantity_change` ูุฌุจ ุฃู ูููู **ุณุงูุจ** (Stock Out)
- โ `reference_id` ูุฌุจ ุฃู ูุดูุฑ ุฅูู `bill.id`
- โ `transaction_type` = `'purchase_return'`

**ุงูุชุญูู:**
```sql
SELECT * FROM inventory_transactions
WHERE reference_id = '<bill_id>'
  AND transaction_type = 'purchase_return'
```

### 2. ุชุญุฏูุซ ุงููุฎุฒูู (Products.quantity_on_hand)

**ุงููุชููุน:**
- โ ูุชู ุชุญุฏูุซ `products.quantity_on_hand` ุชููุงุฆูุงู ุนุจุฑ Database Trigger
- โ ุงููุฎุฒูู ูุฌุจ ุฃู ููุฎูุถ ุจูููุฉ ุงููููุฉ ุงููุฑุชุฌุนุฉ

**ุงูุชุญูู:**
```sql
-- ุญุณุงุจ ุงููุฎุฒูู ุงููุชููุน ูู ุญุฑูุงุช ุงููุฎุฒูู
SELECT 
  p.id,
  p.sku,
  p.name,
  p.quantity_on_hand as system_qty,
  COALESCE(SUM(it.quantity_change), 0) as calculated_qty,
  ABS(p.quantity_on_hand - COALESCE(SUM(it.quantity_change), 0)) as diff
FROM products p
LEFT JOIN inventory_transactions it ON it.product_id = p.id
WHERE p.company_id = '<company_id>'
GROUP BY p.id, p.sku, p.name, p.quantity_on_hand
HAVING ABS(p.quantity_on_hand - COALESCE(SUM(it.quantity_change), 0)) > 0.01
```

### 3. ุงููููุฏ ุงููุญุงุณุจูุฉ (Journal Entries)

**ุงููุชููุน:**
- โ ูุชู ุฅูุดุงุก ููุฏ ูุญุงุณุจู ูู ููุน `purchase_return`
- โ ููุฏ AP (Accounts Payable) - ุชูููู ุงูุฏูู
- โ ููุฏ Inventory - ุชูููู ุงููุฎุฒูู
- โ ููุฏ ุงุณุชุฑุฏุงุฏ (ุฅุฐุง ูุงู ููุฏู/ุจููู) - `purchase_return_refund`

**ุงูุชุญูู:**
```sql
SELECT * FROM journal_entries
WHERE reference_type IN ('purchase_return', 'purchase_return_refund')
  AND reference_id = '<bill_id>'
```

### 4. ุชุญุฏูุซ ุจููุฏ ุงููุงุชูุฑุฉ (Bill Items)

**ุงููุชููุน:**
- โ ูุชู ุชุญุฏูุซ `bill_items.returned_quantity` ููู ุจูุฏ ูุฑุชุฌุน
- โ `returned_quantity` ูุฌุจ ุฃู ูุณุงูู ุงููููุฉ ุงููุฑุชุฌุนุฉ

**ุงูุชุญูู:**
```sql
SELECT * FROM bill_items
WHERE bill_id = '<bill_id>'
  AND returned_quantity > 0
```

---

## ๐ ุฎุทูุงุช ุงููุฑุงุฌุนุฉ

### 1. ุงูุชุญูู ุงูุชููุงุฆู

```bash
node scripts/verify-purchase-returns.js
```

ูุฐุง ุงูุณูุฑูุจุช ูููู ุจู:
- โ ุงูุชุญูู ูู ุฌููุน ููุงุชูุฑ ุงููุดุชุฑูุงุช ุงููุฑุชุฌุนุฉ
- โ ุงูุชุญูู ูู ุญุฑูุงุช ุงููุฎุฒูู
- โ ุงูุชุญูู ูู ุชุญุฏูุซ `quantity_on_hand`
- โ ุงูุชุญูู ูู ุงููููุฏ ุงููุญุงุณุจูุฉ
- โ ุงูุชุญูู ูู ุชุญุฏูุซ `bill_items.returned_quantity`

### 2. ุงูุชุญูู ุงููุฏูู

#### ุฃ. ูุงุชูุฑุฉ ุงููุดุชุฑูุงุช ุงููุฑุชุฌุนุฉ

1. **ุงูุชุญ ูุงุชูุฑุฉ ุงููุดุชุฑูุงุช ุงููุฑุชุฌุนุฉ**
   - ุงุฐูุจ ุฅูู `/bills/<bill_id>`
   - ุชุญูู ูู ุญุงูุฉ ุงููุฑุชุฌุน (Full/Partial)

2. **ุชุญูู ูู ุญุฑูุงุช ุงููุฎุฒูู**
   - ุงุฐูุจ ุฅูู `/inventory` ุฃู `/inventory-transactions`
   - ุงุจุญุซ ุนู ุญุฑูุงุช ูุฑุชุจุทุฉ ุจูุฐู ุงููุงุชูุฑุฉ
   - **ูุฌุจ ุฃู ุชูุฌุฏ ุญุฑูุงุช ูู ููุน `purchase_return`**

3. **ุชุญูู ูู ุชุญุฏูุซ ุงููุฎุฒูู**
   - ุงุฐูุจ ุฅูู `/inventory`
   - ุชุญูู ูู ุฃู ุงููููุงุช ุชู ุชุญุฏูุซูุง
   - **ูุฌุจ ุฃู ูููู ุงููุฎุฒูู ูุฏ ุงูุฎูุถ**

4. **ุชุญูู ูู ุงููููุฏ ุงููุญุงุณุจูุฉ**
   - ุงุฐูุจ ุฅูู `/journal-entries`
   - ุงุจุญุซ ุนู ูููุฏ ูุฑุชุจุทุฉ ุจูุฐู ุงููุงุชูุฑุฉ
   - **ูุฌุจ ุฃู ููุฌุฏ ููุฏ `purchase_return`**

#### ุจ. ุตูุญุฉ ุงููุฎุฒูู

1. **ุงูุชุญ ุตูุญุฉ ุงููุฎุฒูู**
   - ุงุฐูุจ ุฅูู `/inventory`
   - ุชุญูู ูู ุงููููุงุช

2. **ูุงุฑู ูุน ุงููุงุชูุฑุฉ**
   - ุงูุชุญ ุงููุงุชูุฑุฉ ุงููุฑุชุฌุนุฉ
   - ูุงุฑู ุงููููุงุช ูู ุงููุงุชูุฑุฉ ูุน ุงููุฎุฒูู
   - **ูุฌุจ ุฃู ูููู ุงููุฎุฒูู ูุชุทุงุจู**

---

## ๐ง ุฅุตูุงุญ ุงููุดุงูู

### ุงููุดููุฉ 1: ูุง ุชูุฌุฏ ุญุฑูุงุช ูุฎุฒูู

**ุงูุณุจุจ ุงููุญุชูู:**
- ุงูููุฏ ูู ูููุฐ ุจุดูู ุตุญูุญ
- ุฎุทุฃ ูู ุงูููุฏ
- ุงูู Trigger ูุนุทู

**ุงูุญู:**
1. ุชุญูู ูู ุงูููุฏ ูู `app/bills/[id]/page.tsx` (ุงูุณุทูุฑ 629-646)
2. ุชุญูู ูู ุฃู `inventory_transactions` ูุชู ุฅูุดุงุคูุง
3. ุชุญูู ูู ุฃู ุงูู Trigger `trg_apply_inventory_insert` ููุนู

### ุงููุดููุฉ 2: ุงููุฎุฒูู ูู ููุญุฏุซ

**ุงูุณุจุจ ุงููุญุชูู:**
- ุงูู Trigger ูุนุทู
- ุฎุทุฃ ูู ุงูู Trigger
- ุญุฑูุงุช ุงููุฎุฒูู ุบูุฑ ููุฌูุฏุฉ

**ุงูุญู:**
1. ุชุญูู ูู Trigger `trg_apply_inventory_insert` ูู `scripts/010_inventory_triggers.sql`
2. ุชุญูู ูู ุฃู Trigger ูุนูู ุจุดูู ุตุญูุญ
3. ุฃุนุฏ ุญุณุงุจ ุงููุฎุฒูู ูุฏููุงู ุฅุฐุง ูุฒู ุงูุฃูุฑ

### ุงููุดููุฉ 3: ุตูุญุฉ ุงููุฎุฒูู ูุง ุชูุญุฏุซ

**ุงูุณุจุจ ุงููุญุชูู:**
- ุงููุดููุฉ ูู Frontend (ูุง ูุชู ุฅุนุงุฏุฉ ุชุญููู ุงูุจูุงูุงุช)
- Cache ูู ุงููุชุตูุญ
- ุงููุดููุฉ ูู Backend (ูุง ูุชู ุฅุฑุฌุงุน ุงูุจูุงูุงุช ุงููุญุฏุซุฉ)

**ุงูุญู:**
1. ุฃุนุฏ ุชุญููู ุงูุตูุญุฉ (F5)
2. ุงูุณุญ Cache ุงููุชุตูุญ
3. ุชุญูู ูู ุฃู API ูุนูุฏ ุงูุจูุงูุงุช ุงููุญุฏุซุฉ

---

## ๐ ุชุณุฌูู ุงููุชุงุฆุฌ

### ุงุณุชุฎุฏุงู TESTING_RESULTS_TEMPLATE.md

ุณุฌู ุฌููุน ุงููุชุงุฆุฌ ูู `TESTING_RESULTS_TEMPLATE.md`:

```markdown
## ูุฑุชุฌุนุงุช ุงููุดุชุฑูุงุช

| ุงููุงุชูุฑุฉ | ุญุฑูุงุช ุงููุฎุฒูู | ุชุญุฏูุซ ุงููุฎุฒูู | ุงููููุฏ | ุงููุชูุฌุฉ |
|---------|---------------|---------------|--------|---------|
| BILL-0001 | โ ูุง ุชูุฌุฏ | โ ูู ููุญุฏุซ | โ ููุฌูุฏุฉ | โ FAIL |
```

---

## โ๏ธ ุงูุฃุฎุทุงุก ุงูุดุงุฆุนุฉ

### โ ุฎุทุฃ 1: ูุง ุชูุฌุฏ ุญุฑูุงุช ูุฎุฒูู

**ุงููุดููุฉ:** ูุงุชูุฑุฉ ูุดุชุฑูุงุช ูุฑุชุฌุนุฉ ูุง ุชุญุชูู ุนูู ุญุฑูุงุช ูุฎุฒูู

**ุงููุชููุน:** ูุฌุจ ุฃู ุชูุฌุฏ ุญุฑูุงุช ูุฎุฒูู ูู ููุน `purchase_return`

**ุงูุญู:**
- ุชุญูู ูู ุงูููุฏ ูู `app/bills/[id]/page.tsx`
- ุชุฃูุฏ ูู ุฃู `inventory_transactions` ูุชู ุฅูุดุงุคูุง
- ุชุญูู ูู ุฃู ุงูู Trigger ููุนู

### โ ุฎุทุฃ 2: ุงููุฎุฒูู ูู ููุญุฏุซ

**ุงููุดููุฉ:** `products.quantity_on_hand` ูู ูุชู ุชุญุฏูุซู ุจุนุฏ ุงููุฑุชุฌุน

**ุงููุชููุน:** ูุฌุจ ุฃู ูุชู ุชุญุฏูุซ `quantity_on_hand` ุชููุงุฆูุงู ุนุจุฑ Trigger

**ุงูุญู:**
- ุชุญูู ูู Trigger `trg_apply_inventory_insert`
- ุฃุนุฏ ุญุณุงุจ ุงููุฎุฒูู ูุฏููุงู ุฅุฐุง ูุฒู ุงูุฃูุฑ

### โ ุฎุทุฃ 3: ุตูุญุฉ ุงููุฎุฒูู ูุง ุชูุญุฏุซ

**ุงููุดููุฉ:** ุตูุญุฉ ุงููุฎุฒูู ูุง ุชุนุฑุถ ุงููููุงุช ุงููุญุฏุซุฉ

**ุงููุชููุน:** ูุฌุจ ุฃู ุชุนุฑุถ ุงูุตูุญุฉ ุงููููุงุช ุงููุญุฏุซุฉ ููุฑุงู

**ุงูุญู:**
- ุฃุนุฏ ุชุญููู ุงูุตูุญุฉ
- ุงูุณุญ Cache ุงููุชุตูุญ
- ุชุญูู ูู ุฃู API ูุนูุฏ ุงูุจูุงูุงุช ุงููุญุฏุซุฉ

---

## โ Checklist ุงููุฑุงุฌุนุฉ

### ูุฑุชุฌุนุงุช ุงููุดุชุฑูุงุช
- [ ] โ ุฌููุน ุงููุฑุชุฌุนุงุช ุชุญุชูู ุนูู ุญุฑูุงุช ูุฎุฒูู
- [ ] โ ุญุฑูุงุช ุงููุฎุฒูู ุณุงูุจุฉ (Stock Out)
- [ ] โ `quantity_on_hand` ูุชู ุชุญุฏูุซู ุชููุงุฆูุงู
- [ ] โ ุงููููุฏ ุงููุญุงุณุจูุฉ ููุฌูุฏุฉ
- [ ] โ `bill_items.returned_quantity` ูุญุฏุซ
- [ ] โ ุตูุญุฉ ุงููุฎุฒูู ุชุนุฑุถ ุงููููุงุช ุงููุญุฏุซุฉ

---

## ๐ ุงููููุงุช

- **ุณูุฑูุจุช ุงูุชุญูู:** `scripts/verify-purchase-returns.js`
- **ุฏููู ุงููุฑุงุฌุนุฉ:** `PURCHASE_RETURNS_REVIEW_GUIDE.md` (ูุฐุง ุงูููู)
- **ูุงูุจ ุงููุชุงุฆุฌ:** `TESTING_RESULTS_TEMPLATE.md`

---

**ุขุฎุฑ ุชุญุฏูุซ:** 2026-01-05  
**ุงูุญุงูุฉ:** โ๏ธ **ุชู ุงูุชุดุงู ูุดููุฉ - ูุญุชุงุฌ ุฅุตูุงุญ**

