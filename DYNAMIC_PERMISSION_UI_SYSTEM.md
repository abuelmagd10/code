# ๐จ ูุธุงู ูุงุฌูุฉ ุงููุณุชุฎุฏู ุงูุฏููุงููููุฉ ููุตูุงุญูุงุช

## ๐ ูุธุฑุฉ ุนุงูุฉ

ูุธุงู ูุชูุงูู ูุชุญุฏูุซ ูุงุฌูุฉ ุงููุณุชุฎุฏู (UI) ูุญุธูุงู ุญุณุจ ุงูุตูุงุญูุงุช ุจุฏูู Refresh. ูุฑุจุท ูุธุงู Realtime ููุญูููุฉ ูุจุงุดุฑุฉ ูุน ุงูููุงุฆู ูุงูุตูุญุงุช ูุงูุฃุฒุฑุงุฑ.

## ๐ฏ ุงูุฃูุฏุงู

1. **ูุตุฏุฑ ูุญูุฏ ููุตูุงุญูุงุช**: AccessContext ููุตุฏุฑ ูุญูุฏ
2. **ุชุญุฏูุซ ููุฑู ููููุงุฆู**: Sidebar ูุชุญุฏุซ ูุญุธูุงู
3. **ุญูุงูุฉ ุงููุณุงุฑุงุช**: Route Guard ูุญุธู
4. **ุชุญุฏูุซ ุงูุฃุฒุฑุงุฑ**: ุงูุฃุฒุฑุงุฑ ุชุธูุฑ/ุชุฎุชูู ููุฑุงู
5. **ุฅุบูุงู ุงูุตูุญุงุช**: ุฅุบูุงู ุชููุงุฆู ุนูุฏ ุณุญุจ ุงูุตูุงุญูุฉ

## ๐๏ธ ุงูุจููุฉ ุงููุนูุงุฑูุฉ

### 1. AccessContext - ุงููุตุฏุฑ ุงููุญูุฏ

**ุงููููุน**: `lib/access-context.tsx`

**ุงููุญุชูู**:
```typescript
interface AccessProfile {
  user_id: string
  company_id: string
  role: string
  allowed_pages: string[]
  allowed_actions: string[]
  allowed_branches: string[]
  allowed_warehouses: string[]
  // ...
}
```

**ุงููุตุงุฏุฑ**:
- โ API ุฑุณูู: `fetchAccessProfile()`
- โ Realtime Governance Events

**ููููุน**:
- โ LocalStorage ููุฑุฌุน ุฃุณุงุณู
- โ Hardcoded roles

### 2. Sidebar - ุชุญุฏูุซ ุฏููุงูููู

**ุงููููุน**: `components/sidebar.tsx`

**ุงูููุฒุงุช**:
- ุจูุงุก ุงููุงุฆูุฉ ูู `allowed_pages`
- ุฅุฎูุงุก ุงูุนูุงุตุฑ ุบูุฑ ุงููุตุฑุญ ุจูุง ููุฑุงู
- ุฅุธูุงุฑ ุงูุตูุญุงุช ุงูุฌุฏูุฏุฉ ุงููุตุฑุญ ุจูุง ููุฑุงู

**ุงูุชุญุฏูุซ**:
```typescript
const { canAccessPage, profile } = useAccess()

const isItemAllowed = (href: string): boolean => {
  const res = getResourceFromHref(href)
  return canAccessPage(res)
}
```

### 3. PageGuard - ุญูุงูุฉ ุงูุตูุญุงุช

**ุงููููุน**: `components/page-guard.tsx`

**ุงูููุฒุงุช**:
- ุงูุชุญูู ูู ุงูุตูุงุญูุฉ ุนูุฏ ุชุญููู ุงูุตูุญุฉ
- ุฅุนุงุฏุฉ ุงููุญุต ุนูุฏ ุชุญุฏูุซ ุงูุตูุงุญูุงุช
- Redirect ุชููุงุฆู ุนูุฏ ุณุญุจ ุงูุตูุงุญูุฉ

**ุงูุณููู**:
```typescript
// ุนูุฏ ุณุญุจ ุงูุตูุงุญูุฉ
if (!canAccessPage(resource)) {
  const redirectTo = getFirstAllowedPage()
  router.replace(redirectTo)
  // ุฅุธูุงุฑ ุฑุณุงูุฉ: "ุชู ุชุญุฏูุซ ุตูุงุญูุงุชู..."
}
```

### 4. RealtimeRouteGuard - ุญูุงูุฉ ุงููุณุงุฑุงุช

**ุงููููุน**: `components/realtime-route-guard.tsx`

**ุงูููุฒุงุช**:
- ุญูุงูุฉ ุฌููุน ุงููุณุงุฑุงุช
- ุชุญุฏูุซ ููุฑู ุนูุฏ ุชุบููุฑ ุงูุตูุงุญูุงุช
- ุฅุบูุงู ุงูุตูุญุงุช ุบูุฑ ุงููุตุฑุญ ุจูุง

**ุงูุงุณุชุฎุฏุงู**:
```tsx
<RealtimeRouteGuard>
  {children}
</RealtimeRouteGuard>
```

### 5. ActionButton - ุฃุฒุฑุงุฑ ุงูุนูููุงุช

**ุงููููุน**: `components/action-button.tsx`

**ุงูููุฒุงุช**:
- ุชุนุทูู ุชููุงุฆู ุนูุฏ ุณุญุจ ุงูุตูุงุญูุฉ
- ุฅุฎูุงุก ุชููุงุฆู ุนูุฏ ุนุฏู ุงูุตูุงุญูุฉ
- Tooltip ุนูุฏ ุงูุชุนุทูู

**ุงูุงุณุชุฎุฏุงู**:
```tsx
<ActionButton
  resource="invoices"
  action="delete"
  onClick={handleDelete}
  disabledTooltip="ููุณ ูุฏูู ุตูุงุญูุฉ ุญุฐู ุงูููุงุชูุฑ"
>
  ุญุฐู
</ActionButton>
```

## ๐ ุฏูุฑุฉ ุญูุงุฉ ุงูุตูุงุญูุฉ

### 1. ุงูุชุญููู ุงูุฃููู

```
1. AccessProvider ูุจุฏุฃ ุงูุชุญููู
2. fetchAccessProfile() ูู API
3. ุชุญุฏูุซ AccessContext
4. Sidebar ููุจูู ูู allowed_pages
5. PageGuard ูุชุญูู ูู ุงูุตูุงุญูุฉ
```

### 2. ุชุญุฏูุซ Realtime

```
1. Realtime Event ูู Governance Channel
2. useGovernanceRealtime ูุณุชูุจู ุงูุญุฏุซ
3. loadAccessProfile() ูุชู ุงุณุชุฏุนุงุคู
4. AccessContext ูุชุญุฏุซ
5. Sidebar ููุนุงุฏ ุจูุงุคู
6. PageGuard ูุนูุฏ ุงููุญุต
7. ุงูุฃุฒุฑุงุฑ ุชุธูุฑ/ุชุฎุชูู
```

### 3. ุณุญุจ ุงูุตูุงุญูุฉ

```
1. Realtime Event: role changed / permission removed
2. AccessContext ูุชุญุฏุซ
3. canAccessPage() ูุนูุฏ false
4. PageGuard ููุชุดู ุนุฏู ุงูุตูุงุญูุฉ
5. Redirect ุชููุงุฆู ุฅูู getFirstAllowedPage()
6. Toast: "ุชู ุชุญุฏูุซ ุตูุงุญูุงุชู..."
```

## ๐ ุชุฏูู ุงูุชุญุฏูุซ ุงููุญุธู

```
Realtime Event
    โ
useGovernanceRealtime
    โ
loadAccessProfile()
    โ
AccessContext Updated
    โ
โโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโ
โ   Sidebar       โ   PageGuard     โ  ActionButton   โ
โ   Re-render     โ   Re-check      โ   Disable/Hide  โ
โโโโโโโโโโโโโโโโโโโดโโโโโโโโโโโโโโโโโโดโโโโโโโโโโโโโโโโโโ
```

## ๐งช ุณููุงุฑูููุงุช ุงูุงุฎุชุจุงุฑ

### 1. ุชุบููุฑ ุงูุฏูุฑ

**ุงูุฎุทูุงุช**:
1. ุชุณุฌูู ุฏุฎูู ููุณุชุฎุฏู ุนุงุฏู
2. ูุชุญ ุตูุญุฉ `/invoices`
3. ูู ุญุณุงุจ Admin: ุชุบููุฑ ุงูุฏูุฑ ุฅูู `viewer`
4. **ุงููุชูุฌุฉ ุงููุชููุนุฉ**:
   - โ Toast: "ุชู ุชุญุฏูุซ ุตูุงุญูุงุชู"
   - โ Sidebar: ุฅุฎูุงุก `/invoices`
   - โ PageGuard: ุฅุบูุงู ุงูุตูุญุฉ
   - โ Redirect ุฅูู `/dashboard`

### 2. ุฅุถุงูุฉ ุตูุงุญูุฉ

**ุงูุฎุทูุงุช**:
1. ุชุณุฌูู ุฏุฎูู ููุณุชุฎุฏู ุจุฏูุฑ `employee`
2. ูู ุญุณุงุจ Admin: ุฅุถุงูุฉ ุตูุงุญูุฉ `invoices:delete`
3. **ุงููุชูุฌุฉ ุงููุชููุนุฉ**:
   - โ Toast: "ุชู ุชุญุฏูุซ ุตูุงุญูุงุช ุงูุฏูุฑ"
   - โ ActionButton: ุชูุนูู ุฒุฑ ุงูุญุฐู
   - โ ูุง ุญุงุฌุฉ ูู Refresh

### 3. ุชุบููุฑ ุงููุฑุน

**ุงูุฎุทูุงุช**:
1. ุชุณุฌูู ุฏุฎูู ูู ูุฑุน `branch-1`
2. ูู ุญุณุงุจ Admin: ุชุบููุฑ ุงููุฑุน ุฅูู `branch-2`
3. **ุงููุชูุฌุฉ ุงููุชููุนุฉ**:
   - โ Toast: "ุชู ุชุญุฏูุซ ุชุนูููู"
   - โ ุชุญุฏูุซ ุงูุจูุงูุงุช ุงููุนุฑูุถุฉ
   - โ ุฅุนุงุฏุฉ ุจูุงุก ุงูุงุดุชุฑุงูุงุช

## ๐ซ ููุน ุงูุฃุฎุทุงุก ุงูุดุงุฆุนุฉ

### โ ุฎุทุฃ: ุฅุธูุงุฑ ุตูุญุฉ ุซู ุชุนุทูู ุฒุฑ ููุท

**ุงูุญู**:
```typescript
// โ ุตุญูุญ: ุงูุตูุญุฉ ููุณูุง ุชุฎุชูู
if (!canAccessPage('invoices')) {
  router.replace(getFirstAllowedPage())
}

// โ ุฎุทุฃ: ุฅุธูุงุฑ ุงูุตูุญุฉ ูุชุนุทูู ุงูุฒุฑ
<PageGuard>
  <Button disabled={!canDelete}>ุญุฐู</Button>
</PageGuard>
```

### โ ุฎุทุฃ: ุงูุงุญุชูุงุธ ุจูุงุฆูุฉ ูุฏููุฉ

**ุงูุญู**:
```typescript
// โ ุตุญูุญ: ุฅุนุงุฏุฉ ุจูุงุก ุงููุงุฆูุฉ ูู allowed_pages
const menuItems = allItems.filter(item => 
  canAccessPage(getResourceFromHref(item.href))
)

// โ ุฎุทุฃ: ุงุณุชุฎุฏุงู ูุงุฆูุฉ ุซุงุจุชุฉ
const menuItems = staticMenuItems
```

### โ ุฎุทุฃ: ุงูุณูุงุญ ุจุงูุฏุฎูู ููุณุงุฑ ูุญููุธ

**ุงูุญู**:
```typescript
// โ ุตุญูุญ: Route Guard ููุญุต ูู ูู ูุฑุฉ
<RealtimeRouteGuard>
  {children}
</RealtimeRouteGuard>

// โ ุฎุทุฃ: ุงูุงุนุชูุงุฏ ุนูู Link ููุท
<Link href="/invoices">ุงูููุงุชูุฑ</Link>
```

## โ ููุงุนุฏ ERP ุงูุฅูุฒุงููุฉ

1. **ุงูุญูุงูุฉ ูุชุนุฏุฏุฉ ุงูุทุจูุงุช**:
   - โ ุงููุงุฌูุฉ (UI)
   - โ ุงููุณุงุฑุงุช (Routes)
   - โ API
   - โ Realtime

2. **ูุง Refresh ูุทููุจ**:
   - โ ุชุญุฏูุซ ููุฑู
   - โ ุจุฏูู ุฅุนุงุฏุฉ ุชุญููู
   - โ ุจุฏูู Logout

3. **ุชุฌุฑุจุฉ ุงุญุชุฑุงููุฉ**:
   - โ ุฑุณุงุฆู ูุงุถุญุฉ
   - โ ุงูุชูุงู ุณูุณ
   - โ ูุง ูููุถ (Flicker)

## ๐ ุงููุฑุงุฌุน

- `lib/access-context.tsx` - AccessContext
- `components/sidebar.tsx` - Sidebar
- `components/page-guard.tsx` - PageGuard
- `components/realtime-route-guard.tsx` - Route Guard
- `components/action-button.tsx` - Action Button
- `GOVERNANCE_REALTIME_SYSTEM.md` - ูุธุงู Realtime ููุญูููุฉ
