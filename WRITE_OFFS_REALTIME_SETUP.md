# ๐ ุฅุนุฏุงุฏ Realtime ููุงุฆูุฉ ุงูุฅููุงูุงุช

## ๐ ูุธุฑุฉ ุนุงูุฉ

ูุฐุง ุงููุณุชูุฏ ููุถุญ ููููุฉ ุฅุนุฏุงุฏ Supabase Realtime ููุงุฆูุฉ ุงูุฅููุงูุงุช ูุถูุงู ุงูุชุญุฏูุซ ุงููุญุธู ุจุฏูู Refresh.

---

## 1๏ธโฃ ุชูุนูู Realtime ูู Supabase Dashboard

### ุงูุฎุทูุงุช ุงูุฅูุฒุงููุฉ:

1. **ุงูุชุญ Supabase Dashboard**
   - ุงุฐูุจ ุฅูู: `https://supabase.com/dashboard`
   - ุงุฎุชุฑ ุงููุดุฑูุน ุงูุฎุงุต ุจู

2. **ุงูุชุญ Database โ Replication**
   - ูู ุงููุงุฆูุฉ ุงูุฌุงูุจูุฉ: `Database` โ `Replication`

3. **ุชูุนูู Realtime ุนูู ุงูุฌุฏุงูู:**

   โ **ุฌุฏูู `inventory_write_offs`:**
   - ุงุจุญุซ ุนู `inventory_write_offs` ูู ุงููุงุฆูุฉ
   - ูุนูู:
     - โ INSERT
     - โ UPDATE
     - โ DELETE

   โ **ุฌุฏูู `inventory_write_off_items` (ุงุฎุชูุงุฑู):**
   - ุฅุฐุง ููุช ุชุฑูุฏ ุชุญุฏูุซุงุช ูุญุธูุฉ ุนูู ุงูุจููุฏ ุฃูุถุงู
   - ูุนูู:
     - โ INSERT
     - โ UPDATE
     - โ DELETE

### โ๏ธ ุชุญุฐูุฑ ููู:

**ุฅุฐุง ูู ุชูุนูู Realtime ูู Supabase Dashboard:**
- โ ูู ุชุตู ุฃู ุฃุญุฏุงุซ ูููุง ูุงู ุงูููุฏ ุตุญูุญูุง
- โ ูู ูุนูู ุงูุชุญุฏูุซ ุงููุญุธู
- โ ุณุชุญุชุงุฌ ุฅูู Refresh ูุฏูู ุฏุงุฆูุงู

---

## 2๏ธโฃ ุงูุชุญูู ูู ุงูุงุดุชุฑุงู (Subscription Verification)

### ูู Console ุงููุชุตูุญ:

ุจุนุฏ ูุชุญ ุตูุญุฉ ูุงุฆูุฉ ุงูุฅููุงูุงุชุ ูุฌุจ ุฃู ุชุฑู:

```
โ [RealtimeManager] Subscribed to inventory_write_offs
```

### ุนูุฏ ุงุณุชูุจุงู ุญุฏุซ:

```
[REALTIME] write_off event {
  type: 'UPDATE',
  id: 'xxx-xxx-xxx',
  status: 'approved',
  branch: 'xxx-xxx-xxx',
  warehouse: 'xxx-xxx-xxx',
  company_id: 'xxx-xxx-xxx'
}
```

### ุฅุฐุง ูู ุชุฑู ูุฐู ุงูุฑุณุงุฆู:

1. โ ุชุญูู ูู ุชูุนูู Realtime ูู Supabase Dashboard
2. โ ุชุญูู ูู ุฃู `companyId` ู `userContext` ููุฌูุฏุงู
3. โ ุชุญูู ูู Console ููุฃุฎุทุงุก

---

## 3๏ธโฃ ูุนุงูุฌุฉ ุงูุฃุญุฏุงุซ (Event Handling)

### INSERT Event:

ุนูุฏ ุฅูุดุงุก ุฅููุงู ุฌุฏูุฏ:
- โ ูุชู ุฅุซุฑุงุก ุงูุจูุงูุงุช (enrichment) ุชููุงุฆูุงู
- โ ูุธูุฑ ูู ุงููุงุฆูุฉ ููุฑุงู
- โ ูุง ุญุงุฌุฉ ูู `loadData()`

### UPDATE Event:

ุนูุฏ ุชุนุฏูู/ุงุนุชูุงุฏ/ุฑูุถ ุฅููุงู:
- โ ูุชู ุฅุซุฑุงุก ุงูุจูุงูุงุช (enrichment) ุชููุงุฆูุงู
- โ ูุชุญุฏุซ ุงูุณุฌู ูู ุงููุงุฆูุฉ ููุฑุงู
- โ ุชุชุบูุฑ ุงูุญุงูุฉ ููุฑุงู
- โ ูุง ุญุงุฌุฉ ูู `loadData()`

### DELETE Event:

ุนูุฏ ุญุฐู ุฅููุงู:
- โ ูุฎุชูู ูู ุงููุงุฆูุฉ ููุฑุงู
- โ ูุง ุญุงุฌุฉ ูู `loadData()`

---

## 4๏ธโฃ ุฅุซุฑุงุก ุงูุจูุงูุงุช (Data Enrichment)

### ุงููุดููุฉ:

Realtime events ูุง ุชุญุชูู ุนูู:
- `branch_name` (ูู ุฌุฏูู `branches`)
- `warehouse_name` (ูู ุฌุฏูู `warehouses`)
- `created_by_name` (ูู ุฌุฏูู `user_profiles`)
- `total_quantity` (ูุฌููุน ูู `inventory_write_off_items`)
- `products_summary` (ููุฎุต ุงูููุชุฌุงุช)

### ุงูุญู:

ุฏุงูุฉ `enrichWriteOff` ุชููู ุจู:
1. ุฌูุจ `branches`, `warehouses`, `user_profiles`, `inventory_write_off_items` ูู batch
2. ุญุณุงุจ `total_quantity` ู `items_count`
3. ุจูุงุก `products_summary`
4. ุฅุฑุฌุงุน ุงูุณุฌู ุงููุฎุตูุต (enriched)

### ุงูุงุณุชุฎุฏุงู:

```typescript
const enrichedWriteOff = await enrichWriteOff(newWriteOff)
```

---

## 5๏ธโฃ ุงุญุชุฑุงู ุงูุตูุงุญูุงุช (Permission Handling)

### Filter Logic:

ุงูููุชุฑ ูู `useRealtimeTable` ูุชุญูู ูู:

1. **Owner/Admin:**
   - โ ูุฑูุง ุฌููุน ุงูุฃุญุฏุงุซ ูู ุงูุดุฑูุฉ

2. **ุงููุณุชุฎุฏู ุงูุฐู ุฃูุดุฃ ุงูุฅููุงู:**
   - โ ูุฑู ุฌููุน ุงูุชุญุฏูุซุงุช ุนูู ุฅููุงูุงุชู
   - โ ุญุชู ูู ูู ููู ูู ูู ุนุฏููุง (ูุซู ุงุนุชูุงุฏ/ุฑูุถ ูู ุงููุงูู)

3. **Manager/Accountant:**
   - โ ูุฑูุง ุฅููุงูุงุช ูู ูุฑุนูู

4. **Employee:**
   - โ ูุฑูุง ุฅููุงูุงุช ูู ูุฎุฒููู ููุท

### ูู `shouldProcessEvent` (realtime-manager.ts):

```typescript
// โ Owner/Admin ูุฑูุง ูู ุดูุก
if (role === 'owner' || role === 'admin') {
  return true
}

// โ ุงููุณุชุฎุฏู ุงูุฐู ุฃูุดุฃ ุงูุฅููุงู ูุฑู ุชุญุฏูุซุงุชู
if (userId && record.created_by === userId) {
  return true
}

// โ Manager ูุฑู ุฅููุงูุงุช ูุฑุนู
if (accessFilter.filterByBranch && accessInfo.branchId && record.branch_id === accessInfo.branchId) {
  return true
}

// โ Store Manager ูุฑู ุฅููุงูุงุช ูุฎุฒูู
if (accessFilter.filterByWarehouse && accessInfo.warehouseId && record.warehouse_id === accessInfo.warehouseId) {
  return true
}
```

---

## 6๏ธโฃ ุฅุฒุงูุฉ loadData() ุบูุฑ ุงูุถุฑูุฑูุฉ

### โ๏ธ ููููุน:

- โ `loadData()` ุจุนุฏ ุฅูุดุงุก ุฅููุงู
- โ `loadData()` ุจุนุฏ ุชุนุฏูู ุฅููุงู
- โ `loadData()` ุจุนุฏ ุงุนุชูุงุฏ/ุฑูุถ ุฅููุงู
- โ `router.refresh()`
- โ `revalidatePath()`

### โ ูุณููุญ:

- โ `loadData()` ููุท ุนูุฏ:
  - ุชุญููู ุงูุตูุญุฉ ูุฃูู ูุฑุฉ
  - ุชุบููุฑ ุงูููุงุชุฑ (status, dateFrom, dateTo)
  - ุชุบููุฑ ุงููุฑุน/ุงููุฎุฒู

---

## 7๏ธโฃ ุณููุงุฑูููุงุช ุงูุงุฎุชุจุงุฑ

### Test 1: ุฅูุดุงุก ุฅููุงู ุฌุฏูุฏ

**ุงูุฎุทูุงุช:**
1. ุงูุชุญ ูุงุฆูุฉ ุงูุฅููุงูุงุช ููุณุชุฎุฏู ุนุงุฏู
2. ุฃูุดุฆ ุฅููุงู ุฌุฏูุฏ ูู ุตูุญุฉ ุฃุฎุฑู ุฃู ุชุจููุจ ุขุฎุฑ

**ุงููุชูุฌุฉ ุงููุชููุนุฉ:**
- โ ูุธูุฑ ุงูุฅููุงู ููุฑุงู ูู ุงููุงุฆูุฉ
- โ ุจุฏูู Refresh
- โ ูุน ุฌููุน ุงูุจูุงูุงุช ุงููุฎุตูุตุฉ (branch_name, warehouse_name, products_summary)

### Test 2: ุชุนุฏูู ุฅููุงู

**ุงูุฎุทูุงุช:**
1. ุงูุชุญ ูุงุฆูุฉ ุงูุฅููุงูุงุช ููุณุชุฎุฏู ุนุงุฏู
2. ุนุฏูู ุฅููุงู ูู ุตูุญุฉ ุฃุฎุฑู ุฃู ุชุจููุจ ุขุฎุฑ

**ุงููุชูุฌุฉ ุงููุชููุนุฉ:**
- โ ูุชุญุฏุซ ุงูุฅููุงู ููุฑุงู ูู ุงููุงุฆูุฉ
- โ ุจุฏูู Refresh
- โ ูุน ุฌููุน ุงูุจูุงูุงุช ุงููุฎุตูุตุฉ ุงููุญุฏุซุฉ

### Test 3: ุงุนุชูุงุฏ ุฅููุงู

**ุงูุฎุทูุงุช:**
1. ุงูุชุญ ูุงุฆูุฉ ุงูุฅููุงูุงุช ููุณุชุฎุฏู ุนุงุฏู (ููุดุฆ ุงูุฅููุงู)
2. ุงุนุชูุฏ ุงูุฅููุงู ูู ุงููุงูู ูู ุชุจููุจ ุขุฎุฑ

**ุงููุชูุฌุฉ ุงููุชููุนุฉ:**
- โ ุชุชุบูุฑ ุงูุญุงูุฉ ูู `pending` ุฅูู `approved` ููุฑุงู
- โ ูุธูุฑ `approved_at` ู `approved_by`
- โ ูุฎุชูู ูู ูุงุฆูุฉ "Pending"
- โ ูุธูุฑ ูู ูุงุฆูุฉ "Approved"
- โ ุจุฏูู Refresh

### Test 4: ุฑูุถ ุฅููุงู

**ุงูุฎุทูุงุช:**
1. ุงูุชุญ ูุงุฆูุฉ ุงูุฅููุงูุงุช ููุณุชุฎุฏู ุนุงุฏู (ููุดุฆ ุงูุฅููุงู)
2. ุงุฑูุถ ุงูุฅููุงู ูู ุงููุงูู ูู ุชุจููุจ ุขุฎุฑ

**ุงููุชูุฌุฉ ุงููุชููุนุฉ:**
- โ ุชุชุบูุฑ ุงูุญุงูุฉ ูู `pending` ุฅูู `rejected` ููุฑุงู
- โ ูุธูุฑ `rejected_at` ู `rejected_by`
- โ ูุฎุชูู ูู ูุงุฆูุฉ "Pending"
- โ ูุธูุฑ ูู ูุงุฆูุฉ "Rejected"
- โ ุจุฏูู Refresh

---

## 8๏ธโฃ Logging ููุชุญูู

### ูู Console ุงููุชุตูุญ:

ุนูุฏ ุงุณุชูุจุงู ุญุฏุซ Realtime:

```
[REALTIME] write_off event {
  type: 'UPDATE',
  id: 'xxx-xxx-xxx',
  status: 'approved',
  branch: 'xxx-xxx-xxx',
  warehouse: 'xxx-xxx-xxx',
  company_id: 'xxx-xxx-xxx'
}

๐ [Realtime] Write-off updated: xxx-xxx-xxx {
  oldStatus: 'pending',
  newStatus: 'approved'
}

โ [Realtime] Write-off replaced with enriched data: xxx-xxx-xxx {
  status: 'approved',
  totalCost: 1250.00,
  totalQuantity: 15
}
```

### ุฅุฐุง ูู ุชุฑู ูุฐู ุงูุฑุณุงุฆู:

1. โ ุชุญูู ูู ุชูุนูู Realtime ูู Supabase Dashboard
2. โ ุชุญูู ูู ุฃู ุงูุงุดุชุฑุงู ูุฌุญ: `โ [RealtimeManager] Subscribed to inventory_write_offs`
3. โ ุชุญูู ูู Console ููุฃุฎุทุงุก

---

## 9๏ธโฃ ุงุณุชูุดุงู ุงูุฃุฎุทุงุก (Troubleshooting)

### ุงููุดููุฉ: ุงูุฃุญุฏุงุซ ูุง ุชุตู

**ุงูุญููู:**
1. โ ุชุญูู ูู ุชูุนูู Realtime ูู Supabase Dashboard
2. โ ุชุญูู ูู `companyId` ู `userContext` ููุฌูุฏุงู
3. โ ุชุญูู ูู Console ููุฃุฎุทุงุก
4. โ ุชุญูู ูู ุฃู ุงูุงุดุชุฑุงู ูุฌุญ

### ุงููุดููุฉ: ุงูุฃุญุฏุงุซ ุชุตู ููู ุงูุจูุงูุงุช ูุง ุชุชุญุฏุซ

**ุงูุญููู:**
1. โ ุชุญูู ูู ุฃู `enrichWriteOff` ุชุนูู ุจุดูู ุตุญูุญ
2. โ ุชุญูู ูู Console ููุฃุฎุทุงุก ูู `onInsert`/`onUpdate`
3. โ ุชุญูู ูู ุฃู `setWriteOffs` ูุชู ุงุณุชุฏุนุงุคู

### ุงููุดููุฉ: ุงูุจูุงูุงุช ุงููุฎุตูุตุฉ (enriched data) ููููุฏุฉ

**ุงูุญููู:**
1. โ ุชุญูู ูู ุฃู `enrichWriteOff` ูุชู ุงุณุชุฏุนุงุคูุง
2. โ ุชุญูู ูู Console ููุฃุฎุทุงุก ูู `enrichWriteOff`
3. โ ุชุญูู ูู ุฃู ุงูุฌุฏุงูู ุงููุฑุชุจุทุฉ (`branches`, `warehouses`, `user_profiles`, `inventory_write_off_items`) ููุฌูุฏุฉ

---

## ๐ ุงูุฎูุงุตุฉ

โ **Realtime ููุนูู:** ูู Supabase Dashboard

โ **ุงูุงุดุชุฑุงู ูุนูู:** `useRealtimeTable` ูุณุชูุจู ุงูุฃุญุฏุงุซ

โ **ุฅุซุฑุงุก ุงูุจูุงูุงุช:** `enrichWriteOff` ุชุถูู ุงูุจูุงูุงุช ุงููุฎุตูุตุฉ

โ **ูุง Refresh:** ุฅุฒุงูุฉ ุฌููุน ุงุณุชุฏุนุงุกุงุช `loadData()` ุบูุฑ ุงูุถุฑูุฑูุฉ

โ **ุงุญุชุฑุงู ุงูุตูุงุญูุงุช:** Filter logic ูุถูู ุงูุฃูุงู

โ **Logging:** ููุชุญูู ูู ูุตูู ุงูุฃุญุฏุงุซ

---

**ุขุฎุฑ ุชุญุฏูุซ:** 2026-01-23
