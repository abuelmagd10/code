# ๐ ุชูุฑูุฑ ูุฑุงุฌุนุฉ ูุธุงู ุงูุญูููุฉ ูุงูุตูุงุญูุงุช

## ๐ฏ ุงููุฏู
ูุฑุงุฌุนุฉ ุดุงููุฉ ููุธุงู ุงูุญูููุฉ ูุตูุงุญูุงุช ุนุฑุถ ุฃูุงูุฑ ุงูุจูุน ูุงูููุงุชูุฑุ ูุชุญุฏูุฏ ูู ูุธูุฑ ูู ูุงุฐุง ุญุณุจ ุงูุฏูุฑ ูุงูููุท ุงููุญุงุณุจู.

---

## ๐ ุงููุถุน ุงูุญุงูู

### โ ุฃูุงูุฑ ุงูุจูุน (Sales Orders)

#### 1. **ูุธุงู ุงูุชุญููู ุงูุญุงูู** (`loadOrders`)
```typescript
// โ ุชุญููู ูุจุณุท - ูุนุฑุถ ุฌููุน ุฃูุงูุฑ ุงูุจูุน ููุดุฑูุฉ
const { data: so } = await supabase
  .from("sales_orders")
  .select("*")
  .eq("company_id", activeCompanyId)
  .order("created_at", { ascending: false });
```

**ุงูุญุงูุฉ**: โ **ูุจุณุท ููุนูู ุจุดูู ุตุญูุญ**
- ูุนุฑุถ ุฌููุน ุฃูุงูุฑ ุงูุจูุน (60 ุฃูุฑ) ููุดุฑูุฉ
- ูุง ุชูุฌุฏ ููุงุชุฑ ุญูููุฉ ูุนูุฏุฉ
- ูุนุชูุฏ ููุท ุนูู `company_id`

#### 2. **ูุธุงู ุงูุตูุงุญูุงุช**
```typescript
// ุชุญุฏูุฏ ูู ูุฑู ุฌููุน ุงูุฃูุงูุฑ
const accessLevel = getRoleAccessLevel(role);
const canViewAll = accessLevel === 'all' || accessLevel === 'company' || accessLevel === 'branch';
```

**ุงูุฃุฏูุงุฑ ุงูุชู ุชุฑู ุฌููุน ุงูุฃูุงูุฑ**:
- โ `owner` - ุงููุงูู (ูุณุชูู: all)
- โ `admin` - ุงููุฏูุฑ (ูุณุชูู: company)
- โ `manager` - ูุฏูุฑ ุงููุฑุน (ูุณุชูู: branch)

**ุงูุฃุฏูุงุฑ ุงููุญุฏูุฏุฉ**:
- โ๏ธ `staff` - ุงูููุธู (ูุฑู ุฃูุงูุฑู ููุท)
- โ๏ธ `sales` - ููุฏูุจ ุงููุจูุนุงุช (ูุฑู ุฃูุงูุฑู ููุท)

#### 3. **ููุชุฑ ุงูููุธููู** (ูููุฏูุฑูู ููุท)
```typescript
// ูุธูุฑ ููุท ูููุฏูุฑูู (canViewAllOrders = true)
{canViewAllOrders && employees.length > 0 && (
  <Select value={filterEmployeeId} onValueChange={setFilterEmployeeId}>
    // ูุงุฆูุฉ ุงูููุธููู
  </Select>
)}
```

**ุงููุธููุฉ**: 
- ูุณูุญ ูููุฏูุฑูู ุจููุชุฑุฉ ุงูุฃูุงูุฑ ุญุณุจ ุงูููุธู ุงูููุดุฆ
- ูุนุชูุฏ ุนูู `created_by_user_id` ูู ุฌุฏูู `sales_orders`

---

### โ ุงูููุงุชูุฑ (Invoices)

#### 1. **ูุธุงู ุงูุชุญููู ุงูุญุงูู** (`loadData`)
```typescript
// โ ุงุณุชุฎุฏุงู ูุธุงู Data Visibility & Access Control ุงูููุญุฏ
const visibilityRules = buildDataVisibilityFilter(context);

let invoicesQuery = supabase
  .from("invoices")
  .select("*, customers(name, phone)")
  .eq("company_id", visibilityRules.companyId);

// ุชุทุจูู ููุงุนุฏ ุงูุฑุคูุฉ
invoicesQuery = applyDataVisibilityFilter(invoicesQuery, visibilityRules, "invoices");
```

**ุงูุญุงูุฉ**: โ **ูุณุชุฎุฏู ูุธุงู ุญูููุฉ ููุญุฏ**
- ูุทุจู ููุงุชุฑ ุญุณุจ ุงูุฏูุฑ ูุงููุฑุน ููุฑูุฒ ุงูุชูููุฉ
- ูุฏุนู ุงูููุชุฑุฉ ุงููุนูุฏุฉ

#### 2. **ูุธุงู ุงูุตูุงุญูุงุช**
```typescript
// ุชุญุฏูุฏ ูู ูุฑู ุฌููุน ุงูููุงุชูุฑ
const canViewAll = ["owner", "admin", "accountant", "viewer"].includes(role);
```

**ุงูุฃุฏูุงุฑ ุงูุชู ุชุฑู ุฌููุน ุงูููุงุชูุฑ**:
- โ `owner` - ุงููุงูู
- โ `admin` - ุงููุฏูุฑ
- โ `accountant` - ุงููุญุงุณุจ
- โ `viewer` - ุงููุดุงูุฏ

**ุงูุฃุฏูุงุฑ ุงููุญุฏูุฏุฉ**:
- โ๏ธ `staff` - ุงูููุธู (ูุฑู ููุงุชูุฑู ููุท)

#### 3. **ุฑุจุท ุงูููุงุชูุฑ ุจุฃูุงูุฑ ุงูุจูุน**
```typescript
// ุฌูุจ ุฃูุงูุฑ ุงูุจูุน ุงููุฑุชุจุทุฉ ููุนุฑูุฉ ุงูููุธู ุงูููุดุฆ
const salesOrderIds = invoices.filter(inv => inv.sales_order_id).map(inv => inv.sales_order_id);

// ุจูุงุก ุฎุฑูุทุฉ: invoice_id -> created_by_user_id
const invToEmpMap: Record<string, string> = {};
```

**ุงููุธููุฉ**:
- ุฑุจุท ูู ูุงุชูุฑุฉ ุจุงูููุธู ุงูุฐู ุฃูุดุฃ ุฃูุฑ ุงูุจูุน ุงูุฃุตูู
- ูุณุชุฎุฏู ูู ููุชุฑ ุงูููุธููู ูููุฏูุฑูู

#### 4. **ููุชุฑ ุงูููุธููู** (ูููุฏูุฑูู ููุท)
```typescript
// ููุชุฑุฉ ุญุณุจ ุงูููุธู ุงูููุดุฆ ูุฃูุฑ ุงูุจูุน ุงููุฑุชุจุท
if (canViewAllInvoices && filterEmployeeId && filterEmployeeId !== "all") {
  const employeeId = invoiceToEmployeeMap[inv.id];
  if (employeeId !== filterEmployeeId) return false;
}
```

---

## ๐ ุงูุนูุงูุฉ ุจูู ุฃูุงูุฑ ุงูุจูุน ูุงูููุงุชูุฑ

### 1. **ุงูุชุญููู ูู ุฃูุฑ ุจูุน ุฅูู ูุงุชูุฑุฉ**
```typescript
// ุนูุฏ ุงูุชุญููู
const invPayload = {
  sales_order_id: so.id, // ุฑุจุท ุงููุงุชูุฑุฉ ุจุฃูุฑ ุงูุจูุน
  branch_id: userContext?.branch_id,
  cost_center_id: userContext?.cost_center_id,
  warehouse_id: userContext?.warehouse_id,
  // ... ุจุงูู ุงูุจูุงูุงุช
};

// ุชุญุฏูุซ ุฃูุฑ ุงูุจูุน
await supabase.from("sales_orders").update({
  status: "invoiced",
  invoice_id: inv.id
}).eq("id", so.id);
```

**ุงููุชูุฌุฉ**:
- โ ุงููุงุชูุฑุฉ ูุฑุชุจุทุฉ ุจุฃูุฑ ุงูุจูุน (`sales_order_id`)
- โ ุฃูุฑ ุงูุจูุน ูุฑุชุจุท ุจุงููุงุชูุฑุฉ (`invoice_id`)
- โ ุงููุงุชูุฑุฉ ุชุฑุซ ุงููุฑุน ููุฑูุฒ ุงูุชูููุฉ ูู ุณูุงู ุงููุณุชุฎุฏู

### 2. **ุนุฑุถ ุงููุงุชูุฑุฉ ุงููุฑุชุจุทุฉ ูู ุฃูุงูุฑ ุงูุจูุน**
```typescript
// ูู ุฌุฏูู ุฃูุงูุฑ ุงูุจูุน
{row.sales_order_id && (
  <Link href={`/sales-orders/${row.sales_order_id}`}>
    <Button variant="ghost" size="icon">
      <ShoppingCart className="w-4 h-4 text-orange-500" />
    </Button>
  </Link>
)}
```

### 3. **ุนุฑุถ ุฃูุฑ ุงูุจูุน ุงููุฑุชุจุท ูู ุงูููุงุชูุฑ**
```typescript
// ูู ุฌุฏูู ุงูููุงุชูุฑ
{row.sales_order_id && (
  <Link href={`/sales-orders/${row.sales_order_id}`}>
    <Button variant="ghost" size="icon">
      <ShoppingCart className="w-4 h-4 text-orange-500" />
    </Button>
  </Link>
)}
```

---

## ๐ ุฌุฏูู ุงูุตูุงุญูุงุช ุญุณุจ ุงูุฏูุฑ

| ุงูุฏูุฑ | ุฃูุงูุฑ ุงูุจูุน | ุงูููุงุชูุฑ | ููุชุฑ ุงูููุธููู | ุงูููุงุญุธุงุช |
|------|------------|---------|--------------|----------|
| **Owner** (ูุงูู) | โ ุฌููุน ุงูุฃูุงูุฑ | โ ุฌููุน ุงูููุงุชูุฑ | โ ูุชุงุญ | ุตูุงุญูุงุช ูุงููุฉ |
| **Admin** (ูุฏูุฑ) | โ ุฌููุน ุงูุฃูุงูุฑ | โ ุฌููุน ุงูููุงุชูุฑ | โ ูุชุงุญ | ุตูุงุญูุงุช ูุงููุฉ |
| **Manager** (ูุฏูุฑ ูุฑุน) | โ ุฃูุงูุฑ ุงููุฑุน | โ๏ธ ููุงุชูุฑ ุงููุฑุน | โ ูุชุงุญ (ููุธูู ุงููุฑุน) | ูุญุฏูุฏ ุจุงููุฑุน |
| **Accountant** (ูุญุงุณุจ) | โ๏ธ ุฃูุงูุฑู ููุท | โ ุฌููุน ุงูููุงุชูุฑ | โ ุบูุฑ ูุชุงุญ | ูุฑู ุฌููุน ุงูููุงุชูุฑ |
| **Staff** (ููุธู) | โ๏ธ ุฃูุงูุฑู ููุท | โ๏ธ ููุงุชูุฑู ููุท | โ ุบูุฑ ูุชุงุญ | ูุญุฏูุฏ ุฌุฏุงู |
| **Sales** (ูุจูุนุงุช) | โ๏ธ ุฃูุงูุฑู ููุท | โ๏ธ ููุงุชูุฑู ููุท | โ ุบูุฑ ูุชุงุญ | ูุญุฏูุฏ ุฌุฏุงู |
| **Viewer** (ูุดุงูุฏ) | โ๏ธ ุฃูุงูุฑู ููุท | โ ุฌููุน ุงูููุงุชูุฑ | โ ุบูุฑ ูุชุงุญ | ูุฑุงุกุฉ ููุท |

---

## ๐ ุณููุงุฑูููุงุช ุงูุงุณุชุฎุฏุงู

### ุงูุณููุงุฑูู 1: ููุธู ูุจูุนุงุช ููุดุฆ ุฃูุฑ ุจูุน
1. โ ุงูููุธู ููุดุฆ ุฃูุฑ ุจูุน ุฌุฏูุฏ
2. โ ูุชู ุญูุธ `created_by_user_id` = ูุนุฑู ุงูููุธู
3. โ ุงูููุธู ูุฑู ุฃูุฑ ุงูุจูุน ูู ูุงุฆูุชู
4. โ ุงููุฏูุฑ ูุฑู ุฃูุฑ ุงูุจูุน ูู ูุงุฆูุฉ ุฌููุน ุงูุฃูุงูุฑ
5. โ ุงููุฏูุฑ ููููู ููุชุฑุฉ ุงูุฃูุงูุฑ ุญุณุจ ุงูููุธู

### ุงูุณููุงุฑูู 2: ุชุญููู ุฃูุฑ ุจูุน ุฅูู ูุงุชูุฑุฉ
1. โ ุงููุฏูุฑ ูุญูู ุฃูุฑ ุงูุจูุน ุฅูู ูุงุชูุฑุฉ
2. โ ุงููุงุชูุฑุฉ ุชุฑุชุจุท ุจุฃูุฑ ุงูุจูุน (`sales_order_id`)
3. โ ุฃูุฑ ุงูุจูุน ูุฑุชุจุท ุจุงููุงุชูุฑุฉ (`invoice_id`)
4. โ ุงููุงุชูุฑุฉ ุชุฑุซ ุงููุฑุน ููุฑูุฒ ุงูุชูููุฉ
5. โ ุงููุญุงุณุจ ูุฑู ุงููุงุชูุฑุฉ (ูุฃูู ูุฑู ุฌููุน ุงูููุงุชูุฑ)
6. โ๏ธ ุงูููุธู ุงูุฃุตูู ูุฑู ุงููุงุชูุฑุฉ ููุท ุฅุฐุง ูุงู ูุฑุชุจุทุงู ุจุฃูุฑ ุจูุนู

### ุงูุณููุงุฑูู 3: ูุฏูุฑ ูุฑุน ูููุชุฑ ุงูุฃูุงูุฑ
1. โ ุงููุฏูุฑ ูุฑู ุฌููุน ุฃูุงูุฑ ูุฑุนู
2. โ ูุธูุฑ ูู ููุชุฑ ุงูููุธููู (ููุธูู ูุฑุนู ููุท)
3. โ ููููู ููุชุฑุฉ ุงูุฃูุงูุฑ ุญุณุจ ููุธู ูุนูู
4. โ ููููู ุฑุคูุฉ ุงูููุงุชูุฑ ุงููุฑุชุจุทุฉ ุจุงูุฃูุงูุฑ

---

## โ๏ธ ุงููุดุงูู ุงููุญุชููุฉ

### 1. **ุนุฏู ุชุทุงุจู ูุธุงู ุงูุญูููุฉ**
- โ ุฃูุงูุฑ ุงูุจูุน: ูุธุงู ูุจุณุท (company_id ููุท)
- โ ุงูููุงุชูุฑ: ูุธุงู ููุญุฏ (branch_id, cost_center_id, warehouse_id)

**ุงูุชุฃุซูุฑ**: 
- ูุฏ ูุฑู ุงูููุธู ุฃูุฑ ุจูุน ููู ูุง ูุฑู ุงููุงุชูุฑุฉ ุงููุฑุชุจุทุฉ
- ูุฏ ูุฑู ุงููุญุงุณุจ ูุงุชูุฑุฉ ููู ูุง ูุฑู ุฃูุฑ ุงูุจูุน ุงูุฃุตูู

### 2. **ููุชุฑ ุงูููุธููู ูู ุงูููุงุชูุฑ**
- โ๏ธ ูุนุชูุฏ ุนูู `sales_order_id` ู `created_by_user_id`
- โ ุงูููุงุชูุฑ ุงูููุดุฃุฉ ูุจุงุดุฑุฉ (ุจุฏูู ุฃูุฑ ุจูุน) ูุง ุชุธูุฑ ูู ุงูููุชุฑ

**ุงูุชุฃุซูุฑ**:
- ููุชุฑ ุงูููุธููู ูุง ูุนูู ููููุงุชูุฑ ุงููุจุงุดุฑุฉ

### 3. **ุงูุฃุฏูุงุฑ ุงููุฎุชูุทุฉ**
- โ๏ธ `accountant` ูุฑู ุฌููุน ุงูููุงุชูุฑ ููู ุฃูุงูุฑู ููุท
- โ๏ธ `viewer` ูุฑู ุฌููุน ุงูููุงุชูุฑ ููู ุฃูุงูุฑู ููุท

**ุงูุชุฃุซูุฑ**:
- ุนุฏู ุชูุงุณู ูู ุชุฌุฑุจุฉ ุงููุณุชุฎุฏู

---

## โ ุงูุชูุตูุงุช

### 1. **ุชูุญูุฏ ูุธุงู ุงูุญูููุฉ**
```typescript
// ุชุทุจูู ููุณ ูุธุงู ุงูุญูููุฉ ุนูู ุฃูุงูุฑ ุงูุจูุน
const visibilityRules = buildDataVisibilityFilter(context);
let ordersQuery = supabase
  .from("sales_orders")
  .select("*")
  .eq("company_id", visibilityRules.companyId);

ordersQuery = applyDataVisibilityFilter(ordersQuery, visibilityRules, "sales_orders");
```

### 2. **ุฅุถุงูุฉ `created_by_user_id` ููููุงุชูุฑ**
```typescript
// ุนูุฏ ุฅูุดุงุก ูุงุชูุฑุฉ ูุจุงุดุฑุฉ
const invPayload = {
  created_by_user_id: user.id, // ุฅุถุงูุฉ ูุนุฑู ุงูููุดุฆ
  // ... ุจุงูู ุงูุจูุงูุงุช
};
```

### 3. **ุชุญุณูู ููุชุฑ ุงูููุธููู**
```typescript
// ุฏุนู ุงูููุงุชูุฑ ุงููุจุงุดุฑุฉ
if (filterEmployeeId !== "all") {
  // ููุชุฑุฉ ุญุณุจ created_by_user_id ููููุงุชูุฑ ุงููุจุงุดุฑุฉ
  // ุฃู ุญุณุจ sales_order.created_by_user_id ููููุงุชูุฑ ุงููุฑุชุจุทุฉ
}
```

### 4. **ุชูุญูุฏ ุงูุตูุงุญูุงุช**
```typescript
// ุฌุนู accountant ู viewer ูุฑูุงู ุฌููุน ุงูุฃูุงูุฑ ุฃูุถุงู
const canViewAllOrders = ["owner", "admin", "manager", "accountant", "viewer"].includes(role);
```

---

## ๐ ุงูุฎูุงุตุฉ

### โ ูุง ูุนูู ุจุดูู ุตุญูุญ:
1. โ ุฃูุงูุฑ ุงูุจูุน ุชุธูุฑ ุฌููุนูุง (60 ุฃูุฑ)
2. โ ุงูููุงุชูุฑ ุชุณุชุฎุฏู ูุธุงู ุญูููุฉ ููุญุฏ
3. โ ุงูุฑุจุท ุจูู ุฃูุงูุฑ ุงูุจูุน ูุงูููุงุชูุฑ ูุนูู
4. โ ููุชุฑ ุงูููุธููู ูุนูู ูููุฏูุฑูู

### โ๏ธ ูุง ูุญุชุงุฌ ุชุญุณูู:
1. โ๏ธ ุชูุญูุฏ ูุธุงู ุงูุญูููุฉ ุจูู ุฃูุงูุฑ ุงูุจูุน ูุงูููุงุชูุฑ
2. โ๏ธ ุฅุถุงูุฉ `created_by_user_id` ููููุงุชูุฑ ุงููุจุงุดุฑุฉ
3. โ๏ธ ุชุญุณูู ููุชุฑ ุงูููุธููู ููููุงุชูุฑ ุงููุจุงุดุฑุฉ
4. โ๏ธ ุชูุญูุฏ ุตูุงุญูุงุช ุงูุฃุฏูุงุฑ (accountant, viewer)

### ๐ฏ ุงูุฃููููุงุช:
1. **ุนุงููุฉ**: ุชูุญูุฏ ูุธุงู ุงูุญูููุฉ (ูุถูุงู ุงูุชูุงุณู)
2. **ูุชูุณุทุฉ**: ุฅุถุงูุฉ `created_by_user_id` ููููุงุชูุฑ
3. **ููุฎูุถุฉ**: ุชุญุณูู ููุชุฑ ุงูููุธููู

---

**ุชุงุฑูุฎ ุงููุฑุงุฌุนุฉ**: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')
**ุงูุญุงูุฉ**: โ ุงููุธุงู ูุนูู - ูุญุชุงุฌ ุชุญุณููุงุช ููุชูุงุณู
