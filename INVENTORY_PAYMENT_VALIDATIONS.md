# ๐ ุถูุงุจุท ุงููุฎุฒูู ูุงูุฏูุน - ุชูุฑูุฑ ุดุงูู

## ๐ ุงูุชุงุฑูุฎ: 2025-12-21

---

## ๐ **ููุฎุต ุงูุชุนุฏููุงุช:**

ุชู ุชุทุจูู ุซูุงุซุฉ ุถูุงุจุท ุฃุณุงุณูุฉ ูุถูุงู ุณูุงูุฉ ุงูุจูุงูุงุช ุงููุญุงุณุจูุฉ ูุงููุฎุฒููุฉ:

### **1๏ธโฃ ููุน ูุฑุชุฌุน ุงูุดุฑุงุก ุนูุฏ ุนุฏู ููุงูุฉ ุงููุฎุฒูู** โ
### **2๏ธโฃ ููุน ุชุญููู ูุงุชูุฑุฉ ุงูุจูุน ุฅูู "ูุฑุณูุฉ" ุนูุฏ ุนุฏู ููุงูุฉ ุงููุฎุฒูู** โ
### **3๏ธโฃ ููุน ุงูุฏูุน ุนูุฏ ุนุฏู ููุงูุฉ ุงูุฑุตูุฏ ุงูุจููู/ุงูุฎุฒูุฉ** โ

---

## ๐ฏ **ุงูุชูุงุตูู:**

### **1๏ธโฃ ููุน ูุฑุชุฌุน ุงูุดุฑุงุก ุนูุฏ ุนุฏู ููุงูุฉ ุงููุฎุฒูู**

**ุงูููู:** `app/bills/[id]/page.tsx`

**ุงููุดููุฉ:**
- ูุงู ุงููุธุงู ูุณูุญ ุจูุฑุชุฌุน ุจุถุงุนุฉ ููููุฑุฏ ุญุชู ูู ูู ุชูู ุงูุจุถุงุนุฉ ูุชููุฑุฉ ูู ุงููุฎุฒูู
- ูุฐุง ูุคุฏู ุฅูู ุฃุฑุตุฏุฉ ูุฎุฒูู ุณุงูุจุฉ ูุฃุฎุทุงุก ูุญุงุณุจูุฉ

**ุงูุญู:**
```typescript
// ๐ ุงูุชุญูู ูู ุชููุฑ ุงููุฎุฒูู ูุจู ุงููุฑุชุฌุน
// ูุฑุชุฌุน ุงูุดุฑุงุก ูุนูู ุฅุฑุฌุงุน ุงูุจุถุงุนุฉ ููููุฑุฏุ ูุฐุง ูุฌุจ ุฃู ุชููู ุงูุจุถุงุนุฉ ูุชููุฑุฉ ูู ุงููุฎุฒูู
const itemsToCheck = returnItems
  .filter(it => it.return_qty > 0 && it.product_id)
  .map(it => ({
    product_id: it.product_id!,
    quantity: it.return_qty
  }))

if (itemsToCheck.length > 0) {
  const inventoryCheck = await checkInventoryAvailability(supabase, itemsToCheck)
  if (!inventoryCheck.success) {
    const shortageContent = getShortageToastContent(inventoryCheck.shortages, appLang)
    toast({
      title: shortageContent.title,
      description: shortageContent.description,
      variant: "destructive"
    })
    setReturnProcessing(false)
    return
  }
}
```

**ุงููุชูุฌุฉ:**
- โ ูุง ูููู ุฅุฑุฌุงุน ุจุถุงุนุฉ ุบูุฑ ููุฌูุฏุฉ ูู ุงููุฎุฒูู
- โ ุฑุณุงูุฉ ูุงุถุญุฉ ูููุณุชุฎุฏู ุชูุถุญ ุงูููุต ูู ุงููุฎุฒูู
- โ ุญูุงูุฉ ูู ุงูุฃุฑุตุฏุฉ ุงูุณุงูุจุฉ

---

### **2๏ธโฃ ููุน ุชุญููู ูุงุชูุฑุฉ ุงูุจูุน ุฅูู "ูุฑุณูุฉ" ุนูุฏ ุนุฏู ููุงูุฉ ุงููุฎุฒูู**

**ุงูููู:** `app/invoices/[id]/page.tsx`

**ุงูุญุงูุฉ:** โ **ููุทุจู ูุณุจูุงู**

**ุงูููุฏ ุงูููุฌูุฏ:**
```typescript
// ุงูุชุญูู ูู ุงููุฎุฒูู ูุจู ุงูุฅุฑุณุงู (ุงุณุชุฎุฏุงู ุงูุฎุฏูุฉ ุงููุดุชุฑูุฉ)
if (newStatus === "sent") {
  // ุฌูุจ ุนูุงุตุฑ ุงููุงุชูุฑุฉ ููุชุญูู
  const { data: invoiceItems } = await supabase
    .from("invoice_items")
    .select("product_id, quantity")
    .eq("invoice_id", invoiceId)

  const itemsToCheck = (invoiceItems || []).map((item: any) => ({
    product_id: item.product_id,
    quantity: Number(item.quantity || 0)
  }))

  const { success, shortages } = await checkInventoryAvailability(supabase, itemsToCheck)

  if (!success) {
    const { title, description } = getShortageToastContent(shortages, appLang as 'en' | 'ar')
    toast({
      variant: "destructive",
      title,
      description,
      duration: 8000,
    })
    return
  }
}
```

**ุงููุชูุฌุฉ:**
- โ ูุง ูููู ุชุญููู ูุงุชูุฑุฉ ุจูุน ุฅูู "ูุฑุณูุฉ" ุฅุฐุง ูุงู ุงููุฎุฒูู ูุง ูููู
- โ ุฑุณุงูุฉ ูุงุถุญุฉ ุชูุถุญ ุงูููุชุฌุงุช ุงููุงูุตุฉ ูุงููููุงุช ุงููุชุงุญุฉ
- โ ุญูุงูุฉ ูู ุงูุจูุน ุจุฏูู ูุฎุฒูู

---

### **3๏ธโฃ ููุน ุงูุฏูุน ุนูุฏ ุนุฏู ููุงูุฉ ุงูุฑุตูุฏ ุงูุจููู/ุงูุฎุฒูุฉ**

**ุงูููู:** `app/payments/page.tsx`

**ุงููุจุฏุฃ:**
- โ **ุงููุฏููุนุงุช ุงูุฎุงุฑุฌุฉ** (ููููุฑุฏููุ ูุตุฑููุงุช): ูุฌุจ ุงูุชุญูู ูู ุงูุฑุตูุฏ
- โ **ุงูููุจูุถุงุช ุงูุฏุงุฎูุฉ** (ูู ุงูุนููุงุก): ูุง ุญุงุฌุฉ ููุชุญูู (ุงููุงู ูุฏุฎู ููุญุณุงุจ)

**ุงูุชุนุฏููุงุช:**

#### **ุฃ) ุฏูุนุงุช ุงูููุฑุฏูู (ูุฏููุนุงุช ุฎุงุฑุฌุฉ)** โ
```typescript
// ๐ ุงูุชุญูู ูู ููุงูุฉ ุงูุฑุตูุฏ ูุจู ุฅูุดุงุก ุงูุฏูุนุฉ
const balanceCheck = await checkAccountBalance(
  newSuppPayment.account_id || null,
  newSuppPayment.amount,
  newSuppPayment.date
)

if (!balanceCheck.sufficient) {
  toast({
    title: appLang === 'en' ? 'Insufficient Balance' : 'ุฑุตูุฏ ุบูุฑ ูุงูู',
    description: `ุฑุตูุฏ ุงูุญุณุงุจ "${balanceCheck.accountName}" ุบูุฑ ูุงูู...`,
    variant: 'destructive'
  })
  return
}
```

#### **ุจ) ุฏูุนุงุช ุงูุนููุงุก (ููุจูุถุงุช ุฏุงุฎูุฉ)** โ
```typescript
// โ ุฏูุนุงุช ุงูุนููุงุก ูู ููุจูุถุงุช (ูุฏุฎูุงุช) - ูุง ูุญุชุงุฌ ููุชุญูู ูู ุงูุฑุตูุฏ
// ุงููุงู ูุฏุฎู ููุญุณุงุจุ ูุฐุง ูุง ููุฌุฏ ูุดููุฉ ูู ุงูุฑุตูุฏ
```

#### **ุฌ) ุชุทุจูู ุฏูุนุฉ ุนูู ูุงุชูุฑุฉ ุดุฑุงุก (ูุฏููุนุงุช ุฎุงุฑุฌุฉ)** โ
```typescript
// ๐ ุงูุชุญูู ูู ููุงูุฉ ุงูุฑุตูุฏ ูุจู ุชุทุจูู ุงูุฏูุนุฉ
const balanceCheck = await checkAccountBalance(
  paymentAccountId,
  amount,
  selectedPayment.payment_date
)
```

#### **ุฏ) ุชุทุจูู ุฏูุนุฉ ุนูู ูุงุชูุฑุฉ ุจูุน (ููุจูุถุงุช ุฏุงุฎูุฉ)** โ
```typescript
// โ ุชุทุจูู ุฏูุนุฉ ุนูู ูุงุชูุฑุฉ ุจูุน = ููุจูุถุงุช (ูุฏุฎูุงุช) - ูุง ูุญุชุงุฌ ููุชุญูู ูู ุงูุฑุตูุฏ
// ุงููุงู ูุฏุฎู ููุญุณุงุจ ูู ุงูุนููู
```

**ุชุญุณูู ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก:**
```typescript
} catch (error) {
  console.error("Error checking account balance:", error)
  // ๐ ูู ุญุงูุฉ ุงูุฎุทุฃุ ูููุน ุงูุฏูุน ููุญูุงูุฉ ูู ุงูุฃุฎุทุงุก ุงููุญุงุณุจูุฉ
  // ุฅุฐุง ูู ูุชููู ูู ุงูุชุญูู ูู ุงูุฑุตูุฏุ ูู ุงูุฃูุถู ููุน ุงูุนูููุฉ
  return { sufficient: false, currentBalance: 0 }
}
```

**ุงููุชูุฌุฉ:**
- โ ูุง ูููู ุฏูุน ููููุฑุฏูู ุฅุฐุง ูุงู ุงูุฑุตูุฏ ูุง ูููู
- โ ูุง ูููู ุชุทุจูู ุฏูุนุฉ ุนูู ูุงุชูุฑุฉ ุดุฑุงุก ุฅุฐุง ูุงู ุงูุฑุตูุฏ ูุง ูููู
- โ ุฑุณุงูุฉ ูุงุถุญุฉ ุชูุถุญ ุงูุฑุตูุฏ ุงูุญุงูู ูุงููุจูุบ ุงููุทููุจ
- โ ุญูุงูุฉ ูู ุงูุณุญุจ ุนูู ุงูููุดูู
- โ ุฏูุนุงุช ุงูุนููุงุก ุชุนูู ุจุดูู ุทุจูุนู (ูุฃููุง ููุจูุถุงุช)

---

## ๐ **ุงููููุงุช ุงูููุนุฏูุฉ:**

1. โ `app/bills/[id]/page.tsx` - ุฅุถุงูุฉ ุงูุชุญูู ูู ุงููุฎุฒูู ูุจู ูุฑุชุฌุน ุงูุดุฑุงุก
2. โ `app/invoices/[id]/page.tsx` - ุงูุชุญูู ููุฌูุฏ ูุณุจูุงู โ
3. โ `app/payments/page.tsx` - ุชุญุณูู ุงูุชุญูู ูู ุงูุฑุตูุฏ ูููุฏููุนุงุช ุงูุฎุงุฑุฌุฉ ููุท

---

## ๐งช **ุงูุงุฎุชุจุงุฑุงุช:**

### **ุงูุงุฎุชุจุงุฑุงุช ุงูุญุฑุฌุฉ:**
```bash
npm test -- tests/critical
```

**ุงููุชูุฌุฉ:** โ 32 ุงุฎุชุจุงุฑ ูุฌุญ

---

## ๐ฏ **ุงูููุงุฆุฏ:**

1. โ **ุญูุงูุฉ ุงููุฎุฒูู:** ูุง ูููู ุงูุจูุน ุฃู ุงููุฑุชุฌุน ุจุฏูู ูุฎุฒูู ูุงูู
2. โ **ุญูุงูุฉ ุงูุฑุตูุฏ:** ูุง ูููู ุงูุฏูุน ุจุฏูู ุฑุตูุฏ ูุงูู
3. โ **ุฏูุฉ ูุญุงุณุจูุฉ:** ููุน ุงูุฃุฑุตุฏุฉ ุงูุณุงูุจุฉ ูุงูุณุญุจ ุนูู ุงูููุดูู
4. โ **ุชุฌุฑุจุฉ ูุณุชุฎุฏู ุฃูุถู:** ุฑุณุงุฆู ูุงุถุญุฉ ูููุตูุฉ ุนู ุงูุฃุฎุทุงุก
5. โ **ูุธุงู ูุชูุงูู:** ุฌููุน ุงูุถูุงุจุท ุชุนูู ูุนุงู ูุถูุงู ุณูุงูุฉ ุงูุจูุงูุงุช

---

## ๐ **ุงูุฎูุงุตุฉ:**

ุชู ุชุทุจูู ุฌููุน ุงูุถูุงุจุท ุงููุทููุจุฉ ุจูุฌุงุญ. ุงููุธุงู ุงูุขู ูุญูู ูู:
- โ ุงูุจูุน ุจุฏูู ูุฎุฒูู
- โ ูุฑุชุฌุน ุจุถุงุนุฉ ุบูุฑ ููุฌูุฏุฉ
- โ ุงูุฏูุน ุจุฏูู ุฑุตูุฏ ูุงูู
- โ ุงูุฃุฑุตุฏุฉ ุงูุณุงูุจุฉ
- โ ุงูุณุญุจ ุนูู ุงูููุดูู

**๐ ุงููุดุฑูุน ุงูุขู ูุชูุงูู ุจุฏูู ุฃุฎุทุงุก ูุญุงุณุจูุฉ!**

