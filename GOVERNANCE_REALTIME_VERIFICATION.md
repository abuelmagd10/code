# โ ุฏููู ุงูุชุญูู ูู ูุธุงู Realtime ููุญูููุฉ

## ๐ ูุธุฑุฉ ุนุงูุฉ

ูุฐุง ุงููุณุชูุฏ ููุถุญ ููููุฉ ุงูุชุญูู ูู ุนูู ูุธุงู Realtime ููุญูููุฉ ุจุดูู ุตุญูุญ.

## ๐ ุฎุทูุงุช ุงูุชุญูู

### 1. ุงูุชุญูู ูู ุชูุนูู Realtime ุนูู ุงูุฌุฏุงูู

#### ูู Supabase Dashboard

1. ุงุฐูุจ ุฅูู **Database โ Replication**
2. ุชุญูู ูู ุชูุนูู Realtime ุนูู ุงูุฌุฏุงูู ุงูุชุงููุฉ:
   - โ `company_members`
   - โ `branches`
   - โ `warehouses`
   - โ `company_role_permissions`
   - โ `permissions`

#### ูู SQL Editor

```sql
-- ุงูุชุญูู ูู ุงูุฌุฏุงูู ุงูููุนูุฉ
SELECT 
  schemaname,
  tablename,
  'โ Enabled' as realtime_status
FROM pg_publication_tables 
WHERE pubname = 'supabase_realtime' 
  AND schemaname = 'public'
  AND tablename IN (
    'company_members',
    'branches',
    'warehouses',
    'company_role_permissions',
    'permissions'
  )
ORDER BY tablename;
```

**ุงููุชูุฌุฉ ุงููุชููุนุฉ**: ูุฌุจ ุฃู ุชุธูุฑ ุฌููุน ุงูุฌุฏุงูู ูุน `โ Enabled`.

### 2. ุงูุชุญูู ูู RLS Policies

```sql
-- ุงูุชุญูู ูู ูุฌูุฏ RLS Policies
SELECT 
  tablename,
  COUNT(*) as policy_count
FROM pg_policies
WHERE schemaname = 'public'
  AND tablename IN (
    'company_members',
    'branches',
    'warehouses',
    'company_role_permissions',
    'permissions'
  )
GROUP BY tablename
ORDER BY tablename;
```

**ุงููุชูุฌุฉ ุงููุชููุนุฉ**: ูู ุฌุฏูู ูุฌุจ ุฃู ูููู ูุฏูู ุนูู ุงูุฃูู policy ูุงุญุฏุฉ.

### 3. ุงุฎุชุจุงุฑ ุชุบููุฑ ุงูุฏูุฑ

#### ุงูุณููุงุฑูู

1. **ุงููุณุชุฎุฏู A**: ุชุณุฌูู ุฏุฎูู ูู `employee`
2. **ุงููุณุชุฎุฏู B** (Admin): ุชุบููุฑ ุฏูุฑ ุงููุณุชุฎุฏู A ุฅูู `manager`
3. **ุงููุชูุฌุฉ ุงููุชููุนุฉ**:
   - โ ุธููุฑ Toast: "ุชู ุชุญุฏูุซ ุตูุงุญูุงุชู"
   - โ ุฅุนุงุฏุฉ ุชุญููู ุงูุตูุงุญูุงุช ุชููุงุฆูุงู
   - โ ุชุญุฏูุซ ุงููุงุฌูุฉ (Sidebar, ุงูููุงุฆู)
   - โ ุฅุนุงุฏุฉ ุจูุงุก ุงูุงุดุชุฑุงูุงุช

#### ุงูููุฏ ููุงุฎุชุจุงุฑ

```typescript
// ูู Supabase Dashboard ุฃู ูู API
UPDATE company_members
SET role = 'manager'
WHERE user_id = 'user-a-id'
  AND company_id = 'company-id';
```

### 4. ุงุฎุชุจุงุฑ ุชุบููุฑ ุงููุฑุน

#### ุงูุณููุงุฑูู

1. **ุงููุณุชุฎุฏู A**: ุชุณุฌูู ุฏุฎูู ูู ูุฑุน `branch-1`
2. **ุงููุณุชุฎุฏู B** (Admin): ุชุบููุฑ ูุฑุน ุงููุณุชุฎุฏู A ุฅูู `branch-2`
3. **ุงููุชูุฌุฉ ุงููุชููุนุฉ**:
   - โ ุธููุฑ Toast: "ุชู ุชุญุฏูุซ ุชุนูููู"
   - โ ุฅุนุงุฏุฉ ุชุญููู UserContext
   - โ ุชุญุฏูุซ ุงูุจูุงูุงุช ุงููุนุฑูุถุฉ
   - โ ุฅุนุงุฏุฉ ุจูุงุก ุงูุงุดุชุฑุงูุงุช ุจููุงุชุฑ ุฌุฏูุฏุฉ

#### ุงูููุฏ ููุงุฎุชุจุงุฑ

```typescript
UPDATE company_members
SET branch_id = 'branch-2-id'
WHERE user_id = 'user-a-id'
  AND company_id = 'company-id';
```

### 5. ุงุฎุชุจุงุฑ ุชุบููุฑ ุตูุงุญูุงุช ุงูุฏูุฑ

#### ุงูุณููุงุฑูู

1. **ุงููุณุชุฎุฏู A**: ุชุณุฌูู ุฏุฎูู ูู `employee`
2. **ุงููุณุชุฎุฏู B** (Admin): ุฅุถุงูุฉ ุตูุงุญูุฉ `invoices:delete` ูุฏูุฑ `employee`
3. **ุงููุชูุฌุฉ ุงููุชููุนุฉ**:
   - โ ุธููุฑ Toast: "ุชู ุชุญุฏูุซ ุตูุงุญูุงุช ุงูุฏูุฑ"
   - โ ุฅุนุงุฏุฉ ุชุญููู ุงูุตูุงุญูุงุช
   - โ ุชูุนูู ุฃุฒุฑุงุฑ ุงูุญุฐู ูู ุตูุญุฉ ุงูููุงุชูุฑ

#### ุงูููุฏ ููุงุฎุชุจุงุฑ

```typescript
INSERT INTO company_role_permissions (
  company_id,
  role,
  resource,
  can_delete
) VALUES (
  'company-id',
  'employee',
  'invoices',
  true
);
```

### 6. ุงุฎุชุจุงุฑ ุฅุบูุงู ุงูุตูุญุงุช ุบูุฑ ุงููุตุฑุญ ุจูุง

#### ุงูุณููุงุฑูู

1. **ุงููุณุชุฎุฏู A**: ูุชุญ ุตูุญุฉ `/invoices` (ูุตุฑุญ ูู)
2. **ุงููุณุชุฎุฏู B** (Admin): ุณุญุจ ุตูุงุญูุฉ `invoices` ูู ุฏูุฑ `employee`
3. **ุงููุชูุฌุฉ ุงููุชููุนุฉ**:
   - โ ุธููุฑ Toast: "ุชู ุชุญุฏูุซ ุตูุงุญูุงุช ุงูุฏูุฑ"
   - โ ุฅุนุงุฏุฉ ุชูุฌูู ุงููุณุชุฎุฏู A ุฅูู `/dashboard`
   - โ ุฅุฎูุงุก ุฑุงุจุท `/invoices` ูู Sidebar

### 7. ุงุฎุชุจุงุฑ ููุน ุงุณุชูุจุงู ุฃุญุฏุงุซ ูู ุดุฑูุฉ ุฃุฎุฑู

#### ุงูุณููุงุฑูู

1. **ุงููุณุชุฎุฏู A**: ุชุณุฌูู ุฏุฎูู ูู ุดุฑูุฉ `company-1`
2. **ุงููุณุชุฎุฏู B**: ุชุบููุฑ ุฏูุฑ ูุณุชุฎุฏู ูู ุดุฑูุฉ `company-2`
3. **ุงููุชูุฌุฉ ุงููุชููุนุฉ**:
   - โ ูุง ูุชู ุงุณุชูุจุงู ุงูุญุฏุซ
   - โ ูุง ุชุญุฏูุซ ูู ุงููุงุฌูุฉ
   - โ ูุง ุฑุณุงุฆู Toast

#### ุงูููุฏ ููุงุฎุชุจุงุฑ

```typescript
// ูู Console
// ูุญุงููุฉ ุฅุฑุณุงู ุญุฏุซ ูู ุดุฑูุฉ ุฃุฎุฑู
// ูุฌุจ ุฃู ูุชู ุฑูุถู ูู shouldProcessEvent
```

### 8. ุงุฎุชุจุงุฑ ุฅุนุงุฏุฉ ุจูุงุก ุงูุงุดุชุฑุงูุงุช

#### ุงูุณููุงุฑูู

1. **ุงููุณุชุฎุฏู A**: ุชุณุฌูู ุฏุฎูู ูู ูุฑุน `branch-1`
2. **ุงูุงุดุชุฑุงูุงุช**: ูุดุทุฉ ุนูู `sales_orders` ูุน ููุชุฑ `branch_id=branch-1`
3. **ุงููุณุชุฎุฏู B** (Admin): ุชุบููุฑ ูุฑุน ุงููุณุชุฎุฏู A ุฅูู `branch-2`
4. **ุงููุชูุฌุฉ ุงููุชููุนุฉ**:
   - โ ุฅูุบุงุก ุฌููุน ุงูุงุดุชุฑุงูุงุช ุงูุญุงููุฉ
   - โ ุฅุนุงุฏุฉ ุจูุงุก ุงูุณูุงู
   - โ ุฅุนุงุฏุฉ ุงูุงุดุชุฑุงู ูู `sales_orders` ูุน ููุชุฑ `branch_id=branch-2`

## ๐งช ุงุฎุชุจุงุฑุงุช ุชููุงุฆูุฉ

### ุงุฎุชุจุงุฑ 1: Governance Channel Subscription

```typescript
// ูู Console
const manager = getRealtimeManager()
await manager.initialize()

// ุงูุชุญูู ูู ุงูุงุดุชุฑุงู ูู Governance Channel
// ูุฌุจ ุฃู ูููู isGovernanceSubscribed = true
```

### ุงุฎุชุจุงุฑ 2: Event Handling

```typescript
// ุชุณุฌูู ูุนุงูุฌ
const handler = (event) => {
  console.log('Governance event:', event)
}

const unsubscribe = manager.onGovernanceChange(handler)

// ุชุญุฏูุซ ุฏูุฑ ูุณุชุฎุฏู
// ูุฌุจ ุฃู ูุชู ุงุณุชุฏุนุงุก handler
```

### ุงุฎุชุจุงุฑ 3: Context Rebuild

```typescript
// ูุจู ุงูุชุบููุฑ
const contextBefore = manager.getContext()
console.log('Context before:', contextBefore)

// ุชุบููุฑ ุงูุฏูุฑ
// ...

// ุจุนุฏ ุงูุชุบููุฑ (ูุฌุจ ุฃู ูุชู ุชููุงุฆูุงู)
const contextAfter = manager.getContext()
console.log('Context after:', contextAfter)

// ูุฌุจ ุฃู ูููู contextAfter.role ูุฎุชููุงู
```

## ๐ ูุงุฆูุฉ ุงูุชุญูู

- [ ] Realtime ููุนู ุนูู ุฌููุน ุฌุฏุงูู ุงูุญูููุฉ
- [ ] RLS Policies ููุนูุฉ
- [ ] Governance Channel ูุนูู
- [ ] ุชุบููุฑ ุงูุฏูุฑ ูุนูู
- [ ] ุชุบููุฑ ุงููุฑุน ูุนูู
- [ ] ุชุบููุฑ ุงููุฎุฒู ูุนูู
- [ ] ุชุบููุฑ ุงูุตูุงุญูุงุช ูุนูู
- [ ] ุฅุบูุงู ุงูุตูุญุงุช ุบูุฑ ุงููุตุฑุญ ุจูุง ูุนูู
- [ ] ููุน ุงุณุชูุจุงู ุฃุญุฏุงุซ ูู ุดุฑูุฉ ุฃุฎุฑู ูุนูู
- [ ] ุฅุนุงุฏุฉ ุจูุงุก ุงูุงุดุชุฑุงูุงุช ุชุนูู
- [ ] ุฑุณุงุฆู Toast ุชุธูุฑ ุจุดูู ุตุญูุญ
- [ ] ูุง ููุฌุฏ Refresh ูุทููุจ
- [ ] ูุง ููุฌุฏ Logout ูุทููุจ

## ๐ ุงุณุชูุดุงู ุงูุฃุฎุทุงุก

### ุงููุดููุฉ: ูุง ูุชู ุงุณุชูุจุงู ุงูุฃุญุฏุงุซ

**ุงูุชุญูู**:
1. Realtime ููุนู ุนูู ุงูุฌุฏููุ
2. Governance Channel ูุดุชุฑูุ
3. ุงูููุชุฑ ุตุญูุญุ
4. RLS Policies ุชุณูุญ ุจุงููุฑุงุกุฉุ

### ุงููุดููุฉ: ุงูุฃุญุฏุงุซ ูุง ุชุคุซุฑ ุนูู ุงููุงุฌูุฉ

**ุงูุชุญูู**:
1. `affectsCurrentUser` ุตุญูุญุ
2. ุงููุนุงูุฌุงุช ูุณุฌูุฉุ
3. `onPermissionsChanged` ูุณุชุฏุนูุ
4. `refreshPermissions` ูุนููุ

### ุงููุดููุฉ: ุงูุตูุญุงุช ูุง ุชูุบูู ุชููุงุฆูุงู

**ุงูุชุญูู**:
1. `canAccessPage` ูุนููุ
2. Router redirect ูุนููุ
3. `useGovernanceRealtime` ูุณุชุฎุฏูุ

## ๐ ุงููุฑุงุฌุน

- `GOVERNANCE_REALTIME_SYSTEM.md` - ุงููุธุงู ุงูุนุงู
- `GOVERNANCE_REALTIME_SECURITY_RULES.md` - ููุงุนุฏ ุงูุฃูุงู
- `lib/realtime-manager.ts` - Realtime Manager
- `hooks/use-governance-realtime.ts` - Governance Hook
