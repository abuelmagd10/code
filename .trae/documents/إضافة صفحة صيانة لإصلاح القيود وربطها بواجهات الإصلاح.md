## الهدف
- توفير أدوات إدارية لإصلاح قيود الفواتير والمخزون والشحن من واجهة رسومية.
- ربط الواجهة بواجهات الإصلاح الموجودة لضمان عكس القيود الخاطئة وتنظيف الحركات.

## ما هو موجود الآن
- واجهة إصلاح الفاتورة تعكس قيود الدفع/الفاتورة/تكلفة المبيعات وتعدّل المخزون: `app/api/repair-invoice/route.ts:45–331`.
- واجهة إصلاح قيود الشحن توازن الاعتمادات غير متعلقة بالضريبة وتضيف/تقلّص سطور الشحن: `app/api/repair-shipping-journals/route.ts:53–369`.
- بنية Supabase SSR والاعتمادات مستخدمة في الخادم والعميل: `lib/supabase/server.ts:4–21`, `lib/supabase/client.ts:1–37`, `lib/supabase/hooks.ts:5–7`.

## التغييرات المقترحة
1) إضافة صفحة "الصيانة" تحت الإعدادات
- مسار: `app/settings/maintenance/page.tsx`.
- قسم "إصلاح الفاتورة": حقل رقم الفاتورة + خيار حذف معاملات البيع الأصلية، زر تنفيذ يستدعي `POST /api/repair-invoice` ويعرض ملخص النتيجة.
- قسم "إصلاح قيود الشحن": زر تشغيل شامل مع خيار `debug` يعرض تفاصيل التعديلات لكل قيد، يستدعي `POST /api/repair-shipping-journals` مع وسيط `company_id=default`.
- عرض النتائج في بطاقات/جدول باستخدام مكوّنات موجودة في `components/ui/*` للحفاظ على النسق العربي.

2) ربط أدوات الإصلاح داخل صفحة الفاتورة
- زر "إصلاح قيود هذه الفاتورة" في `app/invoices/[id]/page.tsx` بجانب أزرار الطباعة والتعديل.
- يستخرج `invoice.invoice_number` ويرسل الطلب إلى `/api/repair-invoice`، ويظهر إشعار بالنجاح/الفشل.

3) حماية الوصول وتحسين إدارة الجلسة
- إضافة وسيط عام يحافظ على جلسة Supabase ويعيد التوجيه لصفحة الدخول إن لم تكن هناك جلسة: إنشاء `middleware.ts` في الجذر يستدعي `updateSession` من `lib/supabase/middleware.ts:6–72`.
- تقييد صفحة "الصيانة" لتتطلب جلسة (اعتماداً على إعادة التوجيه الحالية في `app/page.tsx:5–14` ومع الوسيط).

## تفاصيل التنفيذ
- استخدام `fetch('/api/repair-invoice', { method: 'POST', body: JSON.stringify({ invoice_number, delete_original_sales }) })`، ثم قراءة `summary` الحقول: `reversed_payment_entries`, `reversed_invoice_entries`, `reversed_cogs_entries`, `sale_reversal_transactions`, `updated_products`, `deleted_original_sales` من `app/api/repair-invoice/route.ts:71–79, 318`.
- لإصلاح الشحن: `fetch('/api/repair-shipping-journals?company_id=default&debug=1', { method: 'POST' })` وقراءة الحقول: `scanned_entries`, `fixed_entries`, `skipped_already_balanced` مع `details` عند `debug` من `app/api/repair-shipping-journals/route.ts:148–157, 356–357`.
- إعادة استخدام `useToast` و `toastActionSuccess/toastActionError` لرسائل الحالة كما في `app/settings/page.tsx:83–104`.
- الالتزام باللغة العربية والاتجاه RTL الموجود في `app/layout.tsx:41–50`.

## التحقق
- تشغيل التطبيق محلياً ثم:
- تجربة إصلاح فاتورة موجودة برقم محدد؛ التأكد من إنشاء قيود عكسية في جداول `journal_entries` و`journal_entry_lines` وعودة المخزون (`inventory_transactions` و`products.quantity_on_hand`).
- تجربة إصلاح الشحن ومراجعة أن الاعتمادات غير الضريبية أصبحت مساوية للذمم بعد خصم الضريبة، مع تفاصيل `debug` للتحقق.
- مراجعة إعادة التوجيه للمستخدم غير المسجل من أي صفحة محمية.

## ملاحظات أمان وسلامة البيانات
- جميع عمليات الإصلاح تُنفّذ بإدخالات جديدة idempotent وتتجنب التكرار عبر الفلاتر الموضحة في الواجهات.
- لا يتم تخزين مفاتيح/أسرار في الشيفرة؛ الاعتماد على `NEXT_PUBLIC_SUPABASE_*` البيئة كما هو قائم.

هل تريدني تنفيذ هذه الخطة الآن؟