## الهدف
تجعل كل حركة مخزون (إضافة/خصم/عكس/تعديل) مرتبطة بقيد يومي واحد وواضح، مع منع التكرار ودعم الحذف/التعديل/الإضافة بصورة متسقة.

## مراجعة حالية
- المبيعات: عند الحالة "مرسلة" يتم ترحيل COGS وحركات "sale"؛ وعند "مسودة/ملغاة" تتم حركات "sale_reversal" وقيد عكسي.
- الإصلاح: تم جعل قيود العكس Idempotent لكن لا يوجد ربط صريح بين الحركة والقيد.

## خطة تقنية
### 1) تحديث مخطط قاعدة البيانات
- إضافة عمود `journal_entry_id UUID NULL` في `inventory_transactions` مع FK إلى `journal_entries(id)`.
- فهرس مركّب لتحسين المطابقة: `idx_inventory_tx_doc` على `(transaction_type, reference_id, journal_entry_id)`.
- قيد فريد لمنع التكرار الاختياري: `UNIQUE (journal_entry_id, product_id, transaction_type)` عندما يكون `journal_entry_id` موجوداً.
- سكربت SQL للتعديل + فهارس.

### 2) ترحيل المبيعات
- في `postCOGSJournalAndInventory`:
  - إنشاء القيد أولاً (`invoice_cogs`) ثم تمرير `entry.id` إلى حركات المخزون (`journal_entry_id = entry.id`).
  - التحقق قبل الإدراج: إذا وجدت حركة بنفس `(journal_entry_id, product_id, transaction_type)` لا تُدرج ثانية.

### 3) عكس المبيعات
- في `reverseInventoryForInvoice`:
  - إنشاء القيد `invoice_cogs_reversal` ثم ربط حركات `sale_reversal` به.
  - منع التكرار عبر فحص وجود حركة مرتبطة بنفس `journal_entry_id`.

### 4) ترحيل/عكس المشتريات
- في `postBillJournalAndInventory` و`reverseBillInventory`:
  - نفس الأسلوب: ربط `purchase`/`purchase_reversal` بالقيد الموافق.

### 5) تعديلات الفاتورة بعد الإرسال
- حساب الفرق بين عناصر الفاتورة قبل/بعد:
  - إنشاء قيد تعديل `invoice_cogs_adjustment` وربط حركات مخزون `sale_adjustment` بالفرق.
  - منع التكرار عبر فحص وجود قيد/حركة تعديل لنفس الفاتورة في نفس التاريخ.

### 6) أداة الإصلاح
- تحديث `app/api/repair-invoice/route.ts`:
  - عند إنشاء قيود العكس، البحث عن القيد الأصلي وربط `reference_id` للقيد العكسي، ثم إنشاء/ربط حركات المخزون بالعكسي عبر `journal_entry_id`.
  - تنظيف التكرارات: حذف الحركات غير المرتبطة بأي قيد (`journal_entry_id IS NULL`) عندما تتوفر بدائل مرتبطة.

### 7) واجهة المستخدم
- صفحة المخزون `app/inventory/page.tsx`:
  - عرض عمود جديد "القيد المرتبط" مع رابط يفتح القيد.
  - ترشيح حسب القيد/العملية.
- صفحة قيود اليومية:
  - شارة بعد كل قيد تعرض عدد الحركات المرتبطة.

### 8) اختبارات واعتمادية
- سيناريوهات:
  - إرسال فاتورة، تعديل كمية، إلغاء، إعادة إرسال.
  - إرسال/إلغاء فاتورة مورد.
- تحقق:
  - عدد الحركات = مجموع فروقات العناصر، والكميات النهائية صحيحة.
  - لكل قيد مرتبط يوجد حركات مطابقة؛ لا توجد مزدوجات.

## معايير القبول
- كل حركة مخزون لها قيد يومي مرتبط أو سبب واضح لكونها مستقلة.
- لا يتكرر إدراج حركات أو قيود عند الضغط المتكرر.
- الحذف/الإلغاء يعكس المخزون والقيود بصورة متسقة.

هل توافق على تنفيذ هذه الخطة (تعديل المخطط + تحديث منطق الترحيل/العكس + تحسين الواجهة والاختبارات)؟