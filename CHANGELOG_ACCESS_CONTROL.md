# ุณุฌู ุงูุชุบููุฑุงุช - ุฅุตูุงุญ ุงูุชุญูู ุจุงููุตูู

## ุงูุชุงุฑูุฎ: 2026-01-05

### ุงููุดููุฉ ุงูุฃุตููุฉ
```
GET .../rest/v1/suppliers?...&created_by_user_id=eq.xxx&branch_id=eq.xxx 400 (Bad Request)
```

ุนูุฏ ูุญุงููุฉ ุฌูุจ ุงูููุฑุฏูู ุฃู ุงูุนููุงุกุ ูุงู ุงููุธุงู ูุญุงูู ุชุทุจูู ููุงุชุฑ ุงูุชุญูู ุจุงููุตูู ุนูู ุญููู ุบูุฑ ููุฌูุฏุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช.

### ุงูุณุจุจ ุงูุฌุฐุฑู
- ุฌุฏุงูู `suppliers` ู `customers` ูู ุชุญุชูู ุนูู ุญููู ุงูุชุญูู ุจุงููุตูู ุงููุทููุจุฉ
- ุงูููุฏ ูู `app/api/suppliers/route.ts` ู `app/api/customers/route.ts` ูุงู ูุญุงูู ุงุณุชุฎุฏุงู ูุฐู ุงูุญููู
- ูุธุงู ุงูุชุญูู ุจุงููุตูู ูู `lib/role-based-access.ts` ูุชุทูุจ ูุฐู ุงูุญููู

### ุงูุญู ุงููุทุจู

#### 1. ุฅุถุงูุฉ ุญููู ูุงุนุฏุฉ ุงูุจูุงูุงุช
ุชู ุฅุถุงูุฉ ุงูุญููู ุงูุชุงููุฉ ูุฌุฏููู `suppliers` ู `customers`:
- โ `created_by_user_id` - UUID - ุงููุณุชุฎุฏู ุงูุฐู ุฃูุดุฃ ุงูุณุฌู
- โ `branch_id` - UUID - ุงููุฑุน ุงููุฑุชุจุท
- โ `cost_center_id` - UUID - ูุฑูุฒ ุงูุชูููุฉ ุงููุฑุชุจุท
- โ `warehouse_id` - UUID - ุงููุณุชูุฏุน ุงููุฑุชุจุท

#### 2. ุฅุถุงูุฉ Indexes
ุชู ุฅูุดุงุก indexes ุนูู ุฌููุน ุงูุญููู ุงูุฌุฏูุฏุฉ ูุชุญุณูู ุฃุฏุงุก ุงูุงุณุชุนูุงูุงุช:
- `idx_suppliers_created_by`
- `idx_suppliers_branch`
- `idx_suppliers_cost_center`
- `idx_suppliers_warehouse`
- `idx_customers_created_by`
- `idx_customers_branch`
- `idx_customers_cost_center`
- `idx_customers_warehouse`

#### 3. ุงููููุงุช ุงููุถุงูุฉ
- `scripts/130_add_suppliers_access_control.sql` - Migration ููููุฑุฏูู
- `scripts/131_add_customers_access_control.sql` - Migration ููุนููุงุก
- `scripts/132_combined_access_control.sql` - Migration ูุฌูุน (ููุตู ุจู)
- `scripts/ACCESS_CONTROL_FIX_README.md` - ุฏููู ุงูุชุทุจูู
- `apply-access-control-fix.ps1` - ุณูุฑูุจุช PowerShell ููุชุทุจูู ุงูุชููุงุฆู

### ุงูุชุญูู ูู ุงูุชุทุจูู
ุชู ุงูุชุญูู ูู ูุฌูุฏ ุฌููุน ุงูุญููู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช:

```sql
-- suppliers
โ created_by_user_id (uuid)
โ branch_id (uuid)
โ cost_center_id (uuid)
โ warehouse_id (uuid)

-- customers
โ created_by_user_id (uuid)
โ branch_id (uuid)
โ cost_center_id (uuid)
โ warehouse_id (uuid)
```

### ุงูุชุฃุซูุฑ ุนูู ุงููุธุงู

#### ูุจู ุงูุฅุตูุงุญ
- โ ุฎุทุฃ 400 ุนูุฏ ุฌูุจ ุงูููุฑุฏูู/ุงูุนููุงุก
- โ ุนุฏู ุงููุฏุฑุฉ ุนูู ุชุทุจูู ููุงุชุฑ ุงูุชุญูู ุจุงููุตูู
- โ ุงูููุธููู ูุฑูู ุฌููุน ุงูููุฑุฏูู/ุงูุนููุงุก ุจุฏูู ุชุตููุฉ

#### ุจุนุฏ ุงูุฅุตูุงุญ
- โ ุฌูุจ ุงูููุฑุฏูู/ุงูุนููุงุก ูุนูู ุจุดูู ุตุญูุญ
- โ ุชุทุจูู ููุงุชุฑ ุงูุชุญูู ุจุงููุตูู ุญุณุจ ุงูุฏูุฑ
- โ ุงูููุธููู ูุฑูู ููุท ุงูููุฑุฏูู/ุงูุนููุงุก ุงูุฎุงุตูู ุจูู
- โ ุงููุฏุฑุงุก ูุฑูู ููุฑุฏูู/ุนููุงุก ุงููุฑุน
- โ ุงูููุงู ูุงูุฅุฏุงุฑููู ูุฑูู ุฌููุน ุงูููุฑุฏูู/ุงูุนููุงุก

### ููุงุญุธุงุช ูููุฉ

1. **ุงูููุฑุฏูู/ุงูุนููุงุก ุงูุญุงูููู**: ุฌููุน ุงูุณุฌูุงุช ุงูููุฌูุฏุฉ ุณูููู ูุฏููุง `NULL` ูู ุงูุญููู ุงูุฌุฏูุฏุฉ
2. **ุงูุณุฌูุงุช ุงูุฌุฏูุฏุฉ**: ุณูุชู ุชุนููู ุงูููู ุชููุงุฆูุงู ุนูุฏ ุงูุฅูุดุงุก
3. **ุงูุชูุงูู ุงูุนูุณู**: ุงููุธุงู ูุนูู ูุน ุงูุณุฌูุงุช ุงููุฏููุฉ (NULL values)

### ุฎุทูุงุช ุฅุถุงููุฉ (ุงุฎุชูุงุฑูุฉ)

ุฅุฐุง ููุช ุชุฑูุฏ ุชุนููู ููู ุงูุชุฑุงุถูุฉ ููุณุฌูุงุช ุงูุญุงููุฉ:

```sql
-- ุชุนููู ุงูููุดุฆ ูุฌููุน ุงูููุฑุฏูู ุงูุญุงูููู = ูุงูู ุงูุดุฑูุฉ
UPDATE suppliers s
SET created_by_user_id = c.user_id
FROM companies c
WHERE s.company_id = c.id
AND s.created_by_user_id IS NULL;

-- ุชุนููู ุงูููุดุฆ ูุฌููุน ุงูุนููุงุก ุงูุญุงูููู = ูุงูู ุงูุดุฑูุฉ
UPDATE customers cu
SET created_by_user_id = co.user_id
FROM companies co
WHERE cu.company_id = co.id
AND cu.created_by_user_id IS NULL;
```

### ุงูููุฏ ุงููุชุฃุซุฑ

#### API Routes
- `app/api/suppliers/route.ts` - ูุณุชุฎุฏู `created_by_user_id` ููููุชุฑุฉ
- `app/api/customers/route.ts` - ูุณุชุฎุฏู `created_by_user_id` ููููุชุฑุฉ

#### Components
- `app/suppliers/page.tsx` - ูุณุชุฏุนู API ุงูููุฑุฏูู
- `app/customers/page.tsx` - ูุณุชุฏุนู API ุงูุนููุงุก

#### Libraries
- `lib/role-based-access.ts` - ูุทุจู ููุงุชุฑ ุงูุชุญูู ุจุงููุตูู

### ุงูุงุฎุชุจุงุฑ
- โ ุชู ุชุทุจูู Migration ุนูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
- โ ุชู ุงูุชุญูู ูู ูุฌูุฏ ุฌููุน ุงูุญููู
- โ ุชู ุงูุชุญูู ูู ูุฌูุฏ ุฌููุน Indexes
- ๐ ูุฌุจ ุงุฎุชุจุงุฑ ุตูุญุฉ ุงูููุฑุฏูู ูู ุงููุชุตูุญ
- ๐ ูุฌุจ ุงุฎุชุจุงุฑ ุตูุญุฉ ุงูุนููุงุก ูู ุงููุชุตูุญ
- ๐ ูุฌุจ ุงุฎุชุจุงุฑ ุฅูุดุงุก ููุฑุฏ/ุนููู ุฌุฏูุฏ
- ๐ ูุฌุจ ุงุฎุชุจุงุฑ ุงูููุชุฑุฉ ุญุณุจ ุงูุฏูุฑ

### Commits
1. `feat: add access control fields to suppliers and customers tables`
2. `docs: add combined SQL migration and README for access control fix`

